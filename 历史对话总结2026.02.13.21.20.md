# 大盘鸡项目历史对话总结（截至 2026-02-13）

## 1. 目标与场景
- 你有芬兰母鸡（PVE）开小鸡，对外卖给客户使用。
- 小鸡没有独立公网 IP，使用母鸡公网 IP + 端口映射。
- 业务要求：客户从日本 IP 入口访问；小鸡主动外连（如 TG Bot）继续走母鸡默认出口，不做全局代理。

## 2. 架构结论
- 最终方向不是“客户端全局 VPN”，而是“日本入口网关 + 芬兰母鸡二次分发”。
- 核心链路：
  1. 客户端 -> 日本机公网端口
  2. 日本机通过 WG 隧道转发到芬兰母鸡
  3. 芬兰母鸡按端口段 DNAT 到对应小鸡内网 IP
- 动态化要求：
  - 每开一台小鸡（默认 50 连续端口）自动加映射
  - 删小鸡自动删映射，防止“幽灵端口占用”

## 3. 已确认关键信息
- 日本机公网 IP：`151.242.164.130`
- 芬兰母鸡公网 IP：`135.181.162.231`
- 芬兰母鸡内网网段：`10.10.10.0/24`
- 芬兰母鸡内网网桥：`vmbr1`
- 小鸡示例内网：`10.10.10.10`、`10.10.10.11`

## 4. 运行中遇到的问题与结论
- 问题 1：日本中转到小鸡 SSH 偶发卡顿/超时。
  - 现象：登录后部分命令会卡住，直连母鸡端口时更稳定。
  - 结论：链路存在稳定性问题，需继续按路径分段定位（本地 -> 日本机 -> 芬兰母鸡 -> 小鸡）。
- 问题 2：端口池管理冲突风险。
  - 你明确要求：`10000-20000` 给售卖小鸡使用，不要占用模板机。
  - 后续动作：模板机应迁移到保留端口（如你要求的 `9900`）并检查冲突。
- 问题 3：自动化闭环。
  - 你的 bot 已能产出 `VM_READY`（包含 `vmid`、`lan`、`port_start`），具备自动调用脚本的前提。

## 5. 安全与运维注意
- 聊天里出现过一次性 root 密码，视为已泄露，应立即轮换。
- bot 到服务器建议仅使用 SSH 密钥，不使用密码登录。
- 不建议在核心母鸡长期跑不明测试脚本；可在临时 VM 测试后销毁。

## 6. 当前工作重点
- 把“创建 VM -> 自动加映射”与“删除 VM -> 自动清理映射”彻底打通。
- 模板机端口迁移到保留区（不占用售卖区）。
- 排查日本中转链路的 SSH 卡顿根因，并形成稳定连接参数/方案。

## 7. 你后续可直接复用的沟通口径
- 业务模型：日本入口统一暴露，芬兰母鸡负责端口分发，小鸡主动流量直出母鸡。
- 规则策略：日本机范围规则一次性配置；母鸡按 VM 动态增删端口映射。
- 运维原则：端口池有台账、删除必回收、测试尽量在临时 VM。

