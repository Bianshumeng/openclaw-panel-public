# 会话纪要（日记）

记录时间：2026-02-18 17:55:20  
记录范围：本轮关于 Bot 交付、模板机网络、SSH 隧道与 Gateway 鉴权的排查与决策

## 1. 背景
- 交付目标从“公网直连 URL 直接访问”调整为“优先 SSH 隧道访问”，降低公网暴露风险。
- 用户关注点集中在三块：
  - VM_READY 输出是否可直接操作。
  - 模板机与新开小机行为差异。
  - 长期稳定连接方式（不希望隧道自动掉线）。

## 2. 关键时间线（摘要）
1. Bot 端完成 VM_READY 输出增强：新增 SSH 隧道命令与本地访问地址字段，相关代码已提交并推送。
2. 新开小机出现 `gateway token missing` 等提示，经排查确认并非“模板无 token”，而是浏览器侧未带 token。
3. 模板机升级 `openclaw-panel:0.1.2` 初次失败，定位到模板机公网出站不通（DNS/443 超时）。
4. 对比 VM100 与 VM101 后确认关键差异：VM100 网卡配置含 `firewall=1`，VM101 无该标记。
5. 回滚 VM100 网卡 `firewall=1` 后，模板机 DNS 与 443 出站恢复，镜像拉取成功，panel 升级到 `0.1.2`。
6. SSH 隧道长连需求明确：单次 `ssh -N` 不满足长期在线，后续按“心跳 + 自动重连 + 密钥登录”推进。

## 3. 当前已确认状态
- 模板机 `openclaw-panel` 运行版本：`ghcr.io/bianshumeng/openclaw-panel:0.1.2`。
- 模板机公网出站：已恢复（DNS 可解析，TCP 443 可连）。
- 公网直连策略：日本中转链路已搁置，持续使用“母机公网 IP + 端口”。
- 隧道接入策略：默认推荐 SSH 隧道；密码登录仅临时可用，长期方案应切换为密钥登录。

## 4. 争议点结论
- “是不是网页鉴权改坏了网络”：
  - 结论：网页鉴权不是直接根因。
  - 根因链路：网络策略收紧 + 模板机网卡特殊配置叠加，导致该机器出站异常。
- “为什么第一次能拉镜像，后来不行”：
  - 结论：首次拉取发生在网络收紧前；后续链路变化后触发问题。

## 5. 下一步开发入口
- 目标：把“SSH 密钥下发 + 隧道长连”变成标准交付能力，减少人工操作与掉线影响。
- 待执行事项：
  - 定义密钥交付模型（安全边界、存储边界、回收机制）。
  - Bot 回包增加跨平台密钥接入指令模板。
  - 连接文案统一为“先建隧道、后访问本地地址”的单一路径。
