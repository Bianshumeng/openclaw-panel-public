# 任务清单

## 1. 准备阶段
- [x] 1.1 阅读现有规格与相关实现（Telegram 页面 + onboarding 命令链） | 验收：完成复现路径和根因证据记录
- [x] 1.2 确认本次任务边界与风险级别 | 验收：确认为 L1 可回滚局部修复

## 2. 实现阶段
- [x] 2.1 改造 Docker CLI 调用为可回退入口 | 验收：`openclaw` 缺失时自动切到 `node /app/openclaw.mjs`
- [x] 2.2 Telegram setup 流程复用已解析 CLI 入口 | 验收：三步执行不重复触发入口探测失败
- [x] 2.3 Telegram Bot Token 输入框改为默认明文可见 | 验收：`/channels/telegram` 首步输入框显示为文本输入
- [x] 2.4 更新/新增单测覆盖回退链路 | 验收：存在失败->回退->成功的断言

## 3. 验证阶段
- [x] 3.1 单测通过 | 验收：`node --test test/unit/channel-onboarding.test.js` 通过
- [x] 3.2 Docker 手工回放通过 | 验收：`runOpenClawCli` 在真实容器中自动回退到 `node /app/openclaw.mjs` 并成功执行 `plugins list`

## 4. 收尾阶段
- [x] 4.1 更新任务文档勾选状态与经验记录 | 验收：清单与实际一致
- [x] 4.2 规格变更与任务汇报同步 | 验收：文档可追溯本次行为变化

## 经验记录
### 步骤 1.1 / 1.2 完成记录
- 实际情况：已定位根因为 `src/channel-onboarding.js` 在 Docker 模式写死 `openclaw` 可执行入口，与当前 `ghcr.io/openclaw/openclaw:2026.2.14` 容器不一致。
- 证据：容器内 `which openclaw` 为空；`node /app/openclaw.mjs plugins enable telegram` 可执行成功。
- 技术债：CLI 入口兼容策略此前未抽象，导致镜像实现变更后直接故障。

### 步骤 2.1 ~ 2.4 完成记录
- 实际情况：已在 `runOpenClawCli` 增加 Docker CLI 入口回退机制（`openclaw` -> `node /app/openclaw.mjs`），并在 setup 三步内复用成功入口，避免重复失败。
- 实际情况补充：回退检测覆盖 `stdout/stderr/message`，兼容 OCI 报错被写入 `stdout` 的场景。
- 实际情况补充：Telegram Bot Token 输入框已改为默认明文可见（新页面与兼容旧入口同步）。
- 技术债：当前回退策略固定两种入口；若后续镜像入口再变化，建议在 panel 配置层增加显式 CLI 入口可配置项。

### 步骤 3.1 / 3.2 完成记录
- 自动化验证：`node --test test/unit/channel-onboarding.test.js` 通过（5/5）。
- Docker 手工验证：在真实容器执行 `runOpenClawCli(..., ['plugins','list'])`，已自动回退并成功，命令显示为 `docker exec openclaw-gateway node /app/openclaw.mjs plugins list`。
- 风险说明：尚未在重建后的 panel 容器上做端到端页面点击回放，本轮以单测 + 真实容器命令链路验证替代。
