# 技术设计

## 背景与约束
- 现状：9 个页面通过 `section[data-panel]` 共存于 `public/index.html`，并由 `public/app.js` 同时初始化。
- 约束：
  - 保持 Fastify + 原生 HTML/CSS/JS 架构，不引入新框架。
  - 路由路径保持兼容：`/dashboard`、`/model` 等用户入口不变。
  - 生产环境为 Linux Docker，开发在 Windows Docker；必须维持可迁移性。
  - 所有对外地址/端口遵守“母机 IP + 分配端口”约束，不引入硬编码端口。

## 目标
- 把“单页 9 分区”改为“9 个独立页面文件 + 共享壳层 + 按页脚本”。
- 保持用户视角功能一致，优先提升可维护性与回归可控性。
- 先完成两页试点（Dashboard、Model），作为后续 7 页模板。

## 不做（Non-Goals）
- 不做视觉大改版。
- 不做 API 协议变更。
- 不做 OpenClaw 核心逻辑改造。

## 目标架构
### 1) 页面文件层
- `public/pages/dashboard.html`
- `public/pages/model.html`
- 后续扩展：skills/chat-console/config-generator/channels/update/service/logs。

### 2) 共享壳层层
- 共享侧栏、页头、全局消息区、主题切换逻辑。
- 共享路由映射：`public/app-routes.js` 继续作为唯一真相来源。

### 3) 前端脚本层
- `public/js/core/*`：API 请求、公共工具、全局状态。
- `public/js/pages/dashboard.js`：仪表盘页面逻辑。
- `public/js/pages/model.js`：模型与提供商页面逻辑。
- 后续页面按同样模式继续拆。

### 4) 服务端路由层
- `src/server.js` 对“已知页面路由”返回对应 HTML；未知前端路由回退默认页（兼容旧入口）。

## 拆分策略
### 阶段 A：两页试点（本轮）
- 将 `/dashboard` 与 `/model` 从 `index.html` 中拆出独立页面。
- 为两页建立独立初始化入口，验证：
  - Dashboard：总览刷新、模型快速切换、状态列表渲染。
  - Model：默认模型切换、模板/自定义提供商配置。
- 试点通过后再复制模式至其余 7 页。

### 阶段 B：其余 7 页批量拆分（后续）
- 每页拆分后立即回归对应功能，不打包“全部拆完再测”。
- 每页完成即提交 checkpoint，保留回滚锚点。

## 决策与取舍
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 页面组织 | 多 HTML 独立页面 | 降低耦合、减少误伤 | 继续单页堆叠 |
| 框架策略 | 保持原生 JS | 与现有栈一致，风险低 | 引入 SPA 框架重写 |
| 迁移方式 | 先两页试点再扩展 | 控风险、可回滚 | 一次性全量拆分 |
| 路由兼容 | 保持 URL 不变 | 用户无感迁移 | 改 URL 并做重定向 |

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| 共享状态丢失导致行为变化 | 提取 core 状态与 API 层，建立页面初始化契约 |
| 侧栏重复维护导致不一致 | 共享侧栏模板/组件，单点维护导航映射 |
| CSS 作用域冲突 | 先保留全局样式，再逐步模块化，不一次性重写 |
| Docker 重建后页面 404 | 路由映射先加回归用例，确保静态文件可达 |

## 迁移/回滚方案
- 迁移步骤：
  1. 文档落盘并确认门禁；
  2. 完成两页拆分 + 自动化 + Docker 验证；
  3. 根据试点结果更新文档；
  4. 批量拆剩余 7 页。
- 回滚步骤：
  1. 回退到试点前 commit；
  2. 保留问题记录并收敛后重做试点；
  3. 未通过前不进入批量拆分。
- 验证方式：
  - 自动化测试 + Docker 运行态 + 手工关键路径回放。