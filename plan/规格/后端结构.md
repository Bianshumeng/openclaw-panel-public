# 后端结构

最后更新：2026-02-16

## 能力概述

定义面板后端在“插件式控制器”模式下的模块边界、接口约束与数据流，保障迁移后长期可维护。

## 关联文档
- `plan/规格/产品需求.md`
- `plan/规格/应用流程.md`
- `plan/规格/技术栈约束.md`
- `plan/规格/OpenClaw面板.md`

## 需求列表

### 需求：分层职责明确
后端必须按“路由层 -> 服务层 -> 适配层 -> 配置/系统层”分层，禁止路由层直写复杂业务。

#### 场景：新增 Chat/Skills 路由
- 当 增加新的 API
- 那么 路由层只负责参数校验与返回封装，业务逻辑必须进入服务层

#### 场景：Gateway 调用
- 当 调用 OpenClaw Gateway RPC
- 那么 必须经过统一适配层，避免调用分散

### 需求：配置写入单一入口
`openclaw.json` 与 `panel.config.json` 的写入必须通过统一模块处理。

#### 场景：模型与提供商写入
- 当 保存默认模型或新增提供商
- 那么 必须通过 `openclaw-config` 统一映射，避免并发覆盖

#### 场景：渠道写入
- 当 保存 Telegram/飞书等渠道配置
- 那么 必须沿用现有字段映射和校验，不得绕过校验层

### 需求：Gateway 适配层标准化
所有 Gateway RPC 调用必须有统一超时、错误码和日志策略。

#### 场景：聊天消息发送
- 当 调用 `chat.send`
- 那么 必须记录请求 ID、sessionKey、runId，并处理超时与重试策略

#### 场景：技能状态读取
- 当 调用 `skills.status`
- 那么 接口失败时必须返回可降级错误，不得抛未处理异常

### 需求：流式事件链路稳定
Chat 流式事件必须通过统一事件通道传输并可重连。

#### 场景：SSE 断线
- 当 浏览器断线重连
- 那么 必须支持恢复监听并避免重复推送已完成消息

#### 场景：最终态丢失
- 当 长时间未收到 `final`
- 那么 服务层必须触发补偿查询（如拉取历史）并结束挂起状态

### 需求：安全与审计
敏感操作必须具备最小审计能力与脱敏日志策略。

#### 场景：技能高风险操作
- 当 执行启停或配置变更
- 那么 必须记录操作时间、目标、结果和操作者标识（若可用）

#### 场景：密钥相关日志
- 当 打印请求或配置变更日志
- 那么 必须脱敏 API Key/Secret，不得输出明文

### 需求：接口契约可版本化
新增接口必须遵循统一返回结构，并保留向后兼容。

#### 场景：新增 `/api/chat/*`、`/api/skills/*`
- 当 接口上线
- 那么 返回结构必须包含 `ok` 与可读 `message`/`error`，并在文档记录版本差异

#### 场景：兼容旧前端
- 当 旧页面仍调用既有接口
- 那么 后端必须保持旧接口行为不变
