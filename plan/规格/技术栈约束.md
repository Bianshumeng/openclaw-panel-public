# 技术栈约束

最后更新：2026-02-16

## 能力概述

定义当前项目在迁移 ClawX 能力时必须遵守的技术栈边界、依赖策略与兼容约束，防止架构漂移。

## 关联文档
- `plan/规格/产品需求.md`
- `plan/规格/后端结构.md`
- `plan/规格/前端规范.md`
- `plan/规格/OpenClaw面板.md`

## 需求列表

### 需求：运行形态固定为 Web + Docker
项目必须保持 Fastify 服务端 + 静态前端 + Docker 部署，不引入 Electron 运行时依赖。

#### 场景：能力迁移
- 当 参考 ClawX 功能实现
- 那么 必须迁移为 Web 可运行形态，不可引入 Electron IPC、BrowserWindow、auto-updater

#### 场景：部署执行
- 当 进入生产部署
- 那么 必须继续支持 `docker compose` 标准流程

#### 场景：开发与生产环境差异
- 当 开发在 Windows Docker、生产在 Linux Docker
- 那么 每个关键能力必须在 Linux 环境完成复验，不得仅以 Windows 验证作为发布依据

### 需求：依赖控制
新增依赖必须可解释且最小化，优先复用现有栈能力。

#### 场景：实时通信
- 当 实现 Chat 流式消息
- 那么 优先复用 SSE；如必须使用 WS，需给出明确收益与回滚方案

#### 场景：状态管理
- 当 前端需要新增状态逻辑
- 那么 优先在现有 `public/app.js` 模块化拆分，不引入重型前端框架

### 需求：接口兼容优先
新增 API 必须与现有 `/api/settings`、`/api/service/*`、`/api/logs/*` 并存，不破坏已上线调用路径。

#### 场景：新增 chat/skills 接口
- 当 扩展后端路由
- 那么 必须保证旧接口返回结构与行为不变

#### 场景：配置写入
- 当 新功能写入 `openclaw.json`
- 那么 必须遵守现有字段映射与校验逻辑，禁止跨面板副作用写入

### 需求：安全基线不降低
新增能力不得降低当前安全边界。

#### 场景：密钥处理
- 当 展示或保存 API Key
- 那么 必须默认脱敏展示，日志中不得打印明文

#### 场景：外网访问
- 当 面板需要公网访问
- 那么 仍必须通过反向代理鉴权，不开放未授权直连

### 需求：单公网IP+端口映射部署约束
系统必须兼容“母机单公网 IP + 小机分配端口”交付方式，所有端口相关能力不得做硬编码假设。

#### 场景：对外入口地址
- 当 生成前端展示地址、Webhook 回调地址
- 那么 必须使用“公网 IP + 端口”形式，不得默认省略端口或假设 80/443，并由 `panel.config.json.reverse_proxy` 字段统一提供

#### 场景：端口配置
- 当 定义服务监听端口与对外暴露端口
- 那么 必须支持 env/配置文件可配置，禁止写死 80/443/3000 等固定端口

#### 场景：容器内部通信
- 当 Docker 容器之间互联
- 那么 必须优先使用内部网络与共享卷，不走公网入口地址

#### 场景：连通性判断
- 当 评估端口映射影响范围
- 那么 只能约束“外部入站访问”；容器内部通信不应受公网端口映射策略影响

### 需求：测试与发布约束
每一批迁移能力必须有可复现验证，且支持快速回滚。

#### 场景：功能发布
- 当 发布 Dashboard/Skills/Chat 新能力
- 那么 必须有对应测试证据与回滚开关

#### 场景：Docker 回归
- 当 容器重建或升级后
- 那么 新能力必须保持可用，旧能力不得回归
