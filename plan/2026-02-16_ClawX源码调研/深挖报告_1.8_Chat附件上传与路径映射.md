# 深挖报告 1.8：Chat 附件上传与路径映射

创建时间：2026-02-16

## 本轮目标

补齐 ClawX 聊天体验中“附件能力”的关键链路，确保 Web 面板场景下可用：

1. 用户可上传/粘贴/拖拽文件；
2. 文件可被安全落盘到 OpenClaw 媒体目录；
3. 聊天发送时可正确映射为网关可访问路径；
4. 在 Docker 双容器路径不同的情况下仍能读到附件。

## 核心实现

### 1) 新增附件落盘接口

- 接口：`POST /api/chat/attachments/stage`
- 文件：`src/server.js`、`src/chat-service.js`
- 行为：
  - 接收 `fileName/mimeType/base64`
  - 落盘到 `<openclawRoot>/media/outbound/`
  - 返回 `stagedPath/fileSize/preview`

### 2) 聊天发送链路增强

- 文件：`src/chat-service.js`
- 行为：
  - 支持 `attachments[]` 入参
  - 对图片附件（png/jpeg/webp/gif/bmp）生成 base64 `attachments` 传给 `chat.send`
  - 对所有附件写入 `[media attached: ...]` 文件引用
  - 增加路径白名单校验：仅允许 `media/outbound` 下的文件参与发送

### 3) 容器路径映射修复（关键）

问题根因：
- 面板容器路径：`/data/openclaw/...`
- 网关容器路径：`/home/node/.openclaw/...`
- 若直接传面板路径，网关会 `ENOENT`。

修复：
- 发送前将本地绝对路径映射为网关根路径（默认 Docker 用 `/home/node/.openclaw`）。
- 新增配置字段：`openclaw.gateway_media_root`（`src/panel-config.js` + `deploy/panel.config.docker.json`）。

### 4) 附件文件权限修复（关键）

问题根因：
- 早期落盘权限过严导致网关读取 `EACCES`。

修复：
- 附件写入权限调整为 `0644`，确保网关容器用户可读。

## 前端交互增强

- 文件：`public/index.html`、`public/app.js`、`public/styles.css`
- 增加：
  - “添加附件”按钮 + 隐藏文件输入
  - 粘贴/拖拽上传
  - 附件列表与移除按钮
  - 图片预览（可用时）
  - 发送时自动携带附件元数据

## 验证结果

1. 自动化：
   - `npm run test:unit` 通过（新增附件相关单测）
   - `npm run test:regression` 通过
2. Docker：
   - `docker compose up -d --build panel` 多次重建通过
3. 运行态：
   - 附件 staging 成功
   - 聊天发送成功
   - 历史消息显示网关路径映射为 `/home/node/.openclaw/...`
   - 网关工具成功读取附件内容并返回 `ok`

证据：
- `evidence/chat-attachments-live.json`
- `evidence/chat-attachments-pathmap-live.json`
- `evidence/chat-attachments-ui-live.md`

## 结论

附件链路已从“无能力”升级为“可用且可验证”的完整闭环。  
下一步应聚焦 `6.8`：消息富渲染（Markdown/工具消息）和局部错误提示，进一步降低小白用户理解成本。
