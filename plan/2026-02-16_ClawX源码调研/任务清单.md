# 任务清单

## 0. 文档与门禁阶段（先做，不跳步）
- [x] 0.1 完成迁移提案、技术设计、任务清单、规格变更落盘 | 验收：`plan/2026-02-16_ClawX源码调研/` 文档齐全
- [x] 0.2 深挖 Gateway RPC 能力矩阵 | 验收：形成可用接口清单（含超时/错误行为）
- [x] 0.3 深挖 Chat 流式事件链路（delta/final/error/aborted） | 验收：形成状态机时序图与异常策略
- [x] 0.4 深挖 Skills 管理边界与权限模型 | 验收：形成“可暴露/需确认/禁止暴露”分类表
- [x] 0.5 深挖 Docker 运行态的稳定性基线（重启、断网、升级后） | 验收：形成稳定性检查报告
- [x] 0.6 建立 Win 开发环境到 Linux 生产环境的一致性门禁清单 | 验收：每个阶段均有 Linux 可用性验证项
- [x] 0.7 建立单公网 IP + 端口映射部署约束清单 | 验收：对外地址/端口配置化、容器内通信策略、Webhook 地址规则全部落盘
- [x] 0.8 完成 ClawX 用户视角功能差异矩阵 | 验收：形成“已对齐/缺失/优先级”清单并落盘

## 1. 后端基础改造阶段（先打地基）
- [x] 1.1 新增 Gateway 适配层模块（统一 RPC 调用、超时、错误归一化） | 验收：接口单测通过，支持统一日志
- [x] 1.2 新增 Dashboard 聚合服务层 | 验收：输出模型/渠道/技能/运行态汇总结构
- [x] 1.3 新增 Skills 服务层 | 验收：支持查询技能状态、启停技能、读取关键配置
- [x] 1.4 新增 Chat 服务层（会话、历史、发送、中止） | 验收：支持会话切换与消息收发
- [x] 1.4.1 前端接入“状态总览 / Skills 管理 / 对话控制台”页面与路由 | 验收：`/status-overview`、`/skills`、`/chat-console` 返回 200 且侧栏可见
- [x] 1.4.2 前端接入 Dashboard/Skills/Chat API 最小可用交互 | 验收：可刷新聚合状态、可启停 Skill、可按会话发送/中止/重置
- [x] 1.5 新增 Chat 流式输出通道（SSE 优先） | 验收：`/api/chat/stream` 连续发送可收到 `delta/final` 且终态可收敛
- [x] 1.6 新增“会话新建”后端接口与会话 key 生成策略 | 验收：前端可无命令行新建会话并立即发送消息

## 2. 仪表盘增强阶段
- [x] 2.1 补齐状态总览卡片（运行状态、模型、渠道、技能、错误摘要、版本） | 验收：字段与后端一致
- [x] 2.2 增加模型快速切换入口（保持上下文风险提示） | 验收：上下文降级时提示准确
- [x] 2.3 增加系统状态模块迁移（从侧栏迁移到仪表盘） | 验收：侧栏不再重复显示同类信息

## 3. 模型与提供商页增强阶段
- [x] 3.1 保持“设置当前默认模型”和“新增提供商”双通道结构 | 验收：两条路径可独立完成配置
- [x] 3.2 强化基础模板与自定义模式切换 | 验收：模板下仅需填 provider/baseUrl/key 即可
- [x] 3.3 对齐默认模型列表与配置生成器模型 ID | 验收：下拉列表一致，保存后配置正确
- [x] 3.4 新增 API 模式下拉与模型联动（GPT/Claude/Gemini） | 验收：URL/API 模式自动切换且可覆写

## 4. 渠道管理阶段
- [x] 4.1 明确并落地“只管理 OpenClaw 真实渠道” | 验收：文档与页面一致，不出现私有虚拟渠道
- [x] 4.2 优化 Telegram/飞书的可视化配置和连通性测试 | 验收：配置保存+测试闭环可复现
- [x] 4.3 兼容 Discord/Slack 的状态展示（若接口可用） | 验收：不可用时优雅降级不报错

## 5. Skills 管理阶段
- [x] 5.1 新增 Skills 列表与状态展示 | 验收：可查看启用状态、基本说明、最后更新时间
- [x] 5.2 新增 Skills 启停与必要确认交互 | 验收：高风险动作有二次确认
- [x] 5.3 新增 Skills 配置入口与回写校验 | 验收：写入失败可回滚并提示根因

## 6. Chat 主页面迁移阶段（用户主入口）
- [x] 6.1 将侧栏入口升级为“智能对话”，替换调试术语 | 验收：小白用户可在 30 秒内理解该页面用途
- [x] 6.2 实现多会话管理（列表/切换/新建） | 验收：切换后历史正确，不串会话
- [x] 6.3 实现流式消息“原位渲染”（消息气泡内增量更新） | 验收：delta 与 final 顺序稳定，消息不重复
- [x] 6.4 实现思考状态展示开关（默认开启显示） | 验收：开关仅影响显示，不影响后端请求
- [x] 6.5 实现中止当前运行（Stop）与发送态收敛 | 验收：中止后输入区恢复可编辑，按钮状态正确
- [x] 6.6 保留高级调试信息为折叠区 | 验收：默认不干扰小白，排障时可展开
- [x] 6.7 实现附件上传（点击/粘贴/拖拽）与发送链路 | 验收：附件可落盘、可随消息发送、网关可读
- [x] 6.8 实现消息富渲染与局部错误提示 | 验收：Markdown/工具消息可读，错误定位不只依赖全局时间线

## 7. 回归验证阶段
- [x] 7.1 自动化测试（单元 + 回归）补齐 | 验收：`npm run test` 通过
- [ ] 7.2 手工回放关键路径 | 验收：模型、渠道、技能、日志、更新、智能对话全链路通过
- [ ] 7.3 Docker 场景稳定性验证 | 验收：重启容器后配置与功能保持一致
- [ ] 7.4 Linux 生产环境回归验证 | 验收：在 Linux 主机上完成同等流程回放并记录差异

## 8. 收尾阶段
- [ ] 8.1 合并规格变更到 `plan/规格/OpenClaw面板.md` | 验收：主规格与实现一致
- [ ] 8.2 归档任务目录到 `plan/归档/` | 验收：归档目录命名与文档完整
- [ ] 8.3 更新 README 的能力说明与运维指引 | 验收：新功能入口与限制写清楚

## 未深挖项任务池（必须在对应阶段前完成）
### A. Chat 深挖
- [ ] A.1 逐项验证 Gateway 聊天协议字段（`runId/sessionKey/state/message`） | 验收：字段字典文档
- [ ] A.2 梳理异常态（超时、断流、final 缺失、重复消息） | 验收：补救策略文档

### B. Skills 深挖
- [ ] B.1 梳理 Skills 数据来源与写回路径 | 验收：接口契约文档
- [ ] B.2 梳理高风险技能动作的防误触策略 | 验收：确认弹窗+审计日志方案

### C. 运维深挖
- [ ] C.1 梳理升级后接口兼容策略 | 验收：版本差异表
- [ ] C.2 梳理日志敏感信息脱敏策略 | 验收：脱敏规则清单
- [ ] C.3 梳理 Windows Docker 与 Linux Docker 的差异清单 | 验收：差异项对应缓解策略
- [x] C.4 梳理“母机公网IP + 分配端口”部署约束对功能实现的影响清单 | 验收：端口与地址相关功能均有防错规则

## 经验记录
### 步骤 0 完成记录
- 实际情况：已完成迁移方向确认，明确“插件式控制器”边界，排除首次向导/任务调度/主题系统。
- 遇到问题：ClawX 依赖 Electron，不能直接平移 IPC 与桌面更新逻辑。
- 技术债：待补全 Gateway RPC 深挖报告后，才能安全进入 Chat/Skills 编码阶段。

### 步骤 0.2 完成记录
- 实际情况：已完成 Gateway RPC 方法实测，`sessions.list/chat.history/chat.send/chat.abort/skills.status/skills.update` 全部 3/3 成功。
- 遇到问题：手写 WS 握手容易踩鉴权细节坑，已切换到 OpenClaw 官方 `callGateway()` 客户端链路作为探测基线。
- 技术债：`skills.update` 对不存在 skillKey 也返回成功，后续 UI/服务层必须补“存在性校验 + 风险提示”。
- 兼容性备注：本轮在 Windows Docker 完成，必须在 Linux 生产环境追加一致性回归。

### 步骤 0.3 完成记录
- 实际情况：已在 Linux 容器内完成 Chat 流式实测，确认 `delta -> final` 和 `aborted` 两条主链路，并输出状态机与异常策略文档。
- 遇到问题：运行态 `chat.state=error` 未能在当前环境稳定复现；已补充 `invalidRequest`（RPC 级错误）分支作为异常兜底路径。
- 技术债：后续 `1.5` 流式通道联调阶段需要继续补抓真实 `chat.state=error` 证据，避免仅依赖源码推断。
- 兼容性备注：本轮探测脚本运行在 Linux 容器（非 Windows 宿主进程）中，协议行为与生产 Linux 更一致。

### 步骤 0.4 完成记录
- 实际情况：已完成 Skills 权限与边界实测，落盘“可暴露/需确认/禁止暴露”分类表。
- 遇到问题：`skills.update` 对不存在 `skillKey` 仍返回成功，且 `skills.bins` 在 operator 角色下不可调用（unauthorized role）。
- 技术债：后续实现阶段必须补“status 列表存在性校验 + 高风险动作二次确认 + 统一错误分级”三件套。
- 兼容性备注：本轮在 Linux 容器直接验证权限行为，结论可直接用于 Linux 生产部署策略。

### 步骤 0.7 / C.4 完成记录
- 实际情况：已将“单公网 IP + 端口映射”约束落盘并落地到代码：外部端口环境变量化、仪表盘新增公网地址/Webhook 基地址展示、内部通信网络显式化。
- 遇到问题：本地当前运行态出现容器跨 compose 网络漂移（`openclawpanel_default` 与 `sub2api_default` 分离），导致内部 DNS 互通不可假设成立。
- 技术债：需在后续 Docker 稳定性基线阶段补“旧网络清理 + 强制同网络重建”回放脚本，避免历史容器残留导致误判。
- 兼容性备注：修复方案按 Linux Docker 路径设计（env + compose + panel.config.json），Windows 开发环境仅作为执行载体。

### 步骤 0.5 完成记录
- 实际情况：已完成“重启/断网/升级后”稳定性回放，输出自动化证据脚本与报告（含恢复次数与耗时）。
- 遇到问题：网关容器 `restart/upgrade` 后，`service/status` 先恢复，但容器内 DNS 链路存在滞后窗口（本次重启约 3 秒，升级回放约 10 秒）。
- 技术债：后续 `1.1/1.4/1.5` 在网关调用链必须内建 10~15 秒重试窗口与“恢复中”状态，避免把短暂恢复窗口误判为故障。
- 兼容性备注：虽然宿主是 Windows，但关键连通性结论来自 Linux 容器内探测（`openclaw-panel -> openclaw-gateway`），可用于 Linux 生产约束设计。

### 步骤 0.6 完成记录
- 实际情况：已建立“阶段门禁 + 发布前最小门禁”清单，明确 1~7 阶段对应的 Linux 验收项。
- 遇到问题：历史上存在“Windows 本地可用但 Linux 生产不可用”的隐性风险点（脚本、网络、权限、地址展示），已纳入门禁。
- 技术债：后续每个阶段执行后都要回写 Linux 验证证据；若跳过会导致门禁失效。
- 兼容性备注：门禁清单与 0.5 稳定性数据联动，已把“网关恢复窗口 10~15 秒重试”固化为默认要求。

### 步骤 1.1 完成记录
- 实际情况：已完成 `src/gateway-client.js` 适配层落地，补齐 URL 解析、重试、错误归一化、`connect.challenge` 握手、device 签名鉴权；并补齐 `test/unit/gateway-client.test.js`。
- 遇到问题：容器实时联调先后触发 `missing scope: operator.read`、`device nonce required`、`unexpected property 'nonce'` 三类握手失败；根因分别是“无 device 时 scope 被网关清空”“未识别 challenge 的 `type=event`”“把 nonce 放进了 connect 顶层字段而非 device 字段”。
- 技术债：后续 `1.4/1.5` 仍需补“网关短时恢复窗口（10~15 秒）”的统一调用重试状态透出，避免 UI 报假故障。
- 兼容性备注：本轮验证覆盖 Linux 容器内真实调用（`openclaw-panel -> openclaw-gateway`），满足 Win 开发 / Linux 运行一致性门禁。

### 步骤 1.2 完成记录
- 实际情况：已新增 `src/dashboard-service.js`，将“模型摘要 + 渠道配置/运行态 + Skills 摘要 + 服务运行态”统一聚合，并在 `src/server.js` 暴露 `GET /api/dashboard/summary`。
- 遇到问题：容器重建后立即请求接口会出现短时 404（路由尚未完成热切换）；等待容器稳定后恢复 200。
- 技术债：前端当前仍主要走 `/api/settings + /api/service/status` 双路读取，后续可在仪表盘增强阶段逐步切到聚合接口，减少前端拼装复杂度。
- 兼容性备注：已完成宿主机与容器内双路径验证（`http://127.0.0.1:18080/api/dashboard/summary` + 容器内 `fetch`），满足 Linux 运行态可用性要求。

### 步骤 1.3 完成记录
- 实际情况：已新增 `src/skills-service.js`，落地 Skills 状态查询、单技能配置读取、启停能力，并在 `src/server.js` 暴露：
  - `GET /api/skills/status`
  - `GET /api/skills/:skillKey/config`
  - `POST /api/skills/:skillKey/enabled`
- 遇到问题：Gateway 原生 `skills.update` 对不存在 skillKey 也可能返回成功，存在误操作风险。
- 技术债：后续 `5.3` 需要追加“API Key/env 编辑回写 + 失败回滚 + 审计日志”完整链路；本轮先完成启停与关键配置读取。
- 兼容性备注：已做无副作用联调（未知 skillKey 启停返回明确错误），并落证据 `evidence/skills-service-live.json`。

### 步骤 1.4 完成记录
- 实际情况：已新增 `src/chat-service.js`，实现会话列表、历史读取、消息发送、中止运行、会话重置；并在 `src/server.js` 暴露：
  - `GET /api/chat/sessions`
  - `GET /api/chat/history`
  - `POST /api/chat/send`
  - `POST /api/chat/abort`
  - `POST /api/chat/session/reset`
- 遇到问题：容器重建后短窗口内会命中旧实例路由，导致新接口短时 404；增加“接口可用性轮询”后验证稳定。
- 技术债：当前 `chat.send` 仅返回 ack（`runId/status=started`），流式增量输出与状态广播留到 `1.5` 统一实现。
- 兼容性备注：已在 Docker 运行态完成真实联调（会话/历史/发送/中止/重置全链路），证据见 `evidence/chat-service-live.json`。

### 步骤 1.4.1 / 1.4.2 完成记录
- 实际情况：已在前端新增侧栏入口与页面面板：`状态总览`、`Skills 管理`、`对话控制台`；并完成 API 绑定：
  - 状态总览：`GET /api/dashboard/summary`
  - Skills：`GET /api/skills/status`、`GET /api/skills/:skillKey/config`、`POST /api/skills/:skillKey/enabled`
  - 对话控制台：`GET /api/chat/sessions`、`GET /api/chat/history`、`POST /api/chat/send`、`POST /api/chat/abort`、`POST /api/chat/session/reset`
- 遇到问题：本地存在历史同名容器（`openclaw-panel` / `openclaw-gateway`）导致 `docker compose up` 冲突，已先清理旧容器再重建。
- 技术债：当前对话控制台仍为“控制层最小实现”，流式增量展示与更细粒度思考态展示留在 `1.5`。
- 兼容性备注：已在 Docker 运行态验证路由与 API 可达（`/status-overview`、`/skills`、`/chat-console` 均返回 200）。

### 步骤 1.5 完成记录
- 实际情况：已新增 `GET /api/chat/stream`（SSE）并接入 Gateway 事件订阅桥；前端 `对话控制台` 已接入实时流展示（`ready/status/chat/agent/terminal/stream-error`）。
- 遇到问题：网关短时断链会导致流中断；已在服务端加入自动重连状态机（`reconnecting/connect-failed/gateway-closed`）并持续输出状态事件。
- 技术债：当前流展示以事件日志和增量文本为主，后续 `6.3/6.4` 可继续做 UI 级“消息气泡内原位增量渲染 + 思考状态分层”。
- 兼容性备注：已完成 Docker 运行态实测，证据见 `evidence/chat-stream-sse-live.json`（终态 `final`，包含 `delta` 事件）。

### 步骤 0.8 完成记录
- 实际情况：已完成 ClawX 用户视角能力盘点，形成“已对齐/缺失/优先级”矩阵报告，确认下一优先级为 Chat 主页面用户化。
- 遇到问题：当前面板 Chat 交互偏调试控制台风格，不符合小白用户操作路径。
- 技术债：仍需补“新建会话”接口与前端聊天消息气泡化渲染，避免继续暴露原始事件流。
- 兼容性备注：本轮仅文档与差异分析，无环境依赖差异风险。

### 步骤 1.6 完成记录
- 实际情况：已新增 `POST /api/chat/session/new`，后端自动按现有会话前缀生成新 `sessionKey` 并调用 `sessions.reset(reason=new)` 创建会话。
- 遇到问题：不同环境的会话 key 前缀可能不一致；已通过“优先复用现有 canonical 前缀，失败回退 `agent:main`”规避。
- 技术债：后续可增加“按用户输入前缀创建会话”能力，目前前端默认自动生成。
- 兼容性备注：已在 Docker 运行态实测通过，证据见 `evidence/chat-session-new-live.json`。

### 步骤 6.1~6.7 完成记录
- 实际情况：`/chat-console` 已从“对话控制台”升级为“智能对话”主聊天页，默认视图包含会话选择、消息区、输入区、停止回复与思考显示开关；高级原始事件信息迁移到折叠区。
- 遇到问题：历史实现依赖原始 SSE 文本输出，直接替换会导致定位问题困难；已保留原始历史/流事件面板作为折叠调试区。
- 技术债：该阶段遗留的“消息富渲染 + 局部错误提示”已在后续 `6.8` 闭环，本条仅保留历史上下文。
- 兼容性备注：已在 Docker 重建后完成“附件落盘 -> 路径映射 -> 真实发送回放”验证，证据见 `evidence/chat-user-workspace-live.md`、`evidence/chat-attachments-live.json`、`evidence/chat-attachments-pathmap-live.json`。

### 步骤 6.8 完成记录
- 实际情况：已完成消息富渲染（`**加粗**`、行内代码、代码块）和工具消息可读化（`[工具调用]` / `[工具结果]`）；并在聊天页新增内联提示区，覆盖发送、刷新、新建会话、停止、重置、附件处理等动作反馈。
- 遇到问题：历史数据中工具事件字段命名不统一（`toolCall/tool_call/toolResult/tool_result`），导致首版渲染漏识别；已在归一化阶段统一兼容。
- 技术债：当前富渲染为轻量 Markdown 子集，后续如需完整 Markdown 语法（表格/引用/任务列表）再评估引入专用渲染器。
- 兼容性备注：已完成 Docker 重建与运行态验证，证据见 `evidence/chat-rich-render-inlinehint-live.md`。

### 步骤 2.1 完成记录
- 实际情况：已在仪表盘补齐总览卡片（运行状态、当前模型、渠道、Skills、错误摘要、版本状态），并迁入“渠道运行态 / Skills 运行态”明细列表与快捷操作入口，用户可从一个页面直达核心操作。
- 遇到问题：版本与错误摘要数据来自不同接口（`/api/update/check`、`/api/logs/errors`），刷新链路容易出现“部分成功”；已在仪表盘刷新按钮中增加并发结果汇总和失败提示。
- 技术债：该阶段发现的“状态页重复入口”问题已在后续 `2.3` 完成收敛，本条仅保留历史上下文。
- 兼容性备注：已完成 Docker 重建和运行态验证，证据见 `evidence/dashboard-overview-enhanced-live.md`。

### 步骤 2.3 完成记录
- 实际情况：已移除侧栏“状态总览”入口与独立页面结构，状态信息统一收敛到“仪表盘”；`/status-overview` 旧路径保留兼容映射，访问后自动落到仪表盘视图。
- 遇到问题：直接删除路由会导致历史收藏链接不可用；已在 `panelByPath` 中增加路径别名映射，避免用户打开旧链接看到空页面。
- 技术债：该阶段遗留的“仪表盘模型快速切换”已在后续 `2.2` 完成，本条仅保留历史上下文。
- 兼容性备注：已在 Docker 运行态验证侧栏与旧路径行为，证据见 `evidence/dashboard-status-migration-live.md`。

### 步骤 2.2 完成记录
- 实际情况：已在仪表盘“模型仪表盘”中新增快速切换入口（上下文输入 + 模型下拉 + 一键切换），无需跳转到“模型与提供商配置”页面即可切换默认模型。
- 遇到问题：仪表盘和模型页都需要“当前会话上下文”输入，若独立维护会出现提示不一致；已改为共享同一 `localStorage` 键并双向同步两个输入框。
- 技术债：当前下拉只展示模型名称，后续可增加“提供商徽标/标签”帮助用户在重名模型场景下更快识别。
- 兼容性备注：已在 Docker 运行态验证“降级上下文提示”触发准确，证据见 `evidence/dashboard-quick-model-switch-live.md`。

### 步骤 3.1 完成记录
- 实际情况：已把模型页明确拆成“双通道”交互，新增提供商（模板/自定义）默认不再改动当前默认模型，仅在用户显式勾选“保存后设为当前默认模型”时才切换。
- 遇到问题：后端 `applySettings()` 会总是写入 `agents.defaults.model.primary`，若前端每次都传“新提供商默认模型 ref”，就会出现“加提供商顺手改默认模型”的隐性副作用；已改为前端根据勾选状态决定传“当前 primary”或“目标 primary”。
- 技术债：3.2/3.4 仍需继续增强“模板/自定义切换 + API 模式联动”的表单引导，降低小白用户填错概率。
- 兼容性备注：已完成 `node --check`、`npm run test:unit`、`npm run test:regression` 以及 `docker compose up -d --build panel` 验证，证据见 `evidence/model-provider-dual-path-3.1-live.md`。

### 步骤 3.2 完成记录
- 实际情况：已新增“路径 2 工作模式”切换入口，默认进入“基础配置（推荐）”；模板模式主区只保留 `provider/baseUrl/apiKey` 等高频字段，低频字段迁入“高级参数（通常不用改）”折叠区；自定义模式默认隐藏，按需切换展示。
- 遇到问题：模板与自定义表单字段共存时，用户容易误把“高级字段”当成必填；已改为模式显式切换 + 折叠高级项，降低认知负担。
- 技术债：`3.3/3.4` 仍需继续细化模型 ID 一致性和 API 模式联动，避免跨模式切换时出现“看起来像一致、实际不一致”的错觉。
- 兼容性备注：已完成 `node --check`、`npm run test:unit`、`npm run test:regression` 与 Docker 重建验证，证据见 `evidence/model-provider-mode-switch-3.2-live.md`。

### 步骤 3.3 完成记录
- 实际情况：已把配置生成器与模板高级参数的模型下拉统一为同源渲染（`DEFAULT_MODEL_OPTIONS`），并移除 `cfg_model_id` 的静态硬编码，避免后续模型更新时出现列表漂移。
- 遇到问题：原实现在 HTML 与 JS 双处维护模型 ID，后续一旦漏改会导致“某页面有模型，另一页面没有”的隐性不一致；已收敛为 `fillDefaultModelOptions()` 单点生成。
- 技术债：`3.4` 仍需补完“模型族 -> API 模式/URL”的联动细则，保证不同模型切换时提供商参数变化可解释。
- 兼容性备注：已完成 DevTools 运行态一致性校验（`cfg_model_id` 与 `template_default_model_id` 一致）及自动化/容器验证，证据见 `evidence/model-id-alignment-3.3-live.md`。

### 步骤 3.4 完成记录
- 实际情况：已在“自定义模式”补齐 API 模式下拉（含 custom）与默认模型下拉（含 custom），并落地 AICodeCat 场景下的联动：模型族切换会同步切换 API 模式、providerId 与 Base URL。
- 遇到问题：自定义模式原本依赖手输 API 模式与默认模型 ID，模型切换后 URL 不会跟随，容易配置错路径；已通过 `syncCustomByModelSelection/syncCustomByApiMode` 消除这类误填。
- 技术债：后续可进一步补“跨非 AICodeCat 提供商的联动策略提示”，避免用户误以为所有提供商都支持自动 URL 推导。
- 兼容性备注：已完成 DevTools 运行态联动验证（Claude/GPT/Gemini 三条链路）以及自动化/容器验证，证据见 `evidence/model-api-linkage-3.4-live.md`。

### 步骤 4.1 完成记录
- 实际情况：已将渠道页显式标注为“仅 OpenClaw 真实渠道”，并在页面文案中写明只会写入 `channels.telegram/feishu/discord/slack`（含飞书兼容 `accounts.main`），不会创建面板私有虚拟渠道。
- 遇到问题：原有文案容易让用户把“保存渠道与全局配置”误解为会改动更多全局行为；已把按钮与成功提示改成“渠道配置”语义并注明“模型保持当前值”。
- 技术债：`4.2` 仍需继续补 Telegram/飞书连通性测试的可回放闭环（成功/失败路径都可快速复现）。
- 兼容性备注：已完成页面关键文案命中检查 + 自动化测试 + Docker 重建验证，证据见 `evidence/channel-scope-4.1-live.md`。

### 步骤 4.2 完成记录
- 实际情况：已新增 Telegram/Feishu 的“保存并测试”一键动作，并新增最近测试结果区（时间 + 成功/失败 + 详情），实现页面内闭环。
- 遇到问题：原链路里“保存配置”会触发配置重载并脱敏清空凭证输入，导致后续测试拿到空值；已修复为“保存前缓存凭证 -> 保存后回填 -> 再测试”。
- 技术债：`4.3` 仍需补 Discord/Slack 的状态展示与降级提示统一化，避免“某渠道失败影响整页认知”。
- 兼容性备注：已通过 DevTools mock 验证两条闭环请求链路（PUT settings -> POST test），并完成自动化与 Docker 验证，证据见 `evidence/channel-save-test-loop-4.2-live.md`。

### 步骤 4.3 完成记录
- 实际情况：已为 Discord/Slack 增加独立“最近测试”状态区，并补齐输入前置校验（Discord Token、Slack 按模式的必填项），测试结果在通道卡片内直接可见。
- 遇到问题：接口异常时原实现只在全局时间线报错，用户难以定位到具体通道；已改为在当前通道结果区同步显示“接口不可用或测试失败”。
- 技术债：后续可考虑补“通道测试历史记录（最近 N 次）”以便跨时段追踪不稳定问题。
- 兼容性备注：已通过 DevTools 验证“缺参失败 + 接口异常降级”两条路径，并完成自动化与 Docker 验证，证据见 `evidence/channel-discord-slack-4.3-live.md`。

### 步骤 5.1 完成记录
- 实际情况：Skills 列表已新增“说明 + 最近更新时间”展示；服务层支持更新时间字段多格式归一化，前端缺失值回退为“无”。
- 遇到问题：网关返回的更新时间字段命名并不稳定；已兼容 `updatedAt/updated_at/lastUpdatedAt/last_updated_at/mtime` 多种命名。
- 技术债：`5.2` 仍需补高风险技能启停二次确认与明确风险文案，防止误触。
- 兼容性备注：已完成 `/skills` 运行态快照验证、单测断言补强、自动化与 Docker 验证，证据见 `evidence/skills-list-status-5.1-live.md`。

### 步骤 5.2 完成记录
- 实际情况：Skills 启停已加入高风险二次确认，禁用已启用技能必须确认；对“受限技能启用”也会提示后再继续。
- 遇到问题：原交互中取消动作没有显式反馈，用户会怀疑是否已提交；已补“已取消 Skill 操作”时间线提示。
- 技术债：`5.3` 仍需补 Skills 配置写回失败时的回滚与根因提示，形成完整闭环。
- 兼容性备注：已通过 DevTools 验证“确认弹窗出现 + 取消后不发请求”链路，并完成自动化与 Docker 验证，证据见 `evidence/skills-toggle-confirm-5.2-live.md`。

### 步骤 5.3 完成记录
- 实际情况：已在 Skills 页新增“配置写回”入口，支持写回 `enabled/apiKey/env`，并新增后端 `PUT /api/skills/:skillKey/config`。
- 遇到问题：仅写盘不做校验会有静默坏配置风险；已落地“写后回读校验 + 失败自动回滚（备份恢复）”闭环。
- 技术债：后续可补“字段级审计日志（谁在何时改了哪些键）”以提升运维可追溯性。
- 兼容性备注：已完成自动化测试、Docker 重建和容器运行态 API 回放；证据见 `evidence/skills-config-writeback-5.3-live.md`。

### 步骤 7.1 完成记录
- 实际情况：已完成语法检查 + 单测 + 回归测试 + 聚合测试命令收口，`npm run test` 全量通过。
- 遇到问题：回归集中有 1 条既有 skip 用例（镜像拉取失败路径），不影响本轮功能有效性结论。
- 技术债：仍需继续推进 `7.2/7.3/7.4` 手工与 Linux 场景回放，自动化通过不等于交付完成。
- 兼容性备注：本轮在 Windows Docker 环境执行，通过结果已落盘；后续 Linux 复验仍按门禁执行。
