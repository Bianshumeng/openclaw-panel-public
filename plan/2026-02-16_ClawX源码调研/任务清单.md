# 任务清单

## 0. 文档与门禁阶段（先做，不跳步）
- [x] 0.1 完成迁移提案、技术设计、任务清单、规格变更落盘 | 验收：`plan/2026-02-16_ClawX源码调研/` 文档齐全
- [x] 0.2 深挖 Gateway RPC 能力矩阵 | 验收：形成可用接口清单（含超时/错误行为）
- [x] 0.3 深挖 Chat 流式事件链路（delta/final/error/aborted） | 验收：形成状态机时序图与异常策略
- [x] 0.4 深挖 Skills 管理边界与权限模型 | 验收：形成“可暴露/需确认/禁止暴露”分类表
- [x] 0.5 深挖 Docker 运行态的稳定性基线（重启、断网、升级后） | 验收：形成稳定性检查报告
- [x] 0.6 建立 Win 开发环境到 Linux 生产环境的一致性门禁清单 | 验收：每个阶段均有 Linux 可用性验证项
- [x] 0.7 建立单公网 IP + 端口映射部署约束清单 | 验收：对外地址/端口配置化、容器内通信策略、Webhook 地址规则全部落盘
- [x] 0.8 完成 ClawX 用户视角功能差异矩阵 | 验收：形成“已对齐/缺失/优先级”清单并落盘

## 1. 后端基础改造阶段（先打地基）
- [x] 1.1 新增 Gateway 适配层模块（统一 RPC 调用、超时、错误归一化） | 验收：接口单测通过，支持统一日志
- [x] 1.2 新增 Dashboard 聚合服务层 | 验收：输出模型/渠道/技能/运行态汇总结构
- [x] 1.3 新增 Skills 服务层 | 验收：支持查询技能状态、启停技能、读取关键配置
- [x] 1.4 新增 Chat 服务层（会话、历史、发送、中止） | 验收：支持会话切换与消息收发
- [x] 1.4.1 前端接入“状态总览 / Skills 管理 / 对话控制台”页面与路由 | 验收：`/status-overview`、`/skills`、`/chat-console` 返回 200 且侧栏可见
- [x] 1.4.2 前端接入 Dashboard/Skills/Chat API 最小可用交互 | 验收：可刷新聚合状态、可启停 Skill、可按会话发送/中止/重置
- [x] 1.5 新增 Chat 流式输出通道（SSE 优先） | 验收：`/api/chat/stream` 连续发送可收到 `delta/final` 且终态可收敛
- [x] 1.6 新增“会话新建”后端接口与会话 key 生成策略 | 验收：前端可无命令行新建会话并立即发送消息

## 2. 仪表盘增强阶段
- [ ] 2.1 补齐状态总览卡片（运行状态、模型、渠道、技能、错误摘要、版本） | 验收：字段与后端一致
- [ ] 2.2 增加模型快速切换入口（保持上下文风险提示） | 验收：上下文降级时提示准确
- [ ] 2.3 增加系统状态模块迁移（从侧栏迁移到仪表盘） | 验收：侧栏不再重复显示同类信息

## 3. 模型与提供商页增强阶段
- [ ] 3.1 保持“设置当前默认模型”和“新增提供商”双通道结构 | 验收：两条路径可独立完成配置
- [ ] 3.2 强化基础模板与自定义模式切换 | 验收：模板下仅需填 provider/baseUrl/key 即可
- [ ] 3.3 对齐默认模型列表与配置生成器模型 ID | 验收：下拉列表一致，保存后配置正确
- [ ] 3.4 新增 API 模式下拉与模型联动（GPT/Claude/Gemini） | 验收：URL/API 模式自动切换且可覆写

## 4. 渠道管理阶段
- [ ] 4.1 明确并落地“只管理 OpenClaw 真实渠道” | 验收：文档与页面一致，不出现私有虚拟渠道
- [ ] 4.2 优化 Telegram/飞书的可视化配置和连通性测试 | 验收：配置保存+测试闭环可复现
- [ ] 4.3 兼容 Discord/Slack 的状态展示（若接口可用） | 验收：不可用时优雅降级不报错

## 5. Skills 管理阶段
- [ ] 5.1 新增 Skills 列表与状态展示 | 验收：可查看启用状态、基本说明、最后更新时间
- [ ] 5.2 新增 Skills 启停与必要确认交互 | 验收：高风险动作有二次确认
- [ ] 5.3 新增 Skills 配置入口与回写校验 | 验收：写入失败可回滚并提示根因

## 6. Chat 主页面迁移阶段（用户主入口）
- [x] 6.1 将侧栏入口升级为“智能对话”，替换调试术语 | 验收：小白用户可在 30 秒内理解该页面用途
- [x] 6.2 实现多会话管理（列表/切换/新建） | 验收：切换后历史正确，不串会话
- [x] 6.3 实现流式消息“原位渲染”（消息气泡内增量更新） | 验收：delta 与 final 顺序稳定，消息不重复
- [x] 6.4 实现思考状态展示开关（默认开启显示） | 验收：开关仅影响显示，不影响后端请求
- [x] 6.5 实现中止当前运行（Stop）与发送态收敛 | 验收：中止后输入区恢复可编辑，按钮状态正确
- [x] 6.6 保留高级调试信息为折叠区 | 验收：默认不干扰小白，排障时可展开
- [x] 6.7 实现附件上传（点击/粘贴/拖拽）与发送链路 | 验收：附件可落盘、可随消息发送、网关可读
- [ ] 6.8 实现消息富渲染与局部错误提示 | 验收：Markdown/工具消息可读，错误定位不只依赖全局时间线

## 7. 回归验证阶段
- [ ] 7.1 自动化测试（单元 + 回归）补齐 | 验收：`npm run test` 通过
- [ ] 7.2 手工回放关键路径 | 验收：模型、渠道、技能、日志、更新、智能对话全链路通过
- [ ] 7.3 Docker 场景稳定性验证 | 验收：重启容器后配置与功能保持一致
- [ ] 7.4 Linux 生产环境回归验证 | 验收：在 Linux 主机上完成同等流程回放并记录差异

## 8. 收尾阶段
- [ ] 8.1 合并规格变更到 `plan/规格/OpenClaw面板.md` | 验收：主规格与实现一致
- [ ] 8.2 归档任务目录到 `plan/归档/` | 验收：归档目录命名与文档完整
- [ ] 8.3 更新 README 的能力说明与运维指引 | 验收：新功能入口与限制写清楚

## 未深挖项任务池（必须在对应阶段前完成）
### A. Chat 深挖
- [ ] A.1 逐项验证 Gateway 聊天协议字段（`runId/sessionKey/state/message`） | 验收：字段字典文档
- [ ] A.2 梳理异常态（超时、断流、final 缺失、重复消息） | 验收：补救策略文档

### B. Skills 深挖
- [ ] B.1 梳理 Skills 数据来源与写回路径 | 验收：接口契约文档
- [ ] B.2 梳理高风险技能动作的防误触策略 | 验收：确认弹窗+审计日志方案

### C. 运维深挖
- [ ] C.1 梳理升级后接口兼容策略 | 验收：版本差异表
- [ ] C.2 梳理日志敏感信息脱敏策略 | 验收：脱敏规则清单
- [ ] C.3 梳理 Windows Docker 与 Linux Docker 的差异清单 | 验收：差异项对应缓解策略
- [x] C.4 梳理“母机公网IP + 分配端口”部署约束对功能实现的影响清单 | 验收：端口与地址相关功能均有防错规则

## 经验记录
### 步骤 0 完成记录
- 实际情况：已完成迁移方向确认，明确“插件式控制器”边界，排除首次向导/任务调度/主题系统。
- 遇到问题：ClawX 依赖 Electron，不能直接平移 IPC 与桌面更新逻辑。
- 技术债：待补全 Gateway RPC 深挖报告后，才能安全进入 Chat/Skills 编码阶段。

### 步骤 0.2 完成记录
- 实际情况：已完成 Gateway RPC 方法实测，`sessions.list/chat.history/chat.send/chat.abort/skills.status/skills.update` 全部 3/3 成功。
- 遇到问题：手写 WS 握手容易踩鉴权细节坑，已切换到 OpenClaw 官方 `callGateway()` 客户端链路作为探测基线。
- 技术债：`skills.update` 对不存在 skillKey 也返回成功，后续 UI/服务层必须补“存在性校验 + 风险提示”。
- 兼容性备注：本轮在 Windows Docker 完成，必须在 Linux 生产环境追加一致性回归。

### 步骤 0.3 完成记录
- 实际情况：已在 Linux 容器内完成 Chat 流式实测，确认 `delta -> final` 和 `aborted` 两条主链路，并输出状态机与异常策略文档。
- 遇到问题：运行态 `chat.state=error` 未能在当前环境稳定复现；已补充 `invalidRequest`（RPC 级错误）分支作为异常兜底路径。
- 技术债：后续 `1.5` 流式通道联调阶段需要继续补抓真实 `chat.state=error` 证据，避免仅依赖源码推断。
- 兼容性备注：本轮探测脚本运行在 Linux 容器（非 Windows 宿主进程）中，协议行为与生产 Linux 更一致。

### 步骤 0.4 完成记录
- 实际情况：已完成 Skills 权限与边界实测，落盘“可暴露/需确认/禁止暴露”分类表。
- 遇到问题：`skills.update` 对不存在 `skillKey` 仍返回成功，且 `skills.bins` 在 operator 角色下不可调用（unauthorized role）。
- 技术债：后续实现阶段必须补“status 列表存在性校验 + 高风险动作二次确认 + 统一错误分级”三件套。
- 兼容性备注：本轮在 Linux 容器直接验证权限行为，结论可直接用于 Linux 生产部署策略。

### 步骤 0.7 / C.4 完成记录
- 实际情况：已将“单公网 IP + 端口映射”约束落盘并落地到代码：外部端口环境变量化、仪表盘新增公网地址/Webhook 基地址展示、内部通信网络显式化。
- 遇到问题：本地当前运行态出现容器跨 compose 网络漂移（`openclawpanel_default` 与 `sub2api_default` 分离），导致内部 DNS 互通不可假设成立。
- 技术债：需在后续 Docker 稳定性基线阶段补“旧网络清理 + 强制同网络重建”回放脚本，避免历史容器残留导致误判。
- 兼容性备注：修复方案按 Linux Docker 路径设计（env + compose + panel.config.json），Windows 开发环境仅作为执行载体。

### 步骤 0.5 完成记录
- 实际情况：已完成“重启/断网/升级后”稳定性回放，输出自动化证据脚本与报告（含恢复次数与耗时）。
- 遇到问题：网关容器 `restart/upgrade` 后，`service/status` 先恢复，但容器内 DNS 链路存在滞后窗口（本次重启约 3 秒，升级回放约 10 秒）。
- 技术债：后续 `1.1/1.4/1.5` 在网关调用链必须内建 10~15 秒重试窗口与“恢复中”状态，避免把短暂恢复窗口误判为故障。
- 兼容性备注：虽然宿主是 Windows，但关键连通性结论来自 Linux 容器内探测（`openclaw-panel -> openclaw-gateway`），可用于 Linux 生产约束设计。

### 步骤 0.6 完成记录
- 实际情况：已建立“阶段门禁 + 发布前最小门禁”清单，明确 1~7 阶段对应的 Linux 验收项。
- 遇到问题：历史上存在“Windows 本地可用但 Linux 生产不可用”的隐性风险点（脚本、网络、权限、地址展示），已纳入门禁。
- 技术债：后续每个阶段执行后都要回写 Linux 验证证据；若跳过会导致门禁失效。
- 兼容性备注：门禁清单与 0.5 稳定性数据联动，已把“网关恢复窗口 10~15 秒重试”固化为默认要求。

### 步骤 1.1 完成记录
- 实际情况：已完成 `src/gateway-client.js` 适配层落地，补齐 URL 解析、重试、错误归一化、`connect.challenge` 握手、device 签名鉴权；并补齐 `test/unit/gateway-client.test.js`。
- 遇到问题：容器实时联调先后触发 `missing scope: operator.read`、`device nonce required`、`unexpected property 'nonce'` 三类握手失败；根因分别是“无 device 时 scope 被网关清空”“未识别 challenge 的 `type=event`”“把 nonce 放进了 connect 顶层字段而非 device 字段”。
- 技术债：后续 `1.4/1.5` 仍需补“网关短时恢复窗口（10~15 秒）”的统一调用重试状态透出，避免 UI 报假故障。
- 兼容性备注：本轮验证覆盖 Linux 容器内真实调用（`openclaw-panel -> openclaw-gateway`），满足 Win 开发 / Linux 运行一致性门禁。

### 步骤 1.2 完成记录
- 实际情况：已新增 `src/dashboard-service.js`，将“模型摘要 + 渠道配置/运行态 + Skills 摘要 + 服务运行态”统一聚合，并在 `src/server.js` 暴露 `GET /api/dashboard/summary`。
- 遇到问题：容器重建后立即请求接口会出现短时 404（路由尚未完成热切换）；等待容器稳定后恢复 200。
- 技术债：前端当前仍主要走 `/api/settings + /api/service/status` 双路读取，后续可在仪表盘增强阶段逐步切到聚合接口，减少前端拼装复杂度。
- 兼容性备注：已完成宿主机与容器内双路径验证（`http://127.0.0.1:18080/api/dashboard/summary` + 容器内 `fetch`），满足 Linux 运行态可用性要求。

### 步骤 1.3 完成记录
- 实际情况：已新增 `src/skills-service.js`，落地 Skills 状态查询、单技能配置读取、启停能力，并在 `src/server.js` 暴露：
  - `GET /api/skills/status`
  - `GET /api/skills/:skillKey/config`
  - `POST /api/skills/:skillKey/enabled`
- 遇到问题：Gateway 原生 `skills.update` 对不存在 skillKey 也可能返回成功，存在误操作风险。
- 技术债：后续 `5.3` 需要追加“API Key/env 编辑回写 + 失败回滚 + 审计日志”完整链路；本轮先完成启停与关键配置读取。
- 兼容性备注：已做无副作用联调（未知 skillKey 启停返回明确错误），并落证据 `evidence/skills-service-live.json`。

### 步骤 1.4 完成记录
- 实际情况：已新增 `src/chat-service.js`，实现会话列表、历史读取、消息发送、中止运行、会话重置；并在 `src/server.js` 暴露：
  - `GET /api/chat/sessions`
  - `GET /api/chat/history`
  - `POST /api/chat/send`
  - `POST /api/chat/abort`
  - `POST /api/chat/session/reset`
- 遇到问题：容器重建后短窗口内会命中旧实例路由，导致新接口短时 404；增加“接口可用性轮询”后验证稳定。
- 技术债：当前 `chat.send` 仅返回 ack（`runId/status=started`），流式增量输出与状态广播留到 `1.5` 统一实现。
- 兼容性备注：已在 Docker 运行态完成真实联调（会话/历史/发送/中止/重置全链路），证据见 `evidence/chat-service-live.json`。

### 步骤 1.4.1 / 1.4.2 完成记录
- 实际情况：已在前端新增侧栏入口与页面面板：`状态总览`、`Skills 管理`、`对话控制台`；并完成 API 绑定：
  - 状态总览：`GET /api/dashboard/summary`
  - Skills：`GET /api/skills/status`、`GET /api/skills/:skillKey/config`、`POST /api/skills/:skillKey/enabled`
  - 对话控制台：`GET /api/chat/sessions`、`GET /api/chat/history`、`POST /api/chat/send`、`POST /api/chat/abort`、`POST /api/chat/session/reset`
- 遇到问题：本地存在历史同名容器（`openclaw-panel` / `openclaw-gateway`）导致 `docker compose up` 冲突，已先清理旧容器再重建。
- 技术债：当前对话控制台仍为“控制层最小实现”，流式增量展示与更细粒度思考态展示留在 `1.5`。
- 兼容性备注：已在 Docker 运行态验证路由与 API 可达（`/status-overview`、`/skills`、`/chat-console` 均返回 200）。

### 步骤 1.5 完成记录
- 实际情况：已新增 `GET /api/chat/stream`（SSE）并接入 Gateway 事件订阅桥；前端 `对话控制台` 已接入实时流展示（`ready/status/chat/agent/terminal/stream-error`）。
- 遇到问题：网关短时断链会导致流中断；已在服务端加入自动重连状态机（`reconnecting/connect-failed/gateway-closed`）并持续输出状态事件。
- 技术债：当前流展示以事件日志和增量文本为主，后续 `6.3/6.4` 可继续做 UI 级“消息气泡内原位增量渲染 + 思考状态分层”。
- 兼容性备注：已完成 Docker 运行态实测，证据见 `evidence/chat-stream-sse-live.json`（终态 `final`，包含 `delta` 事件）。

### 步骤 0.8 完成记录
- 实际情况：已完成 ClawX 用户视角能力盘点，形成“已对齐/缺失/优先级”矩阵报告，确认下一优先级为 Chat 主页面用户化。
- 遇到问题：当前面板 Chat 交互偏调试控制台风格，不符合小白用户操作路径。
- 技术债：仍需补“新建会话”接口与前端聊天消息气泡化渲染，避免继续暴露原始事件流。
- 兼容性备注：本轮仅文档与差异分析，无环境依赖差异风险。

### 步骤 1.6 完成记录
- 实际情况：已新增 `POST /api/chat/session/new`，后端自动按现有会话前缀生成新 `sessionKey` 并调用 `sessions.reset(reason=new)` 创建会话。
- 遇到问题：不同环境的会话 key 前缀可能不一致；已通过“优先复用现有 canonical 前缀，失败回退 `agent:main`”规避。
- 技术债：后续可增加“按用户输入前缀创建会话”能力，目前前端默认自动生成。
- 兼容性备注：已在 Docker 运行态实测通过，证据见 `evidence/chat-session-new-live.json`。

### 步骤 6.1~6.7 完成记录
- 实际情况：`/chat-console` 已从“对话控制台”升级为“智能对话”主聊天页，默认视图包含会话选择、消息区、输入区、停止回复与思考显示开关；高级原始事件信息迁移到折叠区。
- 遇到问题：历史实现依赖原始 SSE 文本输出，直接替换会导致定位问题困难；已保留原始历史/流事件面板作为折叠调试区。
- 技术债：消息富渲染与字段级错误提示尚未完成，当前仍以纯文本 + 全局时间线为主。
- 兼容性备注：已在 Docker 重建后完成“附件落盘 -> 路径映射 -> 真实发送回放”验证，证据见 `evidence/chat-user-workspace-live.md`、`evidence/chat-attachments-live.json`、`evidence/chat-attachments-pathmap-live.json`。
