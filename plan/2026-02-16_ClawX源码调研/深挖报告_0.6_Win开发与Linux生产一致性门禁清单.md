# 深挖报告 0.6：Win 开发与 Linux 生产一致性门禁清单

创建时间：2026-02-16 15:00:00（UTC+8）

## 目标
- 建立“Windows 开发 + Docker”到“Linux 生产 + Docker”的一致性门禁。
- 让后续每个开发阶段都有明确 Linux 可用性验证项，避免只在 Windows 上通过。

## 已知差异与风险
| 类别 | Windows 开发侧 | Linux 生产侧 | 风险 |
|------|---------------|-------------|------|
| Shell 与脚本 | 常在 PowerShell 触发，脚本主体是 bash | 直接 bash | 换行符/转义差异导致脚本失败 |
| 文件权限 | bind mount 下 `chmod 600` 语义弱 | 权限真实生效 | 配置文件权限在生产不符合最小权限 |
| Docker 网络 | 可能遗留跨 compose 网络漂移 | 通常更干净 | 容器间 DNS 偶发失败、同名容器冲突 |
| 升级恢复窗口 | 开发常忽略冷却时间 | 生产更敏感 | 网关重建后短时不可用导致业务误报 |
| 地址展示 | 容易默认 `127.0.0.1` | 需要公网 `IP:端口` | Webhook/外部访问配置错误 |

## 阶段门禁（强制）
> 规则：每完成一个阶段，必须至少执行该阶段对应的一条 Linux 验证。

### 阶段 1：后端基础改造（1.1~1.5）
- 必测项：
  1. 在 Linux 容器内执行关键接口调用（不是只在 Windows 宿主调用）
  2. Gateway 内网 DNS 可达：`openclaw-panel -> openclaw-gateway`
- 验收命令（示例）：
  - `docker exec openclaw-panel node -e "fetch('http://openclaw-gateway:18789/').then(r=>console.log(r.status))"`
  - `curl -sS -X POST http://127.0.0.1:18080/api/service/status`

### 阶段 2：仪表盘增强（2.1~2.3）
- 必测项：
  1. 仪表盘显示公网地址字段（不是固定 localhost）
  2. 公网地址未配置时显示明确提示
- 验收方式：
  - 浏览器打开 `/dashboard`，核对“面板公网访问地址 / Webhook 回调基地址”文案

### 阶段 3：模型与提供商页增强（3.1~3.4）
- 必测项：
  1. 模型切换与提供商保存后，Linux 容器内 `openclaw.json` 持久化正确
  2. 容器重启后配置不丢失
- 验收命令（示例）：
  - `docker exec openclaw-gateway sh -lc "cat /home/node/.openclaw/openclaw.json | head -n 80"`
  - `docker restart openclaw-gateway && curl -sS -X POST http://127.0.0.1:18080/api/service/status`

### 阶段 4：渠道管理（4.1~4.3）
- 必测项：
  1. 渠道配置写回后字段结构与 OpenClaw 官方字段对齐
  2. 渠道测试失败时错误可读、无崩溃
- 验收方式：
  - 页面保存 + 测试按钮回放
  - 检查 `/api/settings` 返回结构

### 阶段 5：Skills 管理（5.1~5.3）
- 必测项：
  1. `skills.status` 读取成功
  2. 不存在 skillKey 的更新被前端/服务层拦截
  3. 高风险动作有二次确认
- 验收方式：
  - Linux 容器内回放 skills RPC
  - 页面交互验证“拦截 + 提示”

### 阶段 6：Chat 能力迁移（6.1~6.5）
- 必测项：
  1. `delta/final/aborted` 状态流可稳定回放
  2. 网关重启后 10~15 秒内自动重试恢复，不误判永久故障
- 验收方式：
  - 结合 `0.5` 的恢复窗口做故障注入回放（restart/upgrade 后立刻发消息）

### 阶段 7：回归与发布（7.1~7.4）
- 必测项：
  1. Linux 主机实机回放“模型/渠道/更新/日志/Chat/Skills”全链路
  2. 升级后回滚路径可用
- 验收命令（示例）：
  - `npm run test`
  - `bash deploy/docker-update.sh v<target>`
  - `bash deploy/docker-rollback.sh v<target>`

## 统一发布前门禁（最小集）
1. `docker compose config` 无异常且端口全来自 env/配置。
2. `openclaw-panel` 与 `openclaw-gateway` 在同一内部网络。
3. `/api/panel-config` 返回 `deployment.panelPublicUrl / webhookBaseUrl`（可为空但提示正确）。
4. 至少一次 Linux 容器内探测通过（内部 DNS + 关键 API）。
5. `npm run test` 与 `npm run check` 全通过。

## 结论
- 任务 `0.6 建立 Win 开发环境到 Linux 生产环境的一致性门禁清单` 达成。
- 后续进入编码阶段时，必须按本门禁执行阶段验收，不得只提交“Windows 本地可用”的结果。
