# 深挖报告 1.4：Chat 服务层（会话/历史/发送/中止）

创建时间：2026-02-16 15:20:30（UTC+8）

## 目标
- 在不改 OpenClaw 核心的前提下，提供控制台后端 Chat 服务边界：
  - 会话列表
  - 历史读取
  - 消息发送
  - 运行中止
  - 会话重置
- 为后续 `1.5` 流式通道打基础。

## 实施范围
- 新增：
  - `src/chat-service.js`
  - `test/unit/chat-service.test.js`
- 修改：
  - `src/server.js`（新增 Chat API）
- 证据：
  - `plan/2026-02-16_ClawX源码调研/evidence/chat-service-live.json`

## 设计要点
1. 服务封装
- `listChatSessions` → `sessions.list`
- `getChatHistory` → `chat.history`
- `sendChatMessage` → `chat.send`（包含 idempotencyKey）
- `abortChatRun` → `chat.abort`
- `resetChatSession` → `sessions.reset`

2. 参数与容错
- 所有入口参数统一做校验（`sessionKey`、`message` 等）。
- Gateway 调用统一沿用重试窗口（`timeoutMs=1000, retries=6, retryDelayMs=1000`）。

3. API 设计
- `GET /api/chat/sessions`
- `GET /api/chat/history?sessionKey=...&limit=...`
- `POST /api/chat/send`
- `POST /api/chat/abort`
- `POST /api/chat/session/reset`

## 验证结果
1. 自动化
- `npm run test`：通过（新增 chat-service 单测）。
- `npm run check`：通过。

2. Docker 联调
- 路径：`sessions -> history -> send -> abort -> reset`
- 结果：全部成功，关键字段返回正常（`runId`、`aborted`、`resetKey`）。
- 证据：`plan/2026-02-16_ClawX源码调研/evidence/chat-service-live.json`

## 结论
- `1.4 Chat 服务层` 已完成，具备会话切换与消息收发基础能力。
- 下一步进入 `1.5 Chat 流式输出通道`，补齐 delta/final/error/aborted 的实时推送链路。
