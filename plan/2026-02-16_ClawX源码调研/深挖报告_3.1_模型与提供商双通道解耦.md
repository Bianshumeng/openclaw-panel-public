# 深挖报告 3.1：模型与提供商双通道解耦

创建时间：2026-02-16

## 本轮目标

完成任务 `3.1`：保持“设置当前默认模型”和“新增提供商”双通道结构，确保两条路径可以独立完成配置，避免隐式副作用。

## 实施范围

- 前端：
  - `public/index.html`
  - `public/app.js`
- 文档与证据：
  - `plan/2026-02-16_ClawX源码调研/任务清单.md`
  - `plan/2026-02-16_ClawX源码调研/evidence/model-provider-dual-path-3.1-live.md`

## 关键改动

### 1) 模型页文案与交互入口明确“双通道”

- 新增“模型配置导航”说明，明确：
  - 路径 1：只改当前默认模型；
  - 路径 2：只新增/写入提供商。
- 新增路径跳转按钮，降低小白用户迷路概率。

### 2) 新增提供商流程增加显式开关

- 在“基础配置（模板）”和“自定义模式”各自新增开关：
  - `template_set_as_primary`
  - `custom_set_as_primary`
- 默认关闭：保存提供商时不切换默认模型。
- 用户显式勾选后：保存提供商的同时切换默认模型。

### 3) 修复根因：避免前端固定写入新 primary

- 新增 `resolveProviderSavePrimaryRef()`，按开关状态决定 `primary`：
  - 未勾选：使用当前 `modelSettings.primary`；
  - 已勾选：使用目标 `provider/model`。
- 直接规避后端 `applySettings()` 必写 `agents.defaults.model.primary` 带来的隐式覆盖问题。

## 验证结果

1. 自动化：
- `node --check public/app.js` 通过
- `node --check public/config-generator.js` 通过
- `npm run test:unit` 通过（48/48）
- `npm run test:regression` 通过（3 pass / 1 skip）

2. Docker：
- `docker compose up -d --build panel` 成功

3. 运行态结构：
- `/model` 页面可命中 `template_set_as_primary` 与 `custom_set_as_primary` 两个关键开关
- 证据：`evidence/model-provider-dual-path-3.1-live.md`

## 与用户视角一致性

改造前：
- 用户在“新增提供商”时，容易不知情地把默认模型改掉。

改造后：
- 默认行为是“只新增提供商，不动默认模型”；
- 想切默认模型必须显式勾选，行为可预期、可解释。

## 结论

`3.1` 已完成并验证通过。下一步按清单进入 `3.2`：继续强化“基础模板 vs 自定义模式”的引导与切换体验。
