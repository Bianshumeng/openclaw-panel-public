# 深挖报告 1.9：Chat 富渲染与局部错误提示

创建时间：2026-02-16

## 本轮目标

完成 `6.8`：在不改变现有后端协议的前提下，提升消息可读性与错误可定位性，进一步对齐 ClawX 的用户视角体验。

目标拆解：
1. 消息富渲染（基础 Markdown + 代码块）；
2. 工具调用/工具结果文本可读化；
3. 聊天区域内联动作提示（成功/失败）。

## 实施范围

- 前端：
  - `public/app.js`
  - `public/index.html`
  - `public/styles.css`
- 文档与证据：
  - `plan/2026-02-16_ClawX源码调研/evidence/chat-rich-render-inlinehint-live.md`
  - `plan/2026-02-16_ClawX源码调研/任务清单.md`
  - `plan/2026-02-16_ClawX源码调研/规格变更/OpenClaw面板.md`
  - `plan/规格/OpenClaw面板.md`

## 关键改动

### 1) 消息富渲染

- 新增 `renderRichMessageBody` 渲染链路：
  - 识别 `**bold**`
  - 识别行内代码 `` `code` ``
  - 识别 fenced code block（```）
- assistant/system/tool 消息改用富渲染输出，user 消息保持纯文本。

### 2) 工具消息可读化

- 在消息归一化阶段兼容：
  - `toolCall` / `tool_call`
  - `toolResult` / `tool_result`
- 统一渲染为：
  - `[工具调用] <name>`
  - `[工具结果] <content>`

### 3) 局部动作提示

- 在聊天操作区新增 `#chat_inline_hint`。
- 新增 `setChatInlineHint`、`reportChatActionError`：
  - 覆盖发送、刷新会话、刷新历史、新建会话、附件处理、中止、重置等动作。
- 结果：用户无需只看全局时间线，也能在当前操作区域快速定位问题。

## 与 ClawX 用户视角的一致性进展

已明显对齐：
1. 聊天内容可读性（非原始结构文本）；
2. 操作反馈更贴近消息上下文；
3. 工具事件更容易被小白用户理解。

仍有差异：
1. 富渲染目前是“轻量子集”，未覆盖完整 Markdown 语法；
2. 未引入 ClawX 级别的富组件（引用块、复杂表格等）。

## 验证结果

1. 自动化：
   - `npm run test:unit` 通过（48/48）。
   - `npm run test:regression` 通过（3 pass, 1 skip）。
2. Docker：
   - `docker compose up -d --build panel` 重建成功。
3. 运行态：
   - 页面含 `chat_inline_hint`。
   - 运行 JS/CSS 均包含关键渲染/提示逻辑。
   - 证据：`evidence/chat-rich-render-inlinehint-live.md`。

## 结论

`6.8` 已闭环，聊天页在“小白可读性”上已达到下一阶段推进条件。  
下一优先级建议回到仪表盘增强（`2.1`），把状态总览信息进一步按“用户动作”组织并补快捷入口。
