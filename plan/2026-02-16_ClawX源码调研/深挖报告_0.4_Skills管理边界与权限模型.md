# 深挖报告 0.4：Skills 管理边界与权限模型

创建时间：2026-02-16 13:45:00（UTC）

## 目标
- 明确 Skills 相关 Gateway 方法的权限门槛与行为边界。
- 给出面板侧“可暴露 / 需确认 / 禁止暴露”分类表。
- 避免“假成功”“高风险安装误触”“越权调用”进入正式功能。

## 测试环境
- 执行环境：`openclaw-gateway` 容器内（Linux）
- 网关地址：`ws://127.0.0.1:18789/ws`
- 客户端身份：`clientName=cli`、`mode=cli`（operator 角色）
- 证据脚本：
  - `plan/2026-02-16_ClawX源码调研/evidence/skills-boundary-probe-live.mjs`
- 原始证据：
  - `plan/2026-02-16_ClawX源码调研/evidence/skills-boundary-live.json`

## 代码层结论（权限与行为）

1. 方法权限门槛（网关鉴权）
- `skills.status`：读权限方法（`operator.read / operator.write / operator.admin` 之一可用）。
- `skills.update`：管理员权限方法（无 admin 直接拒绝）。
- `skills.install`：管理员权限方法（无 admin 直接拒绝）。
- `skills.bins`：被归类为 **node-role-only**（operator 角色会收到 `unauthorized role`）。

参考：
- `third_party/openclaw/src/gateway/server-methods.ts`
- `third_party/openclaw/src/gateway/server-methods/skills.ts`

2. 关键行为边界
- `skills.update` 不校验 `skillKey` 是否存在于 `skills.status` 列表，允许写入任意 key 到配置。
- `skills.install` 会触发外部安装流程（`brew/npm/pnpm/yarn/bun/go/uv/download`），属于高风险动作。
- `skills.status` 返回的是“可识别技能清单”，配置中孤立 key（如 probe key）不会出现在列表中。

参考：
- `third_party/openclaw/src/gateway/server-methods/skills.ts`
- `third_party/openclaw/src/agents/skills-install.ts`
- `third_party/openclaw/src/agents/skills-status.ts`

## 实测结果摘要

| 检查项 | 结果 | 结论 |
|------|------|------|
| `skills.status` | 成功，返回 49 项技能 | 可作为面板主数据源 |
| `skills.status(agentId=unknown)` | 失败，报 unknown agent | 需要前端 agentId 白名单 |
| `skills.update("__panel_probe_nonexistent_skill__")` | 成功返回 `ok=true` | 存在“假成功”风险 |
| `skills.status`（更新后） | 仍不包含 probe skillKey | 证明“配置写入成功 ≠ 技能真实存在” |
| `skills.install`（缺失技能） | 失败，返回 Skill not found | 安装流程错误反馈正常 |
| `skills.bins`（operator） | 失败，`unauthorized role: operator` | operator 控制台不应依赖该方法 |

## 分类表（面板落地）

| 分类 | 能力 | 依据 | 面板策略 |
|------|------|------|---------|
| 可暴露 | Skills 列表、状态、缺失依赖展示（基于 `skills.status`） | 读方法 + 低风险 | 直接展示 |
| 可暴露 | 对“已存在 skillKey”做启停切换（`enabled`） | 功能核心需求，但需先做存在性校验 | 允许操作，操作前校验 key |
| 需确认 | 更新 `apiKey/env` | 涉及密钥、环境变量，影响运行安全 | 二次确认 + 密钥脱敏显示 + 审计日志 |
| 需确认 | `skills.install` 安装动作 | 执行外部命令/下载，成本与安全风险高 | 强制二次确认，默认关闭入口（按策略开） |
| 禁止暴露 | 直接调用 `skills.update` 写未知 key | 会造成“假成功”并污染配置 | UI 层禁止，必须先 `skills.status` 校验 |
| 禁止暴露 | operator 角色调用 `skills.bins` | 网关角色策略拒绝 | 不在控制台中暴露此调用 |

## 对后续实现的硬约束
1. `skills.update` 前置存在性校验：
- `skillKey` 必须来自最新 `skills.status` 返回值，否则前端直接拦截。

2. 更新动作拆级：
- `enabled` 可走轻量确认；
- `apiKey/env/install` 必须走高风险确认弹窗。

3. 错误处理统一：
- 区分 `invalid request / unauthorized / unavailable` 三类；
- 严禁把网关失败映射为“保存成功”。

4. 角色边界固定：
- 控制台使用 operator 角色，不引入 node 角色能力绕过鉴权。

## Linux 兼容性结论（本轮）
- 本轮验证在 Linux 容器中直接完成，权限行为与生产 Linux 一致。
- 可直接用于面板实现阶段的权限策略，不依赖 Windows 宿主特性。

## 结论
- `0.4` 达成：已形成 Skills 权限模型与操作边界分类表。
- 下一步可进入 `0.5`（Docker 稳定性基线）继续补齐生产可运维证据。

