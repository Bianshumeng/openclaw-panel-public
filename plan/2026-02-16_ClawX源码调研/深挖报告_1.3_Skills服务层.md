# 深挖报告 1.3：Skills 服务层

创建时间：2026-02-16 15:16:30（UTC+8）

## 目标
- 建立独立 Skills 服务层，支持：
  - 查询技能状态列表
  - 启用/禁用技能
  - 读取单技能关键配置
- 规避已知风险：`skills.update` 对不存在 skillKey 的“假成功”。

## 实施范围
- 新增：
  - `src/skills-service.js`
  - `test/unit/skills-service.test.js`
- 修改：
  - `src/server.js`（新增 Skills API）
- 证据：
  - `plan/2026-02-16_ClawX源码调研/evidence/skills-service-live.json`

## 设计要点
1. 服务边界
- `listSkillsStatus`：统一调用 `skills.status`，输出标准化结构（key/name/enabled/eligible/blocked/source/requirements）。
- `getSkillConfig`：读取 `openclaw.json` 的 `skills.entries[skillKey]`，返回掩码后的关键配置（`enabled`、`apiKeyMasked`、`env`）。
- `setSkillEnabled`：先读 `skills.status` 建立技能索引，再调用 `skills.update`；不存在的 skillKey 直接拒绝。

2. 风险兜底
- 针对“未知 skillKey 假成功”问题，服务层增加前置存在性校验，拒绝直接透传 `skills.update`。

3. 可靠性策略
- 复用 Gateway 调用重试窗口（约 10~15 秒）：
  - `timeoutMs=1000`
  - `retries=6`
  - `retryDelayMs=1000`

## API 输出
- `GET /api/skills/status`
  - 返回技能总数、启停统计、技能列表。
- `GET /api/skills/:skillKey/config`
  - 返回目标技能的关键配置（掩码）。
- `POST /api/skills/:skillKey/enabled`
  - 入参：`{ "enabled": true|false }`
  - 先校验 skillKey 是否存在，再执行更新。

## 验证结果
1. 自动化
- `npm run test`：通过（新增 Skills 服务层单测）。
- `npm run check`：通过。

2. Docker 联调（无副作用）
- `GET /api/skills/status`：`ok=true`，`skillsTotal=53`
- `GET /api/skills/skill-creator/config`：`ok=true`
- `POST /api/skills/__unknown_skill__/enabled`：`ok=false`，返回“未知技能”
- 证据：`plan/2026-02-16_ClawX源码调研/evidence/skills-service-live.json`

## 结论
- `1.3 Skills 服务层` 已完成，且已修复“未知技能误更新”风险入口。
- 下一步可进入 `1.4 Chat 服务层`（会话、历史、发送、中止）。
