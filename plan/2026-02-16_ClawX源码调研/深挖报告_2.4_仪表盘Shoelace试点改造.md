# 深挖报告 2.4：仪表盘 Shoelace 试点改造

## 1. 背景
- 当前仪表盘在小白用户视角下“层次不清、密度偏高”，尤其是运行态明细（渠道/Skills）阅读负担偏大。
- 本轮目标是在不改业务逻辑的前提下，先做单页组件化试点，验证“更清晰的视觉层次 + 低改造风险”是否可行。

## 2. 本轮目标
- 仅改造 `/dashboard` 页面，不动其它页面交互与结构。
- 引入本地托管 Shoelace 组件能力（不依赖外网 CDN）。
- 保持现有事件与 API 链路不变：刷新总览、模型快速切换、快捷跳转、运行态渲染。

## 3. 改动范围
- `package.json`：新增 `@shoelace-style/shoelace` 依赖。
- `src/server.js`：新增 `/shoelace/` 静态资源映射。
- `public/index.html`：仅重排仪表盘区块，接入 Shoelace 主题与自动加载器。
- `public/styles.css`：新增仪表盘组件化样式层（KPI 卡片、运行态卡片、标签样式）。
- `public/app.js`：仪表盘运行态列表改为 Shoelace 卡片/标签渲染；主题切换同步 Shoelace dark/light class。

## 4. 关键实现
### 4.1 本地资源接入
- 后端增加第二个 static root 指向 `node_modules/@shoelace-style/shoelace/cdn`。
- 解决 Fastify 双 static 注册冲突：第二次注册显式配置 `decorateReply: false`。

### 4.2 仪表盘结构改造
- 保留所有既有业务 ID（如 `dashboard_summary_*`、`dashboard_quick_*`、`dashboard_*_list`），避免改动事件绑定代码。
- 状态总览改为 Shoelace KPI 卡片，运行态条目改为 Shoelace `sl-card + sl-tag`。
- 运行态容器继续采用“左渠道、右技能”的双列，但改成固定滚动区域，防止页面无限拉长。

### 4.3 主题一致性
- 原有主题切换逻辑继续使用 `body[data-theme]`。
- 新增 `document.documentElement` 上 `sl-theme-light/sl-theme-dark` 切换，确保 Shoelace 组件与全站主题同步。

## 5. 验证结果
- 自动化：`npm test` 全量通过。
- Docker：`docker compose up -d --build panel` 成功。
- 运行态：
  - `GET http://127.0.0.1:18080/api/health` 返回 200。
  - `GET http://127.0.0.1:18080/shoelace/themes/light.css` 返回 200。
- 浏览器检查：`/dashboard` 页面组件渲染正常，控制台无新增阻断级报错（既有 `service/status` 400 为历史行为，与本次改造无关）。

## 6. 风险与回滚
- 风险：Shoelace 接入后增加少量前端资源请求。
- 回滚：
  1. 删除 `public/index.html` 中 Shoelace 资源引用与仪表盘组件标签。
  2. 回退 `public/app.js` 仪表盘渲染函数到原生节点实现。
  3. 移除 `src/server.js` 的 `/shoelace/` 静态映射与 `package.json` 依赖。
- 影响边界：仅控制台前端与面板服务静态资源层，不涉及 OpenClaw 核心逻辑与配置写入链路。
