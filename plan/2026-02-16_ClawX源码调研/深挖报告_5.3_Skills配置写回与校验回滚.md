# 深挖报告 5.3：Skills 配置写回与校验回滚

创建时间：2026-02-16

## 本轮目标

完成任务 `5.3`：为 Skills 页面补齐“配置写回”入口，并在后端实现“写入后校验 + 失败自动回滚”的闭环。

## 实施范围

- 后端：
  - `src/skills-service.js`
  - `src/server.js`
- 前端：
  - `public/index.html`
  - `public/app.js`
- 测试：
  - `test/unit/skills-service.test.js`
- 文档与证据：
  - `plan/2026-02-16_ClawX源码调研/任务清单.md`
  - `plan/2026-02-16_ClawX源码调研/规格变更/OpenClaw面板.md`
  - `plan/2026-02-16_ClawX源码调研/evidence/skills-config-writeback-5.3-live.md`

## 根因与改造点

### 1) 根因：Skills 页只有“查看/启停”，缺“可控写回”

- 现状只能读配置和启停 Skill；
- 用户无法在控制台内直接维护 `skills.entries.<skillKey>` 的 `enabled/apiKey/env`；
- 一旦需要写回，只能手工改 JSON，风险高、门槛高。

### 2) 后端新增写回链路（含校验回滚）

- 在 `skills-service` 新增 `prepareSkillConfigUpdate(...)`：
  - 先做 `skills.status` 存在性校验，拦截未知 `skillKey`；
  - 只按 patch 改动字段，未填写字段保持不变；
  - 支持 `clearApiKey` 与 `env` 的增删（`KEY=` 删除）。
- 在 `server` 新增 `PUT /api/skills/:skillKey/config`：
  - payload 校验：至少一个可写字段，禁止 `clearApiKey + apiKey` 同时提交；
  - 调用 `saveOpenClawConfig` 写盘后，立即读取并做字段级回读校验；
  - 校验失败时自动用备份文件回滚，并返回明确错误原因。

### 3) 前端新增写回入口（面向小白）

- 在 Skills 页新增“Skill 配置写回”卡片：
  - 启用状态下拉（保持不变/启用/禁用）
  - API Key 输入（留空不改）
  - 清除 API Key 勾选
  - 环境变量补丁（每行 `KEY=VALUE`，`KEY=` 删除）
- 写回结果就地显示（成功/失败），并自动刷新列表与配置预览。

## 验证结果

1. 自动化：
- `node --check public/app.js` 通过
- `node --check src/server.js` 通过
- `npm run test:unit` 通过（51/51）
- `npm run test:regression` 通过（3 pass / 1 skip）

2. Docker：
- `docker compose up -d --build panel` 成功

3. 运行态：
- `PUT /api/skills/:skillKey/config` 真实写回成功；
- `KEY=` 删除 env 键生效；
- 页面可见“Skill 配置写回”完整表单；
- 证据见 `evidence/skills-config-writeback-5.3-live.md`。

## 与用户视角一致性

改造前：
- 小白用户只能看 Skill 配置，改配置得离开控制台手工改文件。

改造后：
- 用户在 Skills 页就能按表单改最常见字段；
- 错误会直接告诉用户“哪一步错了”，不会静默失败；
- 后端写后校验失败会自动回滚，避免把配置文件写坏。

## 结论

`5.3` 已完成并通过验证。Skills 管理从“可视化查看 + 启停”升级为“可视化查看 + 启停 + 安全写回闭环”。下一步可进入 `7.x` 回归验证阶段。
