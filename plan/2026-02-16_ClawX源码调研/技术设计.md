# 技术设计

## 背景与约束
- 当前项目是 Web 控制台（Fastify + 静态前端），以 Docker 方式运行，核心职责是“外部控制器”。
- 被调度对象是 OpenClaw/龙虾 Bot 运行时，不允许通过修改 OpenClaw 源码来实现面板能力。
- `third_party/ClawX` 可提供功能逻辑参考，但其 Electron IPC、桌面集成、更新机制不能直接迁移。
- 现有模块已具备配置写入、服务控制、日志流、版本更新、基础页面路由，适合作为增量扩展基础。
- 当前开发环境是 Windows 主机中的 Docker，生产环境是 Linux 主机中的 Docker；所有新增能力必须通过 Linux 可用性门禁后才可视为完成。
- 生产部署为“母机单公网 IP + 分配端口”模式：外部访问依赖 `公网IP:端口`，容器内部通信走 Docker 内网与共享卷。

## 目标
- 在不破坏插件式控制架构的前提下，迁移 ClawX 的高价值能力：
  - 状态总览增强（Dashboard）。
  - Skills 管理（查询、启用/停用、必要配置入口）。
  - Chat 能力增强（多会话、流式消息、思考状态显示），并升级为面向小白的主聊天工作台体验。
  - 提供商与更新流程的交互优化（保留现有后端边界）。
- 将迁移工程拆成“深挖门禁 -> 接口契约 -> 分阶段实施 -> 回归验收”。

## 不做（Non-Goals）
- 不迁移首次安装向导、任务调度（Cron）、主题系统。
- 不引入 Electron 进程模型，不新增桌面端依赖。
- 不将控制台重构成龙虾 Bot 的内嵌前端。

## 架构原则（硬约束）
1. 插件式控制器：控制台只通过配置文件、服务控制命令、Gateway RPC 与 OpenClaw交互。
2. 边界清晰：后端负责协议转换与安全控制，前端只负责展示和交互。
3. 可回滚：每批能力独立开关，失败可单独回退，不影响已有配置/更新/日志模块。
4. 可观测：新增接口必须具备请求日志、错误码、超时标识。
5. 先深挖后实施：关键接口可用性未确认前，不进入不可逆实现。
6. 环境一致性：Windows 开发验证不等于生产验收，关键能力必须补 Linux 实机验证。
7. 端口不可硬编码：所有对外端口必须配置化（env/配置文件），前端展示地址与 webhook 回调统一输出 `公网IP:端口`。

## 目标架构分层
### 1) 控制层（现有）
- `src/server.js`：REST/SSE 入口与路由注册。

### 2) 领域适配层（新增）
- `src/gateway-client.js`：统一封装 Gateway RPC 调用、超时、重试、错误归一化。
- `src/chat-service.js`：会话列表、历史、发送、中止、会话新建、流事件分发。
- `src/skills-service.js`：技能状态读取、启停、配置写回代理。
- `src/dashboard-service.js`：聚合模型/渠道/技能/运行状态指标。

### 3) 配置与持久层（现有增强）
- `src/openclaw-config.js`：继续负责配置抽取与写入（模型/渠道/提供商）。
- `src/panel-config.js`：面板运行参数与功能开关。
- `src/logs.js`：保留日志读取与错误摘要。

### 4) 前端展示层（现有增强）
- `public/app.js`：按页面模块拆分逻辑，新增 chat/skills/dashboard 交互模块，Chat 改为“主聊天页”交互模型。
- `public/index.html`：将“对话控制台”入口升级为“智能对话”，默认展示会话与聊天消息，不暴露调试术语。
- `public/styles.css`：补充聊天消息气泡、流式状态、会话列表和移动端输入区样式。

## 技术决策
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| Chat 事件传输 | 优先 SSE，必要时升级 WS | 现有日志流已使用 SSE，接入成本低 | 直接抄 Electron 事件桥 |
| Gateway 调用 | 后端统一适配层 | 避免前端散落 RPC 细节与重试逻辑 | 前端直连 Gateway |
| 会话状态存储 | OpenClaw 为主、面板仅缓存展示态 | 防止双写冲突 | 面板侧自建会话主存储 |
| Skills 管理入口 | 面板聚合 + Gateway 代理 | 保持插件式边界 | 直接操作未知脚本/目录 |
| 渐进发布 | 分批路由开关 | 降低回归风险 | 一次性大改上线 |

## 深挖门禁与验证方法
### 门禁 A：Gateway RPC 可用性
- 验证方法：在 Docker 环境逐项调用 `sessions.list/chat.history/chat.send/chat.abort/skills.status/skills.update`。
- 通过标准：成功率 >= 99%，错误码可分类，超时可控。

### 门禁 B：流式事件可靠性
- 验证方法：模拟 50 次连续发送，观察 delta/final 顺序、断流重连、重复消息率。
- 通过标准：不出现“final 丢失导致卡死发送态”，重复消息可去重。

### 门禁 C：Skills 安全边界
- 验证方法：识别所有技能管理动作的执行权限与副作用，分类为“可直接暴露/需二次确认/禁止暴露”。
- 通过标准：高风险操作必须二次确认并可审计。

### 门禁 D：配置一致性
- 验证方法：模型/提供商/渠道改动后回读 `openclaw.json` 对比预期结构。
- 通过标准：字段映射与当前规格一致，不出现跨面板副作用写入。

### 门禁 E：Windows 与 Linux 一致性
- 验证方法：在 Linux 目标环境复跑 0.2~0.4 的关键探测与核心用户流程。
- 通过标准：关键接口成功率、主要返回结构、关键页面行为与 Windows 开发环境一致或差异可解释且有补偿方案。

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| Chat 流式状态机复杂，易出现重复/漏消息 | 引入 runId + sessionKey 幂等键，落地状态机测试用例 |
| Skills 接口在不同版本 OpenClaw 行为不一致 | 先做版本探测与能力降级，接口不可用时隐藏入口 |
| 新增接口影响现有设置页稳定性 | 严格隔离路由与 payload，禁止在 model 保存时顺带写 channel 字段 |
| 文档与实现偏离 | 每个里程碑更新任务清单与规格变更，验收后再合并主规格 |
| Windows Docker 与 Linux Docker 行为差异 | 将 Linux 回归设为发布前门禁，保留差异对照清单与修复优先级 |

## 迁移/回滚方案
- 迁移步骤：
  1. 完成深挖门禁并产出接口能力报告。
  2. 实现后端 Gateway 适配层与聚合服务。
  3. 实现前端 Dashboard/Skills/Chat 能力模块。
  4. 回归模型/渠道/更新/日志既有流程。
  5. 开启默认入口并发布。
- 回滚步骤：
  1. 关闭新增页面入口与相关 API 路由。
  2. 恢复到上一稳定 commit。
  3. 保留文档与问题记录，进入下一轮修复。
- 验证方式：
  - 自动化：`npm run test`、新增 chat/skills/dash 相关单测。
  - 手工：按“应用流程文档”逐条回放关键路径。
  - 运行态：Docker 重启后配置与会话行为保持一致。
