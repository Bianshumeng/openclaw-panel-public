# 深挖报告 3.4：API 模式下拉与 GPT/Claude/Gemini 联动

创建时间：2026-02-16

## 本轮目标

完成任务 `3.4`：在“新增提供商”流程中完善 API 模式下拉与模型族联动，确保 GPT/Claude/Gemini 切换时 URL/API 模式自动切换，同时保留可覆写能力。

## 实施范围

- 前端：
  - `public/index.html`
  - `public/app.js`
- 文档与证据：
  - `plan/2026-02-16_ClawX源码调研/任务清单.md`
  - `plan/2026-02-16_ClawX源码调研/规格变更/OpenClaw面板.md`
  - `plan/2026-02-16_ClawX源码调研/evidence/model-api-linkage-3.4-live.md`

## 关键改动

### 1) 自定义模式补齐 API 模式下拉

- `custom_api` 从文本输入升级为下拉 + 自定义输入（`custom_api_custom`）。
- 支持四种预置 API 模式：
  - `openai-responses`
  - `openai-completions`
  - `anthropic-messages`
  - `google-generative-ai`

### 2) 自定义模式补齐默认模型下拉

- `custom_default_model_id` 从文本输入升级为下拉 + 自定义输入（`custom_default_model_id_custom`）。
- 下拉选项与全局默认模型 ID 同源一致。

### 3) 新增联动逻辑（AICodeCat）

- 新增 `syncCustomByModelSelection()`：
  - 根据模型族（GPT/Claude/Gemini）自动切换 API 模式；
  - 自动切换 `providerId` 到 `aicodecat-gpt/claude/gemini`；
  - 自动切换对应 Base URL。
- 新增 `syncCustomByApiMode()`：
  - 直接切换 API 模式时，同步更新 `providerId + Base URL`。

### 4) 保存链路兼容自定义值

- 自定义提供商保存逻辑改为 `getSelectValueWithCustom()` 读取：
  - `custom_api`
  - `custom_default_model_id`
- 既支持预置联动，也支持自定义覆盖。

## 验证结果

1. 自动化：
- `node --check public/app.js` 通过
- `npm run test:unit` 通过（48/48）
- `npm run test:regression` 通过（3 pass / 1 skip）

2. Docker：
- `docker compose up -d --build panel` 成功

3. 运行态联动验证（DevTools）：
- 在 `custom_provider_id=aicodecat` 时切换模型：
  - Claude -> `anthropic-messages` + `https://aicode.cat`
  - GPT -> `openai-responses` + `https://aicode.cat/v1`
  - Gemini -> `google-generative-ai` + `https://aicode.cat/v1beta`
- 证据：`evidence/model-api-linkage-3.4-live.md`

## 与用户视角一致性

改造前：
- 自定义模式 API 模式需要手输，切换模型时 URL 不会自动跟，容易填错。

改造后：
- 模型一选，API 模式和 URL 自动联动；
- 仍保留自定义入口，不锁死高级用户。

## 结论

`3.4` 已完成并验证通过。模型与提供商页增强阶段（`3.1 ~ 3.4`）已全部闭环。
