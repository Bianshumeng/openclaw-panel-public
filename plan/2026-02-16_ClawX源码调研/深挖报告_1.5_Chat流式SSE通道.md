# 深挖报告 1.5：Chat 流式 SSE 通道

创建时间：2026-02-16 16:02:00（UTC+8）

## 目标
- 为面板提供稳定的 Chat 流式输出链路，补齐 `1.4` ACK-only 的缺口。
- 使用 SSE（服务端事件流）向前端持续推送 `delta/final/aborted/error`。
- 在 Gateway 短时断链场景下，保证自动重连，不让前端“卡发送态”。

## 本轮改动

### 后端
- `src/gateway-client.js`
  - 新增 `subscribeGatewayEvents(...)`：长连接订阅 Gateway 事件，支持 `connect.challenge` 握手。
  - 保留并复用设备身份签名与 token 回退逻辑。
- `src/chat-service.js`
  - 新增 `createChatEventSubscription(...)`：
    - 过滤指定 `sessionKey` 的事件；
    - 归一化 `chat`/`agent` 事件；
    - 在 `final/error/aborted` 时额外发出 `terminal` 事件。
- `src/server.js`
  - 新增 `GET /api/chat/stream`（SSE）：
    - 输出 `ready/status/chat/agent/terminal/stream-error/heartbeat`；
    - 内置 Gateway 断链自动重连（指数退避到 10s）。

### 前端
- `public/index.html`
  - 对话控制台新增：
    - `流式通道状态`
    - `重连流式通道` 按钮
    - `流式输出（SSE）` 面板
- `public/app.js`
  - 新增流式连接管理：
    - 切换会话自动重连 SSE；
    - 发送前确保流通道已连接；
    - 实时渲染 `chat/agent` 事件；
    - 终态后自动刷新历史。

## 验证证据
- 自动化测试
  - `npm run test`：通过
  - `npm run check`：通过
- Docker 联调
  - `docker compose up -d --build panel`：成功
- 运行态证据
  - `plan/2026-02-16_ClawX源码调研/evidence/chat-stream-sse-live.json`
  - 关键结果：
    - 事件计数包含 `chat`、`agent`、`terminal`
    - `sampleStates` 含 `delta -> final`
    - `terminalState = final`

## 风险与回滚
- 风险
  - 高并发多会话下，当前面板仍以“单会话流观察”为主（符合当前控制台定位）。
- 回滚
  - 回滚文件：
    - `src/gateway-client.js`
    - `src/chat-service.js`
    - `src/server.js`
    - `public/index.html`
    - `public/app.js`
  - 不涉及 OpenClaw 核心源码修改。

## Linux 可用性结论
- 方案基于 Docker 运行态联调完成，核心依赖是 Gateway WS + SSE；
- 不依赖 Windows 特有能力，Linux 生产环境可直接使用；
- 满足“外部端口可配置、容器内走内部网络”的既有约束。
