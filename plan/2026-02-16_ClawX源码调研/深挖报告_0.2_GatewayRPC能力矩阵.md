# 深挖报告 0.2：Gateway RPC 能力矩阵

创建时间：2026-02-16 13:25:00（UTC）

## 目标
- 验证当前 Docker 运行态下，后续迁移必须依赖的 Gateway RPC 方法是否真实可用。
- 输出方法可用性、延迟、返回结构、风险点，作为后续 0.3/0.4 的输入。

## 测试环境
- 开发环境：Windows 主机 + Docker 容器
- 目标运行：Linux 服务器（预装交付）
- 被测容器：
  - `openclaw-gateway`（`ghcr.io/openclaw/openclaw:2026.2.14`）
  - `openclaw-panel`（本项目）
- 网关地址：`ws://127.0.0.1:18789/ws`
- 鉴权方式：复用 OpenClaw 内置 `callGateway()` 客户端（与官方 CLI 一致链路）

## 方法与数据
- 每个方法执行 3 次，共 18 次调用。
- 会话使用隔离键：`agent:main:panel-probe-<timestamp>`，避免污染常规会话。
- 调用方法：
  - `sessions.list`
  - `chat.history`
  - `chat.send`
  - `chat.abort`
  - `skills.status`
  - `skills.update`

## 实测结果（摘要）
| 方法 | 成功率 | P95 延迟(ms) | 支持结论 | 备注 |
|------|------|-------------|---------|------|
| sessions.list | 100% (3/3) | 84 | 支持 | 返回 defaults + sessions |
| chat.history | 100% (3/3) | 63 | 支持 | 空会话返回稳定 |
| chat.send | 100% (3/3) | 82 | 支持 | 返回 `runId` + `status=started` |
| chat.abort | 100% (3/3) | 170 | 支持 | 可中止 probe run |
| skills.status | 100% (3/3) | 172 | 支持 | 返回技能清单（49项） |
| skills.update | 100% (3/3) | 138 | 支持 | 对不存在 skillKey 仍返回 `ok=true` |

## 关键观察
1. `chat.*` 与 `sessions.*`链路稳定，满足“多会话 + 流式前置能力”的接口门槛。
2. `skills.status`稳定可用，可作为 Skills 面板数据源。
3. `skills.update` 对不存在 `skillKey` 也返回成功，说明该接口更像“配置写入”而非“严格存在性校验”。
4. 风险：若前端不做技能存在性校验，可能出现“用户以为启停成功但目标技能不存在”的假成功体验。

## 设计影响
- `skills.update` 在控制台侧必须先校验 `skillKey` 是否存在于 `skills.status` 结果，再允许提交。
- `chat.send` 后必须跟踪 `runId`，并将 `abort` 与当前会话运行态关联，防止误中止。
- 会话页实现时需保留 `sessionKey` 作为主键，不得用展示名称替代。

## 结论
- 任务 `0.2 深挖 Gateway RPC 能力矩阵` 通过。
- 后续 0.3（流式状态机）和 0.4（Skills 权限/边界）可以进入执行。

## 证据
- 原始证据文件：`plan/2026-02-16_ClawX源码调研/evidence/gateway-rpc-matrix-live.json`

## Linux 兼容性说明（本轮）
- 本轮调用链使用 OpenClaw 官方 `callGateway()` 客户端，运行逻辑与 Linux 生产一致（同一网关协议和鉴权栈）。
- 但当前证据采集发生在 Windows 上的 Docker 容器中，下一步（0.5）必须在 Linux 场景补做同类稳定性验证并形成对照记录。
