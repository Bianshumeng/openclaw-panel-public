# 深挖报告 1.1：Gateway 适配层联调闭环

创建时间：2026-02-16 15:08:00（UTC+8）

## 目标
- 完成面板侧 Gateway 适配层（统一 RPC 调用、超时、重试、错误归一化）。
- 打通 Linux 容器真实链路：`openclaw-panel -> openclaw-gateway`。
- 关闭上一轮阻塞：`missing scope: operator.read`。

## 实施范围
- 代码文件：
  - `src/gateway-client.js`
  - `test/unit/gateway-client.test.js`
- 证据文件：
  - `plan/2026-02-16_ClawX源码调研/evidence/gateway-adapter-live.json`

## 根因链路（按出现顺序）
1. `missing scope: operator.read`
- 现象：`sessions.list` 实时调用失败。
- 根因：未携带 device 身份时，网关会把客户端声明 scope 清空，导致后续方法鉴权失败。
- 修复：在 `connect` 中补充 device 身份签名字段（deviceId/publicKey/signature/signedAt/nonce）。

2. `device nonce required`
- 现象：补 device 后首次握手仍失败。
- 根因：网关 challenge 事件帧类型为 `type: "event"`，适配层只识别了 `evt`，导致未取到 nonce。
- 修复：兼容 `event/evt` 两种事件帧类型，并在握手前短延迟等待 challenge（按 timeout 自适应）。

3. `invalid connect params: unexpected property 'nonce'`
- 现象：取到 nonce 后仍被拒绝。
- 根因：nonce 被放进 connect 顶层字段，协议仅允许放在 `device.nonce`。
- 修复：移除 connect 顶层 `nonce`，仅保留 `device.nonce`。

## 最终实现
- 新增/完善能力：
  - Gateway WS URL 解析（runtime + env 优先级）。
  - RPC 超时与重试机制。
  - 错误归一化（auth/network/timeout/protocol/remote）。
  - device 身份加载与签名握手：
    - 身份路径支持环境变量覆盖：`OPENCLAW_DEVICE_IDENTITY_PATH`
    - 默认按 OpenClaw 状态目录推导 `identity/device.json`
    - token 支持从 `identity/device-auth.json` 回退
  - `connect.challenge` 握手兼容。

## 验证结果
1. 自动化验证
- `npm run test`：通过（unit + regression）。
- `npm run check`：通过。

2. Linux 容器联调
- 重建：`docker compose up -d --build panel`
- 实测调用：容器内执行 `callGatewayRpc(method='sessions.list')`
- 结果：成功返回
  - 证据：`plan/2026-02-16_ClawX源码调研/evidence/gateway-adapter-live.json`
  - 摘要：`{"ok":true,"count":14,"sessionCount":14}`

## 结论
- `1.1 Gateway 适配层` 已闭环，可进入 `1.2 Dashboard 聚合服务层` 开发。
- 已满足“Windows 开发环境 + Linux 容器真实运行链路”的一致性门禁要求。
