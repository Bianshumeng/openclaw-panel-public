# 深挖报告 1.7：Chat 主页面用户化改造

创建时间：2026-02-16

## 本轮目标

将现有 `/chat-console` 从“工程调试页”升级为“用户主聊天页”，在用户视角尽量对齐 ClawX 的核心体验：

1. 多会话；
2. 流式回复；
3. 思考状态开关；
4. 停止回复；
5. 默认简洁、高级信息折叠。

## 实施范围

- 后端：
  - `src/chat-service.js`
  - `src/server.js`
  - `test/unit/chat-service.test.js`
- 前端：
  - `public/index.html`
  - `public/app.js`
  - `public/styles.css`

## 已完成能力

1. 新增会话创建接口：
   - `POST /api/chat/session/new`
   - 逻辑：复用 canonical 前缀生成新 key，调用 `sessions.reset(reason=new)` 创建会话。
2. 聊天页用户化：
   - 侧栏入口改名“智能对话”。
   - 页面默认展示会话、聊天消息、输入区。
   - “高级调试信息”折叠保存原始历史与 SSE 事件。
3. 消息渲染升级：
   - 历史消息与流式 `delta` 采用消息气泡展示。
   - `final/error/aborted` 会收敛发送态并刷新历史。
4. 交互增强：
   - 新建会话按钮；
   - Enter 发送、Shift+Enter 换行；
   - 发送中按钮态和 Stop 按钮联动；
   - thinking 展示开关（仅影响显示层）。

## 与 ClawX 的差异（仍未完全一致）

1. 附件交互：ClawX 支持拖拽/粘贴/附件预览，本项目当前仅文本发送。
2. 富文本渲染：ClawX 聊天消息支持更完整的 Markdown/工具结果展现；本项目当前为纯文本消息体。
3. 会话工具栏：ClawX 的会话项包含更细状态与交互细节（如更完整的会话标签行为），本项目当前是简化版下拉切换。
4. 错误提示：本项目仍使用全局操作时间线提示，尚未做到字段级/局部提示。

## 验证证据

1. 自动化：
   - `npm run test:unit` 通过（含新增 `createChatSession` 用例）。
   - `npm run test:regression` 通过。
2. Docker：
   - `docker compose up -d --build panel` 重建成功。
3. 运行态：
   - `evidence/chat-session-new-live.json`
   - `evidence/chat-user-workspace-live.md`

## 结论

本轮已完成“从控制台到主聊天页”的第一阶段迁移，核心用户路径可用。  
若要进一步逼近 ClawX 体验，下一优先级应是：附件能力 + 消息富渲染 + 局部错误提示。
