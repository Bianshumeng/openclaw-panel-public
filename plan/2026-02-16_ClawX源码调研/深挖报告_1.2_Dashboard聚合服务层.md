# 深挖报告 1.2：Dashboard 聚合服务层

创建时间：2026-02-16 15:13:00（UTC+8）

## 目标
- 新增统一聚合服务，后端一次性输出仪表盘所需核心数据结构。
- 避免前端继续分散拼接“模型 / 渠道 / Skills / 运行态”多来源数据。
- 保持插件式控制架构：只通过控制层读写，不改 OpenClaw 核心源码。

## 实施范围
- 新增：
  - `src/dashboard-service.js`
  - `test/unit/dashboard-service.test.js`
- 修改：
  - `src/server.js`（新增 `GET /api/dashboard/summary`）
- 验证证据：
  - `plan/2026-02-16_ClawX源码调研/evidence/dashboard-summary-live.json`

## 设计说明
1. 聚合来源
- 模型与渠道配置：复用 `extractSettings(openclawConfig)`。
- 渠道运行态：Gateway RPC `channels.status`。
- Skills 状态：Gateway RPC `skills.status`。
- 网关服务运行态：`runServiceAction("status")`。

2. 可靠性策略
- Gateway 调用统一使用重试窗口（约 10~15 秒）：
  - `timeoutMs=1000`
  - `retries=6`
  - `retryDelayMs=1000`
- 单路失败不拖垮整体：`channels.status` / `skills.status` 使用 `Promise.allSettled`，失败时降级输出 `ok=false + message`。

3. 输出结构（核心）
- `summary.model`：当前模型、提供商统计、模型清单。
- `summary.channels.configured`：配置态（是否启用等）。
- `summary.channels.runtime`：运行态（configured/running/lastError）。
- `summary.skills`：总数、启用数、可用数、阻断数、列表。
- `summary.runtime`：服务运行态（ok/active/mode/message）。

## 验证结果
1. 自动化测试
- `npm run test`：通过（新增 `dashboard-service` 单测）。
- `npm run check`：通过。

2. Docker 运行态验证
- 重建 `panel`：`docker compose up -d --build panel`
- 接口验证：
  - 宿主机：`http://127.0.0.1:18080/api/dashboard/summary` 返回 200
  - 容器内：`openclaw-panel` 内 `fetch('/api/dashboard/summary')` 返回 200
- 证据摘要：
  - `modelProviders=4`
  - `modelTotal=7`
  - `skillsTotal=53`
  - `runtimeActive=true`

## 结论
- `1.2 Dashboard 聚合服务层` 已完成并可在 Linux 容器运行。
- 可以进入 `1.3 Skills 服务层`，把 Skills 查询/启停/配置回写拆成独立服务边界。
