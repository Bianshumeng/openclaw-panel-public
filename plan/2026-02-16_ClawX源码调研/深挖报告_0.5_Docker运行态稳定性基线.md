# 深挖报告 0.5：Docker 运行态稳定性基线（重启/断网/升级后）

创建时间：2026-02-16 14:50:00（UTC+8）

## 目标
- 验证当前 Docker 运行态在以下三类扰动后的恢复能力：
  - 网关容器重启
  - 网关网络断开后恢复
  - 升级流程执行后恢复
- 给后续 Chat/Skills（依赖容器内网 DNS）的实现提供真实恢复窗口数据。

## 测试环境
- 宿主环境：Windows + Docker Desktop
- 容器环境（Linux）：
  - `openclaw-panel`（`openclaw-panel:local`）
  - `openclaw-gateway`（`ghcr.io/openclaw/openclaw:2026.2.14`）
- 内部网络：`openclaw-internal`
- 执行脚本：`plan/2026-02-16_ClawX源码调研/evidence/docker-stability-probe-live.mjs`
- 原始证据：`plan/2026-02-16_ClawX源码调研/evidence/docker-stability-live.json`

## 测试矩阵
1. 基线探测
- `/api/health`
- `/api/service/status`
- `/api/update/check`
- `http://127.0.0.1:18789/`（网关主页）
- `docker inspect` 网关运行态
- `openclaw-panel` 容器内访问 `http://openclaw-gateway:18789/`（内部 DNS）

2. 重启恢复
- `docker restart openclaw-gateway`
- 每秒探测一次，直到全部指标恢复

3. 网络隔离恢复
- `docker network disconnect -f openclaw-internal openclaw-gateway`
- 隔离期间采样一次
- `docker network connect openclaw-internal openclaw-gateway`
- 每秒探测一次，直到全部指标恢复

4. 升级流程回放
- 调用 `POST /api/update/upgrade`（目标版本使用当前 `2026.2.14`，做无版本变化的流程回放）
- 先采样一次，再每秒探测恢复

## 结果摘要
| 项目 | 结果 | 关键数据 |
|------|------|---------|
| 基线 | 通过 | panel/gateway/内部 DNS 全部可达 |
| 重启恢复 | 通过 | 恢复成功；`3` 次探测后恢复（约 3 秒） |
| 网络隔离恢复 | 通过 | 隔离时内部 DNS 失败；重连后 `1` 次探测即恢复 |
| 升级流程回放 | 通过 | 升级 API 成功；整体恢复成功，但内部 DNS 恢复用了 `10` 次探测（约 10 秒） |

补充版本信息（来自证据）：
- 当前版本：`2026.2.14`
- 最新版本：`2026.2.15`

## 关键观察
1. `service/status` 与 `update/check` 在网关重启后很快恢复为“active=true”，但**容器内 DNS 可达性会滞后数秒**。
2. 升级流程（即使目标版本不变）会触发网关容器重建，重建后内部 DNS 可达恢复比“单纯 restart”更慢（本次约 10 秒）。
3. 网络隔离期间，外部端口映射下的网关主页仍可访问，但容器内 DNS 访问失败，符合“外部映射与内部网络是两套链路”的预期。

## 对后续实现的硬约束
1. Chat/Skills 网关调用前置健康门：
- 容器重启/升级后，前端和后端都必须允许 10~15 秒重试窗口；
- 不要把“第一次内网调用失败”直接当成永久故障。

2. 统一重试策略：
- 内部 RPC 调用建议至少 `10` 次重试，间隔 `1s`，并带用户可见状态（例如“网关正在恢复连接...”）。

3. 升级后冷却期：
- 升级动作返回成功后，仍需做一次内部连通性探测再开放 Chat/Skills 操作入口。

## 结论
- 任务 `0.5 深挖 Docker 运行态稳定性基线` 达成。
- 当前架构在“重启/断网/升级”后能恢复，但存在明确的“内部 DNS 恢复滞后窗口”。
- 可进入下一步 `0.6 Win 开发环境到 Linux 生产环境一致性门禁清单`。
