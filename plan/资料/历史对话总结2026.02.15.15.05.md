# 大盘鸡项目历史对话增量归档（截至 2026-02-15 15:05）

## 1. 本轮到目前为止做了什么
- 梳理了当前业务架构：
  - 日本机作为公网入口；
  - 通过 WG 回源芬兰母鸡；
  - 芬兰母鸡按端口映射到小鸡内网。
- 明确了端口策略：
  - 售卖小鸡端口池固定为 `10000-20000`；
  - 模板机迁移到保留端口 `9900`，避免与售卖池冲突。
- 处理了 bot 一次性密码“看似成功但实际不可用”的根因问题（不是端口映射问题）：
  - 根因是模板或目标 VM 缺少 cloud-init 就绪条件，`cipassword` 无法可靠生效。
- 在 `pve-vm-bot` 仓库完成了代码修复、测试、提交与推送。
- 新增了模板小鸡 SSH MCP（`ssh-template-vm`），并已实测可直连。
- 更新了本目录 `AGENT.md`，把 `ssh-template-vm` 写入“当前已接入机器”清单。

## 2. 已完成项（可复核）
### 2.1 pve-vm-bot 代码修复已完成
- 仓库：`E:/AAA__ZhuoMian/大盘鸡/pve-vm-bot`
- 修复点：
  - `cloneAndBoot` 前增加模板 cloud-init readiness 校验；
  - `setRootPassword` 前增加目标 VM cloud-init readiness 校验；
  - 缺失时直接报错，阻断“无效一次性密码”继续下发。
- 测试：新增并通过 cloud-init 缺失/存在的单测。
- 校验命令：`npm run check`（syntax/test/security 全通过）。
- 提交与推送：
  - commit: `cf8b11b`
  - branch: `main`
  - push: `origin/main` 成功。

### 2.2 连接与文档已完成
- MCP：`ssh-template-vm` 已创建并启用（目标 `135.181.162.231:9900`）。
- 实测：可执行 `hostname/whoami/uname`，确认目标是 `OpenClaw001`。
- 文档：`AGENT.md` 已同步模板机连接信息。

### 2.3 现场体检结果（刚刚）
- 模板小鸡（OpenClaw001，Debian 13）当前状态：
  - `cloud-init`: missing
  - `qemu-guest-agent`: missing
- 芬兰母鸡上模板 VM（VMID=100）当前 `qm config`：
  - `ide2` 仍是安装 ISO（`local:iso/debian-13.3.0-amd64-DVD-1.iso`），
  - 尚未挂 `cloudinit` 盘。

## 3. 未完成项（下一步必须做）
1. 在模板小鸡 VM（100）内安装并初始化 cloud-init 与 qemu-guest-agent。
2. 在芬兰母鸡把 VM 100 的 `ide2` 从 ISO 改为 `cloudinit` 盘，并启用 qemu agent。
3. 做一次最小克隆验收：
   - 克隆测试 VM；
   - 注入一次性密码/IP/DNS；
   - 验证可登录且参数生效。
4. 把这套“模板初始化 + 验收”固化成可复用脚本或 SOP，避免后续重复踩坑。

## 4. 风险与注意事项
- 当前最大风险不是端口映射，而是模板云初始化条件不完整。
- 若继续用当前模板批量开机，仍可能出现“一次性密码不生效”的投诉。
- 一次性密码已在对话中暴露过，生产环境必须轮换。

## 5. 结论（给后续会话快速接手）
- bot 代码层面的“误报成功”已修复。
- 基础设施层面的 cloud-init 仍未落地，下一步优先做模板云初始化。
- 当前会话已具备直接操作模板机能力（`ssh-template-vm` 可用）。

---

## 6. 本轮后续执行结果（2026-02-15 15:10 追加）

### 6.1 已执行并完成
- 模板小鸡（VM 100）内部已安装：
  - `cloud-init 25.1.4`
  - `qemu-guest-agent`
- 已完成模板化清理动作：
  - `cloud-init clean --logs --seed`
  - `/etc/machine-id` 清空
  - SSH host keys 删除（用于后续克隆自动生成唯一主机指纹）
  - 写入 `/etc/cloud/cloud.cfg.d/99-pve.cfg`：`datasource_list: [ NoCloud, ConfigDrive ]`
- 芬兰母鸡 VM 100 配置已改为 cloud-init 就绪：
  - `ide2: local:100/vm-100-cloudinit.qcow2,media=cdrom,size=4M`
  - `agent: enabled=1`
  - `ciuser: root`
  - `nameserver: 1.1.1.1`
  - `searchdomain: local`
- 已验证可生成 cloud-init 数据：
  - `qm cloudinit dump 100 user`
  - `qm cloudinit dump 100 network`
  均可正常输出。

### 6.2 仍待完成（下一步）
1. 做一次最小克隆验收（从 100 克隆测试 VM）：
   - 下发 `cipassword/ipconfig/nameserver`
   - 验证新 VM 可登录，确认一次性密码链路恢复。
2. 若确认稳定，再把模板固化流程做成脚本/SOP 并接入 bot 的 ops 检查。

### 6.3 备注
- 在模板机里执行 `cloud-init status` 显示 `disabled-by-generator` 是当前模板运行态常见现象（当前实例未挂载有效 datasource 时会这样）；关键是克隆实例启动后能读取 `NoCloud` 数据，`qm cloudinit dump` 已证明母鸡侧数据盘生成链路正常。
