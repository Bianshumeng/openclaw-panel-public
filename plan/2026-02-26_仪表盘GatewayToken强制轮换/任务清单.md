# 任务清单

## 1. 准备阶段
- [x] 1.1 阅读现有规格 `plan/规格/OpenClaw面板.md`
- [x] 1.2 检查 `plan/` 目录确认无冲突任务

## 2. 实现阶段
- [x] 2.1 后端改为每次点击强制轮换 Gateway Token | 验收：`/api/gateway/token/sync` 返回新 token 且不复用旧值
- [x] 2.2 仪表盘文案与按钮改为“重置 Token”语义 | 验收：页面显示“重置”并提示需在 Control UI 更新
- [x] 2.3 新增单测覆盖 token 轮换逻辑 | 验收：新增测试用例可独立执行通过

## 3. 验证阶段
- [x] 3.1 单元测试通过（含新增 `gateway-token` 用例）
- [x] 3.2 回归测试通过（`npm test`）
- [x] 3.3 场景验收通过（对照规格变更中的场景）

## 4. 收尾阶段
- [x] 4.1 更新规格文档（合并变更到 `plan/规格/`）
- [ ] 4.2 归档本次任务（移动到 `plan/归档/`）

## 经验记录

### 步骤 2.1 完成记录
- 实际情况：原逻辑会优先读取现有 token 并复用，无法满足 token mismatch 场景的强制轮换需求。
- 遇到问题：server 内部逻辑耦合在单文件，不利于单测；已抽离为 `src/gateway-token.js`。
- 技术债：暂未打通“重置后自动把 token 下发到外部 Control UI”，仍需手工粘贴。

### 步骤 2.2 完成记录
- 实际情况：仪表盘按钮改为“重置 Token”语义，状态提示明确告知“需要在 Control UI 更新新 Token”。
- 遇到问题：前端初始文案与旧行为绑定，已同步替换为强制轮换语义。
- 技术债：暂无新增高优先级项。

### 步骤 2.3 完成记录
- 实际情况：新增 `test/unit/gateway-token.test.js`，覆盖生成格式、强制轮换、缺失 auth 初始化、异常分支。
- 遇到问题：为提升可测性新增独立模块，避免直接在 `server.js` 做黑盒测试。
- 技术债：后续可补接口级集成测试，验证 `/api/gateway/token/sync` 的完整返回结构。

### 步骤 3.1 完成记录
- 实际情况：`npm run test:unit` 通过，95/95 全绿，新增 token 轮换用例已纳入。
- 遇到问题：无。
- 技术债：无新增高优先级项。

### 步骤 3.2 完成记录
- 实际情况：`npm test` 通过（unit + regression），回归链路正常。
- 遇到问题：无。
- 技术债：无新增高优先级项。

### 步骤 3.3 完成记录
- 实际情况：对照规格场景核对代码行为，点击重置后必定生成新 token，并在 UI 提示更新 Control UI。
- 遇到问题：暂无自动化 E2E 覆盖该按钮到浏览器端交互流程。
- 技术债：后续可补充 Playwright 场景回归。

### 步骤 4.1 完成记录
- 实际情况：已将“Gateway Token 强制轮换”需求合并到 `plan/规格/OpenClaw面板.md`。
- 遇到问题：无。
- 技术债：待任务确认后执行 4.2 归档。
