# 技术设计

## 背景与约束
- 目标环境：Debian 13（Trixie），典型规格 2C2G。
- 部署形式：非 Docker，预装在模板小鸡中。
- 安全基线：面板默认监听 `127.0.0.1`，公网入口由反代统一控制。
- 兼容要求：OpenClaw 配置路径、服务名、日志来源必须可配置，不能硬编码。

## 目标
- 构建单机可用的 OpenClaw 可视化面板 MVP。
- 让用户无需命令行即可完成配置、启停、排障、渠道测试。

## 不做（Non-Goals）
- 不做多租户 SaaS 总控
- 不做自动售卖开机链路集成
- 不做 OpenClaw 核心协议改造

## 技术决策
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 后端栈 | Node.js + Fastify | 与 OpenClaw 同运行时，降低模板依赖复杂度 | Go（额外构建链路） |
| 前端栈 | 原生 HTML/CSS/JS | 体积小、启动快、内存低 | React/Vue（额外构建与运行负担） |
| 服务控制 | 调用 `systemctl` | Debian 13 标准做法，集成成本低 | 自建守护进程 |
| 日志读取 | `journalctl` + 文件 tail 兜底 | 兼容 systemd 与文件日志两类场景 | 仅文件日志 |
| 实时日志 | SSE（Server-Sent Events） | 简单稳定、浏览器原生支持 | WebSocket（复杂度更高） |

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| OpenClaw 配置结构随版本变化 | 仅维护 MVP 关键字段，并保留原始 JSON 读取能力 |
| systemd 权限不足 | 返回清晰错误并在部署文档要求服务用户权限 |
| 日志流资源占用 | 限制默认 tail 行数与刷新频率，连接关闭即释放进程 |
| 敏感信息泄露 | 回显时掩码，落盘文件权限收敛到 600 |

## 迁移/回滚方案
- 迁移步骤：
  - 部署面板代码
  - 生成默认面板配置
  - 配置并启动面板服务
- 回滚步骤：
  - 停止面板服务
  - 恢复 OpenClaw 配置备份
  - 切回命令行运维
- 验证方式：
  - 页面配置写入成功
  - 服务状态可查询
  - 日志流可显示
  - 渠道测试可返回结果

