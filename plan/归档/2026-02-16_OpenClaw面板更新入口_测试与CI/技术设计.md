# 技术设计

## 背景与约束
- 面板目前运行在 Docker 容器内，通过 Docker Socket 控制 `openclaw-gateway`。
- 需要在不暴露基础设施细节给终端用户的前提下，提供升级与回滚入口。
- 必须保留失败自动回滚，避免“点升级直接炸服”。

## 目标
- 提供可视化版本管理闭环：检查更新、升级、回滚。
- 提供最小但可执行的测试体系与 CI/CD。

## 不做（Non-Goals）
- 不做多 Bot 调度编排。
- 不做跨主机集群更新。

## 技术决策
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 更新实现方式 | 后端直接调用 Docker CLI，按容器 inspect 信息重建容器 | 不依赖宿主 `docker compose` 路径语义，容器内可执行 | 在容器内执行 compose 脚本（路径映射不稳定） |
| 版本检查源 | GitHub Releases API（openclaw/openclaw） | 数据直观，含 tag 与发布时间 | 仅本地镜像列表（拿不到最新信息） |
| 测试框架 | Node 内置 `node:test` | 轻量，无额外运行时开销 | 引入 Jest/Vitest（增加依赖与构建成本） |
| CI/CD 平台 | GitHub Actions | 与仓库托管一致，维护成本最低 | 自建 Runner 流水线 |

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| Docker 权限操作失败 | 每步捕获错误并返回可读信息 |
| 升级后容器起不来 | 自动回滚到旧镜像 |
| 远程版本查询失败 | 降级返回“仅显示当前版本” |
| API 被误调用 | 仅保留本地访问路径，部署层继续反代鉴权 |

## 迁移/回滚方案
- 迁移步骤：
  1. 部署新面板版本
  2. 用户在面板点击检查更新/升级
  3. 后端执行拉镜像并重建容器
- 回滚步骤：
  1. 自动回滚（升级失败触发）
  2. 或手动回滚到指定 tag
- 验证方式：
  - API 调用结果 + `docker inspect` 运行态 + 页面提示
