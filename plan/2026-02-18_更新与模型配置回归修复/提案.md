# 更新与模型配置回归修复

创建时间：2026-02-18 00:00:00

## 为什么做
- 评审已确认 4 个可复现回归：更新应用流程在慢机误失败、模型 ID 切换后字段串值、模板模型名滞留、更新异常时进度条不收口。
- 这些问题会直接造成错误写配置或错误引导用户，属于必须立即修复的功能性缺陷。

## 改什么
- 修复 `src/docker-update.js` helper 脚本的 sleep 实现，确保轮询间隔真实等待。
- 加固 `src/docker-update.js` 更新链路可靠性：
  - GHCR 查询遇到 401/403 时，支持匿名 token 回退，避免失效 token 导致检查更新整体失效。
  - 控制台 `apply` 走 helper 重建时，增加失败回滚计划（回退旧镜像）并优先使用旧镜像启动 helper。
- 修复 `public/js/pages/model-dashboard-page.js`：
  - 选择已有供应商模型 ID 变化时，刷新模型名称/上下文/最大输出。
  - 模板路径切换模型 ID 时，正确刷新默认模型名，避免旧名残留。
- 修复 `public/js/pages/system-page.js`：当更新请求抛异常时，强制结束进度 ticker 并标记失败。

## 影响范围
- 涉及模块：Docker 更新执行、模型配置前端页、系统更新前端页
- 涉及接口：无新增接口；修复现有交互行为
- 风险等级：L1

## 不做什么（边界）
- 不改动现有更新 API 协议和返回结构。
- 不引入新的模型配置字段或页面结构重构。
- 不调整版本发布流程。

## 验证（存在风险时必填）
- `node --check` 校验变更文件语法。
- `npm run test:unit` 回归单元测试。
- API 烟雾验证：`/api/update/check`、`/api/update/upgrade` 异常路径可返回明确错误。
- 手工回放：切换模型 ID 后观察字段是否同步；触发更新异常确认进度条收口。

## 回滚（存在风险时必填）
- 回滚触发条件：修复后出现更新流程阻断或模型保存异常。
- 回滚步骤：回退本次三个文件改动并重启面板容器。
