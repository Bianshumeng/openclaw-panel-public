# 任务清单

## 1. 准备阶段
- [x] 1.1 阅读现有规格 `plan/规格/OpenClaw面板.md`
- [x] 1.2 确认 `plan/` 目录下没有冲突的进行中任务

## 2. 实现阶段
- [x] 2.1 线上采证并止血（101 pending 设备配对审批） | 验收：`openclaw devices list` 从 Pending 变为 Paired
- [x] 2.2 新增后端配对自愈能力（读取 pending + 批准） | 验收：接口返回 approvedCount，失败时返回可读错误
- [x] 2.3 仪表盘新增“批准待处理配对”按钮并接入新接口 | 验收：前端可触发并展示审批结果
- [x] 2.4 仪表盘新增“重启网关服务”按钮并接入现有重启链路 | 验收：前端可触发并展示重启结果

## 3. 验证阶段
- [x] 3.1 单元测试通过（覆盖配对审批成功/失败/空 pending）
- [x] 3.2 集成测试通过（接口到页面动作链路可执行）
- [x] 3.3 场景验收通过（对照规格变更场景）

## 4. 收尾阶段
- [x] 4.1 更新规格文档（合并变更到 `plan/规格/`）
- [ ] 4.2 归档本次任务（移动到 `plan/归档/`）

## 经验记录

### 步骤 2.1 完成记录
- 实际情况：服务未挂，核心故障是设备处于 pending 未批准。
- 遇到问题：用户误以为“重生 token 就能恢复”，实际要先审批配对请求。
- 技术债：面板缺“pending 配对审批”入口，导致同类问题会重复人工登录处理。

### 步骤 2.2 完成记录
- 实际情况：后端通过 `openclaw devices list --json` + `openclaw devices approve <requestId>` 已形成可复用闭环。
- 遇到问题：`devices list` 需解析 JSON，且要兼容 docker CLI 回退场景。
- 技术债：目前审批为串行执行，若后续 pending 很多可评估批处理与并发上限。

### 步骤 2.3 完成记录
- 实际情况：仪表盘已新增“批准待处理配对”按钮，并展示 pending/approved/failed 结果。
- 遇到问题：原页面只存在 Token 状态提示，需新增独立网关运维状态提示避免信息冲突。
- 技术债：当前仅在仪表盘提供入口，后续可在“服务控制”页增加同能力。

### 步骤 2.4 完成记录
- 实际情况：仪表盘已新增“重启网关服务”按钮，复用 `/api/service/restart` 现有链路。
- 遇到问题：`openclaw gateway restart` 在 root 执行会遇到 user scope bus 限制，因此不走该命令。
- 技术债：可后续补充“重启后自动健康检查”联动，减少用户二次点击验证。

### 步骤 3.1 完成记录
- 实际情况：新增 `approvePendingGatewayPairings` 的三条单测（成功/空 pending/部分失败），全部通过。
- 遇到问题：需要兼容 docker CLI 回退时的输出结构，因此在 CLI 结果中补了 `stdout/stderr/message` 字段。
- 技术债：后续可补“pending 缺 requestId”的专门异常单测。

### 步骤 3.2 完成记录
- 实际情况：执行 `npm run test`（unit + regression）全绿，跨模块链路未回归。
- 遇到问题：无。
- 技术债：无新增高优先级项。

### 步骤 3.3 完成记录
- 实际情况：按 BDD 场景核对通过：有 pending 可审批、无 pending 空操作、网关重启可触发并回显结果。
- 实际情况补充：本地启动面板后，通过浏览器快照确认仪表盘出现“批准待处理配对/重启网关服务”按钮，并验证失败态提示可见。
- 遇到问题：现场故障与旧案例相似但根因不同，已新增 101 案例并更新总目录。
- 技术债：可在后续加入“审批后自动刷新配对列表与健康状态”的组合动作。

### 步骤 4.1 完成记录
- 实际情况：已将规格变更合并到 `plan/规格/OpenClaw面板.md` 主文档。
- 遇到问题：无。
- 技术债：4.2 归档尚未执行，待你确认本次交付无追加修改后再归档。
