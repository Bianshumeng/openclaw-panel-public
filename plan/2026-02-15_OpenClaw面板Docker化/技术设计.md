# 技术设计

## 背景与约束
- 目标平台：Debian 13 模板机
- 当前实现依赖：`systemd` 服务控制、`journalctl` 日志读取
- 目标要求：容器化运行、低资源占用、可控升级与回滚

## 目标
- 双容器稳定运行：`openclaw` + `panel`
- 面板保持现有功能：配置中心、服务控制、日志排障
- 支持受控版本更新（固定 tag，不追 `latest`）

## 不做（Non-Goals）
- 不实现多 Bot UI 与编排
- 不引入 Kubernetes 或重型编排

## 技术决策
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 容器组织 | 双容器 compose | 进程边界清晰、升级/回滚独立 | 单容器双进程（耦合高） |
| 服务控制 | Docker Runtime 适配层 | 与现有 API 兼容，最小侵入 | 继续硬编码 systemd |
| 日志来源 | `docker logs` + 流式跟随 | 统一容器语义 | 仅保留 journal/file |
| 更新策略 | 受控 tag + 版本清单 | 可预测、可回滚 | 直接追 `latest` |

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| Docker socket 暴露导致权限过大 | 面板仅内网访问 + 反代鉴权 + 最小暴露端口 |
| 上游版本变更导致配置字段漂移 | 发布前验收脚本 + 固定 tag 放行 |
| 升级失败影响在线可用 | 升级前备份 + 自动回滚到上个稳定 tag |

## 迁移/回滚方案
- 迁移步骤：
  1. 准备 compose 与面板镜像
  2. 挂载 OpenClaw 配置卷
  3. 启动 `docker compose up -d`
  4. 面板切换 runtime 到 `docker`
- 回滚步骤：
  1. 将镜像 tag 切回上一个稳定版本
  2. `docker compose up -d`
  3. 核验健康与配置
- 验证方式：
  - `docker compose ps`
  - 面板服务控制接口成功
  - 面板日志流可持续输出
