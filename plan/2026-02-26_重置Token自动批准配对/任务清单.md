# 任务清单

## 1. 准备阶段
- [x] 1.1 阅读现有规格 `plan/规格/OpenClaw面板.md`
- [x] 1.2 确认 `plan/` 目录下没有冲突的进行中任务

## 2. 实现阶段
- [x] 2.1 后端将 token 重置与 pending 配对审批合并为一次动作 | 验收：`/api/gateway/token/sync` 返回 token + autoApprove 结果
- [x] 2.2 仪表盘重置按钮展示自动审批结果 | 验收：重置后可看到 pending/approved/failed 状态
- [x] 2.3 新增单测覆盖自动审批链路 | 验收：新增测试可独立运行通过

## 3. 验证阶段
- [x] 3.1 单元测试通过（含新增用例）
- [x] 3.2 回归测试通过（`npm test`）
- [x] 3.3 场景验收通过（对照规格变更中的场景）

## 4. 收尾阶段
- [x] 4.1 更新规格文档（合并变更到 `plan/规格/`）
- [ ] 4.2 归档本次任务（移动到 `plan/归档/`）

## 经验记录

### 步骤 2.1 完成记录
- 实际情况：新增 `rotateGatewayTokenAndApprovePairings` 复合动作，`/api/gateway/token/sync` 已返回 `autoApprove`。
- 遇到问题：需要保证“Token 已重置”与“配对审批失败”可同时反馈，不能用单一失败态覆盖。
- 技术债：暂无新增高优先级项。

### 步骤 2.2 完成记录
- 实际情况：前端重置按钮成功后直接展示自动审批结果，并把按钮文案改为“重置并自动批准”。
- 遇到问题：需要与手动审批按钮状态文案共存，避免提示互相覆盖。
- 技术债：后续可考虑把自动审批的详细失败项展开显示。

### 步骤 2.3 完成记录
- 实际情况：`gateway-token` 单测新增复合动作成功与审批异常降级两条用例。
- 遇到问题：服务端入口不易直接单测，改为抽取纯函数保证可测性。
- 技术债：后续可补接口级集成测试。

### 步骤 3.1 完成记录
- 实际情况：`npm run test:unit` 通过，新增用例纳入后总计 97 条单测全绿。
- 遇到问题：无。
- 技术债：无新增高优先级项。

### 步骤 3.2 完成记录
- 实际情况：`npm test` 全绿（unit + regression），回归链路通过。
- 遇到问题：无。
- 技术债：无新增高优先级项。

### 步骤 3.3 完成记录
- 实际情况：按场景核对代码路径，重置后会返回自动审批结果并在仪表盘展示。
- 遇到问题：目前仍需用户在 Control UI 粘贴新 token，未实现跨系统自动写入。
- 技术债：后续可评估对接 Control UI API 自动同步 token（若上游提供接口）。

### 步骤 4.1 完成记录
- 实际情况：规格主文档已补充“重置后自动批准待处理配对”场景。
- 遇到问题：无。
- 技术债：4.2 归档待发版确认后执行。
