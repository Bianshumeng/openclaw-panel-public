# 任务清单（目标锚定版）

## 0. 背景、想法与真实意图（防偏离锚点）

### 0.1 背景事实
- 已发生公网扫描/爆破流量，管理面暴露导致稳定性与安全风险上升。
- 现有流程里存在“模板更新后新机仍可能继承旧状态”的交付不确定性。
- 用户实际体验存在摩擦：连接链路步骤多、容易在 token/鉴权环节误操作。
- 你已明确：业务端口必须保留，不接受“一刀切封网”。

### 0.2 你的想法（执行方向）
- 管理面安全要收紧（密钥、token、限速），业务面可用性不能被牺牲。
- 鉴权流程要简化，但不能裸奔。
- 模板交付必须可验证，不能靠“我以为更新了”。
- 部署体系要从 Docker 主路径逐步迁移到直装主路径，并可回滚。

### 0.3 最终目标（必须达成）
- G1：每台小鸡保留约 50 个业务端口可用。
- G2：管理面 SSH 仅密钥登录，禁用密码登录。
- G3：管理 Web 统一 Gateway Token 鉴权，减少手工输入。
- G4：每台新小鸡生成两枚独立 Token（`panel_token`、`gateway_token`），`VM_READY` 明文回传并可直接使用。
- G4.1：`VM_READY` 仅输出 SSH 连接脚本与本地隧道访问地址，不输出管理 Web 公网地址字段。
- G5：模板版本可验证，克隆后门禁阻断旧版本交付。
- G6：完成“先备份、后迁移、可回滚”的 Docker -> 直装迁移路径。
- G7：可视化控制台适配直装路径，用户尽量不需要手敲 SSH/TUI。

## 1. 不允许偏离的硬约束
- [x] C1 保留业务端口池（约 50 端口），不做全封公网。
- [x] C2 限速/封禁仅针对管理面端口，不误伤业务端口。
- [x] C3 迁移前必须完整备份并可校验，未备份不得删旧运行时。
- [x] C4 鉴权简化不等于取消鉴权，必须保留 token 安全边界。
- [x] C5 版本不一致必须阻断成功交付，不允许“带病上线”。
- [x] C6 保持端口分配规律不变（`SSH=port_start`、`+1/+2` 为管理 Web）；仅移除管理 Web 公网输出，不改 50 端口块策略。

## 2. 任务与目标对齐矩阵（防“只做任务不达目标”）

| 任务组 | 对齐目标 | 通过标准 |
|---|---|---|
| 管理面 SSH 改造 | G2, G1 | 密码登录失败、密钥登录成功；业务端口抽测通过 |
| 管理面限速与封禁 | G1, G2 | 管理端口命中限速；业务端口无误伤 |
| Token 唯一化与回传 | G3, G4 | 连续两台小鸡两枚 token 均不同；`VM_READY` 两枚 token 与运行态一致 |
| VM_READY 输出收敛 | G4.1 | 只含 SSH/本地隧道地址；不含管理 Web 公网地址字段 |
| 模板版本门禁 | G5 | 旧版本克隆被阻断；成功机版本可追溯 |
| 101 迁移演练 | G6 | 迁移后核心功能可用；回滚可执行 |
| 控制台直装改造 | G7, G6 | 无 Docker 仍可运维；更新链路可用 |

## 3. 实施顺序清单（按你确认的优先级）

## 3.0 优先主线（先后顺序固定）
1. 先做去 Docker 化（先在 101 小鸡，且直接在虚拟机环境部署，不做本地假演练）。
2. 101 验证通过后，把迁移流程固化成标准流程。
3. 按固化流程批量重复到已开小鸡用户。

## 3.1 阶段 A：去 Docker 化优先（101 先行，强制门禁）
- [x] A1 锁定 101 作为唯一试点，并确认“直装部署”为目标运行态（非本地部署）  
  验收：试点范围与窗口落盘并确认  
  对齐：G6, G7
- [x] A2 全量备份与校验（配置、凭据、会话、日志、用户附加数据）  
  验收：备份包 + hash + manifest 完整  
  对齐：G6
- [ ] A3 停止并清理 Docker 版（仅备份成功后）  
  验收：旧服务可控下线，未发生数据损失  
  对齐：G6
- [x] A4 安装直装版并恢复数据  
  验收：核心链路可用（Gateway/Telegram/配置读写）  
  对齐：G6
- [ ] A5 回滚演练（恢复 Docker 版）  
  验收：回滚步骤可重复执行  
  对齐：G6

## 3.2 阶段 B：101 通过后流程固化（形成可复制标准）
- [x] B1 固化迁移 SOP（前置检查、执行步骤、验收步骤、回滚步骤）  
  验收：SOP 文档可直接用于第二台小鸡  
  对齐：G6
- [x] B2 固化控制台侧直装运维能力（路径、服务控制、更新逻辑）  
  验收：无 Docker 条件下可运行，启停/状态/更新可用  
  对齐：G7, G6
- [ ] B3 固化输出契约（`VM_READY` 仅输出 SSH + 两个本地隧道 URL，且 URL 已预拼接各自 token）  
  验收：不再出现管理 Web 公网地址字段；用户复制链接可直接访问；控制台无 token 返回 `401/403`，OpenClaw UI 交互保持原生  
  对齐：G3, G4, G4.1
- [ ] B4 固化安全与一致性门禁（SSH 密钥化、token 唯一化、模板版本门禁）  
  验收：门禁清单可执行并能阻断不合规交付  
  对齐：G2, G4, G5

## 3.3 阶段 C：批量迁移已开小鸡（按批次复制执行）
- [ ] C1 形成存量小鸡批次计划（批次规模、时间窗、回滚负责人）  
  验收：批次计划可审计  
  对齐：G6
- [ ] C2 按 SOP 逐台迁移（每台先备份再迁移）  
  验收：每台都有备份证据、迁移结果、回滚点  
  对齐：G6
- [ ] C3 每批完成后做联调验证（管理面 + 业务端口）  
  验收：管理面符合隧道+token策略，业务端口不受影响  
  对齐：G1, G2, G3
- [ ] C4 批次问题复盘与规则更新  
  验收：问题模式与防复发规则已追加  
  对齐：G1~G7

## 3.4 阶段 D：平台能力改造与收尾（并行开发，批量前必须完成门禁项）
- [ ] D1 SSH 仅密钥 + 管理面限速封禁落地（不触碰业务端口池）  
  验收：密码登录失败、密钥登录成功；业务端口抽测通过  
  对齐：G1, G2
- [ ] D2 双 Token 体系改造（每机唯一、回传一致、错误场景可回归）  
  验收：连续新建两台小鸡两枚 token 均不同；`VM_READY` 回传 token 与运行态一致  
  对齐：G3, G4
- [ ] D3 模板版本门禁改造（版本文件 + 克隆后校验 + 交付追溯）  
  验收：旧模板可被阻断；`VM_READY` 可见版本信息  
  对齐：G5
- [ ] D4 规格合并与归档  
  验收：`plan/规格/` 更新完成，任务归档  
  对齐：G1~G7

## 4. 经验记录（持续追加）
### 4.1 当前阶段结论
- 已确认“简单任务罗列”容易偏离真实意图，本清单改为“目标锚定 + 步骤对齐 + 验收证据”结构。
- 已明确本任务的核心不是“仅修一个报错”，而是“安全、交付一致性、迁移可回滚”的系统改造。
- 已完成 101 去 Docker 化首轮闭环（备份、直装、数据迁移、联调）与控制台直装改造。
- A3 当前为“停旧 Docker 运行态但未做最终清理”，保留快速回滚能力；待回滚演练与门禁通过后再清理。

### 4.2 继续执行纪律
- 每完成一个步骤，必须追加：实际结果、偏差、风险、回滚点。
- 如发现与目标冲突，必须先停步并回到“0.3 最终目标”重新对齐。
