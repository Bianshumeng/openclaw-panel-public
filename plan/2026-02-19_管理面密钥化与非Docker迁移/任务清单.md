# 任务清单

## 0. 约束锁定（本任务硬约束）
- [x] 0.1 需求锁定：保留每台小鸡 50 个业务端口，不做全封公网 | 验收：提案与技术设计一致
- [x] 0.2 需求锁定：SSH 仅密钥登录，禁用密码登录 | 验收：提案与技术设计一致
- [x] 0.3 需求锁定：Web 统一 Gateway Token，取消网页账号密码流程 | 验收：提案与技术设计一致
- [x] 0.4 需求锁定：新小鸡独立 token + `VM_READY` 明文回传 | 验收：提案与技术设计一致
- [x] 0.5 需求锁定：模板版本标识与克隆后门禁校验 | 验收：提案与技术设计一致
- [x] 0.6 需求锁定：OpenClaw 与控制台走“非 Docker 直装”迁移主路线 | 验收：提案与技术设计一致

## 1. 准备阶段（文档与基线）
- [x] 1.1 汇总历史对话中的真实意图、非目标与硬边界 | 验收：文档中有“背景 + 意图 + 边界”
- [x] 1.2 生成任务提案与技术设计初稿 | 验收：`提案.md`、`技术设计.md` 存在
- [x] 1.3 生成规格变更 Delta（不直接覆盖主规格） | 验收：`规格变更/OpenClaw面板.md` 存在
- [ ] 1.4 你确认执行范围与节奏（先 101 演练，再批量） | 验收：确认记录已落盘

## 2. 管理面安全改造（SSH + 限速）
- [ ] 2.1 母机/小鸡 SSH 改为仅密钥登录（禁用密码） | 验收：密码登录失败、密钥登录成功
- [ ] 2.2 管理面端口限速规则上线（仅管理面，不碰业务端口池） | 验收：限速命中日志 + 业务端口抽测通过
- [ ] 2.3 白名单与应急解封机制落地 | 验收：白名单生效 + 一键解封命令可用
- [ ] 2.4 复测“扫描压测场景”下网关与 SSH 可用性 | 验收：无异常断连/无业务端口误伤

## 3. Gateway Token 体系改造（pve-vm-bot）
- [ ] 3.1 小鸡开机后强制生成独立 token（高熵随机） | 验收：连续两台小鸡 token 不相同
- [ ] 3.2 将 token 写入运行配置并重启网关生效 | 验收：配置文件与运行态一致
- [ ] 3.3 `VM_READY` 明文回传 token | 验收：消息中可见 token 且与配置一致
- [ ] 3.4 Bot 输出隧道 URL 直接携带 token | 验收：复制链接可直接使用
- [ ] 3.5 回归 `token missing / token mismatch / missing scope` 场景 | 验收：错误率下降且可定位

## 4. 模板版本治理（防“更新不生效”）
- [ ] 4.1 模板增加版本标识文件（如 `/etc/openclaw-template-version`） | 验收：模板内可读取
- [ ] 4.2 模板发布流程加入“版本号 + 快照/克隆源”双确认 | 验收：发布记录可审计
- [ ] 4.3 克隆后门禁校验版本，不一致直接阻断交付 | 验收：模拟旧模板可触发阻断
- [ ] 4.4 在 `VM_READY` 附加模板版本信息 | 验收：消息可见版本字段

## 5. 客户小鸡迁移任务（先 101 演练）
- [ ] 5.1 盘点数据范围并生成迁移清单（配置/凭据/会话/日志/用户附加内容） | 验收：清单落盘
- [ ] 5.2 执行全量备份并生成校验（hash + manifest） | 验收：备份可校验可恢复
- [ ] 5.3 停止并清理 Docker 版 OpenClaw（仅在备份成功后） | 验收：旧容器停止且可回滚
- [ ] 5.4 安装非 Docker 版 OpenClaw 并恢复数据 | 验收：核心功能恢复
- [ ] 5.5 验证 Telegram、Gateway、控制台、日志、更新流程 | 验收：关键路径通过
- [ ] 5.6 完成一键回滚演练（恢复 Docker 版） | 验收：回滚路径可重复

## 6. 可视化控制台改造（本仓库）
- [ ] 6.1 部署方式改为直装（systemd/本地进程），移除 Docker 强依赖 | 验收：无 Docker 亦可运行
- [ ] 6.2 重构后端路径逻辑（容器路径 -> 宿主路径） | 验收：配置读写路径正确
- [ ] 6.3 服务控制适配（docker 命令 -> systemd/本地命令） | 验收：启停/状态查询通过
- [ ] 6.4 更新逻辑改造（镜像仓库扫描 -> 官方代码/发包更新） | 验收：可检查并执行直装升级
- [ ] 6.5 把脚本能力收敛到 UI 操作，不要求用户进 SSH 执行 TUI | 验收：UI 能覆盖主流程

## 7. 联调与发布阶段
- [ ] 7.1 Linux 实机联调（母机 + 至少 2 台小鸡） | 验收：流程全链路通过
- [ ] 7.2 安全回归（爆破/扫描/限速/鉴权） | 验收：无高危回归
- [ ] 7.3 用户体验回归（首次连接、隧道、token 链接） | 验收：无需手工粘贴 token
- [ ] 7.4 发布与重启窗口执行（由你确认） | 验收：发布记录可追溯

## 8. 收尾阶段
- [ ] 8.1 将已验证变更合并到 `plan/规格/` 主文档 | 验收：主规格更新完成
- [ ] 8.2 任务目录归档到 `plan/归档/` | 验收：归档完成
- [ ] 8.3 补充经验记录与防复发规则 | 验收：经验记录可复用

## 经验记录
### 步骤 0~1 完成记录
- 实际情况：已把“安全、迁移、模板版本、交付体验”四条主线合并为单一执行计划，避免后续分头改动造成目标漂移。
- 遇到问题：历史对话中存在“安全与体验目标互相拉扯”（简化登录 vs 保留鉴权），本次通过“SSH 密钥 + Gateway Token + URL 自动携带”收敛。
- 技术债：当前仍存在 Docker 与非 Docker 双运行路径，迁移期需维护兼容层，任务完成后应回收兼容逻辑。
