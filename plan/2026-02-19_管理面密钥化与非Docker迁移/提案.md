# 管理面密钥化与非 Docker 迁移

创建时间：2026-02-19 18:40:00

## 为什么做
- 2026-02-19 已发生母机公网 SSH 持续扫描与爆破流量，母机出现 `e1000e ... Detected Hardware Unit Hang`，最终 SSH 全断并人工重启恢复。该问题暴露出“管理面暴露过宽 + 密码面攻击面过大”的结构风险。
- 当前交付链路存在两类长期风险：
  - 安全风险：SSH 密码登录与模板共享 Gateway Token，导致撞库面和横向风险过高。
  - 交付风险：模板更新后，新克隆小鸡仍可能拿到旧状态（快照/克隆源不一致），导致“已更新但未生效”。
- 当前用户操作链路存在明显摩擦：SSH 隧道建立后仍需手工输入 Web 账号密码，且经常出现 token 粘贴错误。
- 业务目标已明确：保留客户业务端口开放能力，但把管理面安全收敛为“密钥 + Token + 版本门禁 + 可回滚迁移”。
- 今晚需推进重大策略变更：OpenClaw Bot 与控制台逐步从 Docker 运行转为服务器直装运行（含客户数据完整迁移）。

## 改什么
- 管理面安全基线收敛
  - SSH：仅密钥登录，禁用密码登录。
  - 限速：仅对管理面端口做连接限速与封禁策略，不影响客户业务端口。
  - 鉴权：管理 Web 统一使用 Gateway Token，不再走“网页账号密码”交互。
- Gateway Token 体系重构
  - 每台新小鸡开机后生成独立 Gateway Token。
  - Bot 在 `VM_READY` 中明文回传该 token。
  - Bot 输出隧道 URL 直接携带 token，减少手工粘贴与 `token missing` 误操作。
- 模板版本治理
  - 模板更新必须写入版本标识文件。
  - 克隆后强制版本校验，不匹配时阻断交付并报错。
- 客户小鸡迁移任务（Docker -> 直装）
  - 先在自用测试小鸡（vmid=101）做全量迁移演练。
  - 完整备份用户数据（配置、凭据、会话、日志、插件/扩展数据等）。
  - 清理 Docker 版 OpenClaw 后，安装新版直装运行，并恢复数据。
  - 提供一键回滚到 Docker 版的操作预案。
- 可视化控制台改造
  - 控制台改为服务器直装运行，不再依赖 Docker 运行态。
  - 将现有“Docker 交互路径/命令”改为“宿主机路径/服务控制”。
  - 将“镜像仓库升级逻辑”改为“官方代码/发包升级逻辑”。
  - 保持用户侧“无需 SSH 手工操作”的原则，把必要脚本能力内置到控制台操作流程中。

## 破坏性变更（必须明确）
- SSH 密码登录将被禁用：历史只会密码登录的路径会失效，需统一改用密钥。
- 运行时从 Docker 向直装迁移：服务控制命令、日志路径、升级入口会变化。
- Web 鉴权从账号密码转为 Gateway Token：旧登录入口文案和流程将调整。

## 影响范围
- 仓库与模块：
  - `E:/AAA__ZhuoMian/大盘鸡/pve-vm-bot`：小鸡创建编排、`VM_READY` 输出、模板版本门禁、迁移编排、运维命令。
  - `E:/AAA__ZhuoMian/龙虾傻瓜化`：可视化控制台部署方式、服务控制适配层、更新逻辑、迁移向导页面。
  - 线上模板与小鸡运行环境：`sshd`、Gateway 配置、系统服务、数据目录权限。
- 风险等级：L2（跨模块 + 运行时迁移 + 安全策略变更）

## 不做什么（边界）
- 不关闭客户业务端口池（每台小鸡约 50 个业务端口继续保留）。
- 不把所有运维动作强制回退为“用户手工 SSH + TUI”；控制台仍是默认主入口。
- 不在未完成备份校验前直接删除客户生产数据。
- 不以“先上线再补文档”的方式推进，必须先文档化再执行迁移。

## 验证（存在风险时必填）
- 安全基线验证
  - SSH 密码登录失败，密钥登录成功。
  - 管理面限速生效且不影响业务端口连通。
- Token 验证
  - 新小鸡 token 与模板 token 不同（唯一性）。
  - `VM_READY` 回传 token 与小鸡配置文件一致。
  - 直接使用 Bot 回传隧道 URL 可进入页面。
- 模板版本验证
  - 新小鸡版本标识必须等于模板预期版本，不一致时阻断。
- 迁移验证
  - 迁移前后配置、渠道、技能、历史会话、用户数据可用。
  - 回滚演练至少完成一次。

## 回滚（存在风险时必填）
- 回滚触发条件
  - 迁移后核心流程不可用（Gateway 不通、Telegram 失联、关键配置丢失）。
  - 发现影响客户业务端口可用性。
- 回滚步骤
  - 使用迁移前完整备份恢复配置与数据目录。
  - 恢复 Docker 版编排与镜像，回退服务控制入口。
  - 恢复旧鉴权路径（仅应急，回滚后需重新整改）。
- 回滚证据
  - 回滚前后版本、配置哈希、关键接口可用性对比记录。

## 联网对照依据（官方资料）
- Linux e1000e 驱动文档：<https://www.kernel.org/doc/html/v4.20/networking/e1000e.html>
- e1000e 与 TSO 相关上游讨论：<https://patchwork.ozlabs.org/project/netdev/patch/1623942.pXzBnfQ100@rocinante.m.i2n/>
- Intel wired-lan 邮件列表讨论：<https://lists.osuosl.org/pipermail/intel-wired-lan/Week-of-Mon-20190513/016087.html>
- OpenClaw Gateway 远程与 Control UI 文档：<https://docs.openclaw.ai/gateway/remote> 、<https://docs.openclaw.ai/web/control-ui>
