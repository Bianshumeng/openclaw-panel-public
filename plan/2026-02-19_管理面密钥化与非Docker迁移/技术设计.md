# 技术设计

## 背景与约束
- 背景事实
  - 母机曾出现 `e1000e ... Detected Hardware Unit Hang`，触发时段伴随大量公网 SSH 扫描与爆破流量。
  - 当前小鸡交付链路里存在“模板共享 token”“模板更新后克隆旧状态”“Docker 运行路径权限不一致”等问题。
  - 用户已明确目标：保留业务端口能力，收紧管理面安全，简化连接体验，推进非 Docker 直装。
- 硬约束
  - 每台小鸡业务端口池（约 50 端口）必须保留。
  - SSH 改为仅密钥登录，禁用密码登录。
  - Web 鉴权统一为 Gateway Token，不再使用网页账号密码流程。
  - 新小鸡必须生成两枚独立 token（`panel_token`、`gateway_token`），并在 `VM_READY` 明文回传。
  - `VM_READY` 仅允许输出 SSH 连接脚本与本地隧道地址，不允许输出管理 Web 的公网地址字段。
  - 端口分配逻辑保持不变：`SSH=port_start`、`管理面板=port_start+1`、`Bot UI=port_start+2`，每台新机按 50 端口块后移。
  - 模板必须有版本标识，克隆后校验不通过即阻断交付。
  - 迁移任务必须“先备份、可校验、可回滚”。

## 目标
1. 把管理面安全模型从“多入口+弱一致”改为“密钥 + Token + 门禁 + 限速”。
2. 把小鸡交付从“模板猜测生效”改为“版本可验证交付”。
3. 把 OpenClaw 与控制台运行模型从 Docker 主路径迁移到直装主路径，同时保留迁移期可回滚。
4. 保持用户侧体验：无需 SSH 手工配置即可完成常见操作。

## 不做（Non-Goals）
- 不关闭客户业务端口池。
- 不强制所有用户改为命令行/TUI 运维。
- 不在本阶段重写 OpenClaw 核心业务逻辑。
- 不承诺一次迁移覆盖全部存量客户机，先走“101 演练 -> 小范围灰度 -> 批量迁移”。

## 复杂任务自我反思（5 问）
1. 核心能力是什么：安全收敛 + 可验证交付 + 非 Docker 迁移。
2. 最低安全基线是什么：SSH 密钥化、token 唯一化、管理面限速、可回滚。
3. 不可接受的破坏是什么：业务端口误伤、数据丢失、无法回滚。
4. 主要风险和替代方案是什么：
   - 风险：迁移后权限/路径错配导致功能失效。
   - 替代：先保留 Docker 双轨，逐台迁移验证后再收敛。
5. 关键假设如何验证：
   - 假设：模板版本门禁能阻断旧状态交付。
   - 验证：模拟旧快照克隆，必须命中阻断。

## 技术决策
| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 管理面访问模型 | SSH 隧道 + Gateway Token | 兼顾安全和可用性，减少公网直接暴露 | 继续公网账号密码直连 |
| SSH 认证 | 仅密钥登录，禁密码 | 直接切断撞库入口，降低扫描成本收益比 | 密码+密钥并存 |
| Web 鉴权 | 统一 Gateway Token | 避免双鉴权模型漂移，减少人工输入 | 保留账号密码表单 |
| Token 生成 | 每台小鸡独立生成 | 避免模板共享 token 横向风险 | 模板固定 token |
| 模板治理 | 版本文件 + 克隆后门禁 | 避免“更新未生效”黑箱 | 继续人工口头确认 |
| 迁移路径 | 先 101 演练，再灰度 | 降低不可逆风险 | 直接全量切换 |
| 控制台运行方式 | 非 Docker 直装主路径 | 符合“少容器权限摩擦”目标 | 继续 Docker 主路径 |

## 架构与流程改造

### 一、管理面与业务面分层
- 管理面（收紧）
  - 母机 SSH / PVE 管理接口 / 小鸡管理 SSH / 小鸡管理 Web（OpenClaw UI、控制台）
  - 策略：密钥登录、限速、封禁、仅隧道访问（不提供公网直连入口）
- 业务面（保留）
  - 客户自定义服务端口池（约 50 端口）
  - 策略：按需开放，不受管理面限速策略影响

### 二、SSH 密钥化与网络层策略
- SSH 改造要求
  - `PasswordAuthentication no`
  - `PubkeyAuthentication yes`
  - `PermitRootLogin prohibit-password`（允许 root 密钥登录，禁止 root 密码登录）
- 管理面限速建议（仅管理面端口）
  - 每 IP 每分钟新建连接上限，超出丢弃（已确认采用）
  - 白名单机制 + 一键解封命令
- 关键原则
  - 扫描流量不会消失，但应尽早在网络层拒绝，减少应用层与驱动层压力。

### 二点五、存量小鸡切换影响与门禁
- 对已开小鸡的实际影响
  - 改造后，密码登录会失效；只有已写入公钥的客户端可登录。
  - 管理 Web 不再提供公网直连字段，改为“SSH 隧道 + 本地 URL + token”。
- 强制门禁
  - 对任意存量小鸡，必须先完成“公钥可登录验证”，再执行 `PasswordAuthentication no`。
  - 门禁未通过时禁止执行禁密动作，避免把存量机器锁死。
- 交付要求
  - 每台存量小鸡完成改造后，必须产出一条“可复制连接脚本 + 本地隧道 URL”验收记录。

### 三、Gateway Token 统一鉴权（双 Token）
- 生成时机
  - 小鸡首启初始化阶段（克隆并启动后）
- 生成规则
  - 使用高熵随机（例如 32 字节以上）分别生成 `panel_token` 与 `gateway_token`
- 写入目标
  - OpenClaw UI 对接 `gateway_token`
  - 可视化控制台对接 `panel_token`
  - 两者不得共用同一 token
- 交付输出
  - `VM_READY` 明文回传 `panel_token`、`gateway_token`
  - 两个隧道 URL 直接携带对应 token（按当前 OpenClaw 版本支持的参数格式）
  - 仅返回本地访问地址（`127.0.0.1` 映射），不返回管理 Web 公网地址
  - 可视化控制台：未携带 `panel_token` 或 token 错误时，服务端直接 `401/403` 拒绝（不进入空壳页面）
  - OpenClaw 自带 UI：保持原生 token 输入/连接交互，不强改为控制台同款拦截流程
- 回归场景
  - `token missing`
  - `token mismatch`
  - `missing scope: operator.read`

#### `VM_READY` 输出示例（草案）
```text
[VM_READY] vm-xxxx(101)
ssh_connect_command: ssh -i ~/.ssh/<key> root@<host> -p <port_start>
panel_token: <panel_token>
gateway_token: <gateway_token>
local_panel_url: http://127.0.0.1:<local_panel_port>/?token=<panel_token>
local_gateway_url: http://127.0.0.1:<local_gateway_port>/?token=<gateway_token>
template_version: <template.version>
```
说明：
- 不得出现 `panel_public_url` / `gateway_public_url`。
- 控制台与 OpenClaw UI 的 token 必须分离，禁止复用。

### 四、模板版本治理（防旧版本克隆）
- 模板侧
  - 固定版本标识文件：`/etc/openclaw-template-version`
  - 每次模板更新必须递增版本并记录发布说明
- 编排侧
  - 克隆后通过 guest agent 读取版本标识
  - 与预期版本不一致则阻断交付，不发送成功态 `VM_READY`
- 交付侧
  - `VM_READY` 附带模板版本信息，便于追溯

### 五、客户小鸡迁移（Docker -> 直装）
- 迁移对象
  - 先在自用测试小鸡 vmid=101 演练
  - 验证通过后再迁移客户小鸡
- 备份范围（必须）
  - OpenClaw 配置、渠道配置、模型配置、token、identity、credentials、sessions、logs、用户附加文件
- 迁移步骤（高层）
  1. 备份与校验（tar + hash + manifest）
  2. 停止 Docker 服务并冻结写入
  3. 安装直装版 OpenClaw（systemd 或等价服务）
  4. 恢复配置与数据，修正路径与权限
  5. 启动服务并做链路验证
  6. 保留回滚包与回滚脚本
- 回滚原则
  - 任一关键链路失败（Gateway、Telegram、控制台、配置写入）立即回滚。

### 六、控制台（本仓库）非 Docker 改造
- 部署层改造
  - 将控制台运行从 Docker 主路径改为宿主机直装主路径。
- 后端路径改造
  - 原有容器路径读写改为宿主机路径读写。
  - 保留兼容适配层，仅作为迁移期过渡。
- 服务控制改造
  - 原 `docker` 控制指令改为 `systemd/本地进程` 控制。
- 更新逻辑改造
  - 旧逻辑：扫描 Docker 镜像发布（`/api/update/*` + `docker-update.js`）。
  - 新逻辑：对齐官方安装/更新文档，按安装方式分流升级：
    - `global`：包管理器升级（npm/pnpm 全局安装）
    - `source`：`openclaw update` / source pin 流程
  - 迁移完成后移除“拉镜像/应用镜像/镜像回滚”入口与后端路径。
- 交互改造
  - 将“脚本能力”封装到控制台操作，避免用户必须 SSH 手工执行。

### 七、官方安装与更新对齐策略（新增）
- 官方安装入口（直装）
  - `curl -fsSL https://openclaw.ai/install.sh | bash`
  - 可选：`--no-onboard`
- 官方更新基线
  - 更新后必须执行：`openclaw doctor`、`openclaw gateway restart`、`openclaw health`
  - `source` 安装优先用 `openclaw update`
  - `source` 回滚按 commit/date pin；`global` 回滚按版本号安装
- 面板更新页改造要求
  - 页面需先展示安装方式探测结果（`global` / `source`）
  - 仅展示与当前安装方式匹配的操作按钮
  - 不再展示 Docker 专属文案（镜像、容器、compose）

## 配置与输出契约变更（最小表）
| 字段 | 类型 | 必需 | 约束 | 兼容性说明 | 备注 |
|------|------|------|------|-----------|------|
| `openclaw.gateway.auth.mode` | string | 是 | 固定 `token` | 旧账号密码流程废弃 | 管理 Web 鉴权模式 |
| `openclaw.gateway.auth.token` | string | 是 | 高熵随机、每机唯一（`gateway_token`） | 模板固定 token 不再允许 | OpenClaw UI 使用 |
| `panel.auth.token` | string | 是 | 高熵随机、每机唯一（`panel_token`） | 新增 | 可视化控制台使用 |
| `vm_ready.ssh_connect_command` | string | 是 | 仅密钥登录命令 | 新增输出字段 | 用户连接入口 |
| `vm_ready.panel_token` | string | 是 | 明文回传 | 新增字段 | 控制台 token |
| `vm_ready.gateway_token` | string | 是 | 明文回传 | 新增字段 | OpenClaw UI token |
| `vm_ready.local_panel_url` | string | 是 | `127.0.0.1` 本地映射地址，URL 内携带 `panel_token` | 新增/重构 | 控制台本地访问地址 |
| `vm_ready.local_gateway_url` | string | 是 | `127.0.0.1` 本地映射地址，URL 内携带 `gateway_token` | 新增/重构 | OpenClaw UI 本地访问地址 |
| `vm_ready.panel_public_url` | string | 否 | 不允许输出 | 废弃 | 管理面公网地址移除 |
| `vm_ready.gateway_public_url` | string | 否 | 不允许输出 | 废弃 | 管理面公网地址移除 |
| `update.install_method` | string | 是 | `global` / `source` | 新增 | 更新策略分流 |
| `update.strategy` | string | 是 | `package-manager` / `openclaw-update` | 新增 | 前后端操作模式 |
| `update.docker_mode` | boolean | 是 | `false`（迁移完成后） | 旧模式降级 | Docker 更新入口回收 |
| `template.version` | string | 是 | 语义化或日期版本 | 新增门禁字段 | 克隆后校验 |

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| 迁移导致配置丢失 | 先备份 + hash 校验 + manifest + 回滚演练 |
| 迁移导致权限异常 | 固化目录权限模板与启动后自检/自愈 |
| 管理面限速误伤 | 只限管理面端口 + 白名单 + 一键解封 |
| 旧模板继续被克隆 | 强制版本门禁，不匹配直接阻断 |
| 双运行时过渡复杂 | 设置明确回收节点，迁移完成后移除兼容层 |

## 迁移/回滚方案
- 迁移步骤
  1. 在 vmid=101 完成备份、直装迁移、验证。
  2. 固化迁移脚本与校验脚本。
  3. 小范围灰度到 1~2 台客户机。
  4. 批量迁移并逐台验收。
- 回滚步骤
  1. 停止直装服务。
  2. 恢复 Docker 编排与镜像标签。
  3. 从备份恢复数据目录。
  4. 启动 Docker 服务并回归验证。
- 验证方式
  - 功能验证：UI、Telegram、Gateway、日志、更新、配置写入。
  - 安全验证：SSH 密钥化、token 唯一性、限速命中。
  - 兼容验证：业务端口连通不受影响。

## 验证计划（最小可复现）
1. 安全验证
  - SSH 密码登录失败、密钥登录成功。
  - 管理面限速命中，业务端口不受影响。
2. Token 验证
  - 连续新建两台小鸡，`panel_token` 与 `gateway_token` 均必须不同。
  - `VM_READY` 回传的两个 token 均与配置文件一致。
  - `VM_READY` 不返回 `IP:port` 形式的管理 Web 公网地址。
  - `VM_READY` 返回的两个本地 URL 均可直接访问管理页面（无需手工拼 token）。
  - 可视化控制台未带 `panel_token` 或 token 错误时返回 `401/403`，且不进入空壳页面。
  - OpenClaw 自带 UI 保持原生 token 输入/连接交互，验证其兼容性不回归。
3. 模板验证
  - 模拟旧模板版本，必须被门禁阻断。
4. 迁移验证
  - 101 小鸡迁移前后核心能力等价。
  - 回滚路径实测可用。

## 联网对照依据（官方资料）
- Linux e1000e 文档：<https://www.kernel.org/doc/html/v4.20/networking/e1000e.html>
- e1000e 讨论（TSO 相关）：<https://patchwork.ozlabs.org/project/netdev/patch/1623942.pXzBnfQ100@rocinante.m.i2n/>
- Intel wired-lan 邮件线程：<https://lists.osuosl.org/pipermail/intel-wired-lan/Week-of-Mon-20190513/016087.html>
- OpenClaw Gateway 文档：<https://docs.openclaw.ai/gateway/remote>
- OpenClaw Control UI 文档：<https://docs.openclaw.ai/web/control-ui>
