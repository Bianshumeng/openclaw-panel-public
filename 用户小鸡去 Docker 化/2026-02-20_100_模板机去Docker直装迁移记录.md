# 2026-02-20_100_模板机去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=100`（`Template-Debian-OpenClaw001`，`10.10.10.100`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 100`）
- 执行日期：2026-02-20
- 执行目标：按用户要求“模板机不备份，直接删除 Docker 部署并改为直装”

## 用户确认约束
1. 模板机不做备份（明确要求：无关键配置数据）。
2. 直接删除两个 Docker 项目：
   - 龙虾 Bot（gateway）
   - 龙虾可视化配置页面（panel）
3. 两个项目都改为直装并可用。

## 执行动作（已完成）
1. 删除 Docker 部署：
   - `cd /opt/openclaw && docker compose down --remove-orphans`
   - 删除 `openclaw-gateway`、`openclaw-panel` 相关镜像
   - 删除后 `docker ps` 无运行容器
2. 安装直装运行时：
   - 安装后 `node v22.22.0`
   - `openclaw --version => 2026.2.19-2`
3. 直装数据目录准备：
   - `/data/openclaw -> /root/.openclaw`（`rsync -aHAX --delete`）
   - 权限修正：`chown -R root:root /root/.openclaw`
4. 网关配置改造：
   - `/root/.openclaw/openclaw.json`
   - `gateway.port=28789`
   - `gateway.remote.url=ws://127.0.0.1:28789`
5. 面板直装部署：
   - 发布版本：`v2026.02.20-r4`
   - 发布仓库：`Bianshumeng/openclaw-panel-public`
   - 安装目录：`/opt/openclaw-panel`
6. 配置与服务接管：
   - 配置文件：`/etc/openclaw-panel/panel.config.json`
   - 服务文件：
     - `/etc/systemd/system/openclaw-gateway.service`
     - `/etc/systemd/system/openclaw-panel.service`
   - 两个服务均 `enabled + active`
   - 两个服务均 `User=root`

## 验证证据
1. 端口监听：
   - `127.0.0.1:28080`（panel 直装）
   - `127.0.0.1:28789`（gateway 直装）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（nginx 前端）
2. HTTP 验证：
   - `http://127.0.0.1:28080/ => 200`
   - `http://127.0.0.1:28789/ => 200`
   - `http://127.0.0.1:18080/ => 401`（认证前置正常）
   - `http://127.0.0.1:18789/ => 401`（认证前置正常）
3. 更新接口验证（直装链路）：
   - `GET /api/update/check?target=bot => ok=true, currentTag=2026.2.19-2`
   - `GET /api/update/check?target=panel => ok=true, currentTag=v2026.02.20-r4`
4. Docker 验证：
   - `docker ps` 为空
   - 无 `openclaw-gateway/openclaw-panel` 运行容器

## 当前结论
1. 模板机已完成去 Docker 化，Bot 与可视化面板均为直装运行。
2. 当前端口链路与 101/102 一致（`18080->28080`, `18789->28789`）。
3. 已执行模板发布动作：`qm template 100`。
4. 当前 PVE 配置已出现 `template: 1`，确认 `VMID=100` 已是模板状态。
5. 可作为后续新小鸡交付的直装模板基础。

## 后续建议
1. 对模板机做一次“模板脱敏检查”（token/设备身份等）后再固化模板。
2. 新开小鸡时继续按 SOP 执行验收，不再引入 Docker 路径。
