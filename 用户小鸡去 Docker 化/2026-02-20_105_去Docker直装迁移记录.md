# 2026-02-20_105_去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=105`（`vm-260219-0004`，`10.10.10.14`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 105`）
- 执行日期：2026-02-20
- 执行目标：按 SOP 完成“停 Docker 不删 -> 直装接管 -> 数据迁移 -> 验收”

## 迁移前扫描（只读）
1. 虚机状态：`qm status 105 => running`
2. Docker 容器状态（迁移前）：
   - `openclaw-panel`：`Up 14 hours`（`127.0.0.1:28080->18080`）
   - `openclaw-gateway`：`Up 14 hours`（`127.0.0.1:28789->18789`）
3. 目录状态：
   - 存在：`/data/openclaw`、`/data/panel`、`/opt/openclaw`
   - 缺失：`/root/.openclaw`
4. NAT 端口映射（母机）：
   - `10200 -> 10.10.10.14:22`
   - `10201 -> 10.10.10.14:18080`
   - `10202 -> 10.10.10.14:18789`

## 备份与校验（门禁）
1. 精准备份目录：`/root/migrate-backup-105-2026-02-20_072938`
2. 备份文件：
   - `data-openclaw.tgz`
   - `data-panel.tgz`
   - `opt-openclaw.tgz`
   - `root-ssh.tgz`
3. 校验文件：`SHA256SUMS.txt`
4. 校验结果：
   - `sha256sum -c SHA256SUMS.txt` 全部 `OK`
   - `tar -tzf` 抽检全部可解压

## 执行动作
1. 停 Docker（不删）：
   - 在 `/opt/openclaw` 执行 `docker compose stop`
   - 结果：`openclaw-panel`、`openclaw-gateway` 均转为 `Exited`
2. 直装运行时接管：
   - 补齐运行时后结果：
     - `node -v => v22.22.0`
     - `openclaw --version => 2026.2.19-2`
3. 数据迁移到官方目录：
   - 来源：`/data/openclaw/`
   - 目标：`/root/.openclaw/`
   - 命令：`rsync -aHAX --delete`
   - 权限：`chown -R root:root /root/.openclaw`
4. 网关配置改造（直装）：
   - 文件：`/root/.openclaw/openclaw.json`
   - 关键参数：
     - `gateway.port = 28789`
     - `gateway.remote.url = ws://127.0.0.1:28789`
   - 备份：`/root/.openclaw/openclaw.json.bak.20260220073222`
5. panel 直装部署：
   - 仓库：`Bianshumeng/openclaw-panel-public`
   - 版本：`v2026.02.20-r4`
   - 目录：`/opt/openclaw-panel`
   - 版本标记：`/opt/openclaw-panel/.panel-release.json`
6. panel 配置切换：
   - 文件：`/etc/openclaw-panel/panel.config.json`
   - 关键参数：
     - `runtime.mode = systemd`
     - `panel.listen_host = 127.0.0.1`
     - `panel.listen_port = 28080`
     - `openclaw.config_path = /root/.openclaw/openclaw.json`
     - `openclaw.gateway_port = 28789`
     - `docker.enabled = false`
     - `log.source = journal`
     - `log.file_path = /root/.openclaw/logs/gateway.log`
7. systemd 接管：
   - 新建：`/etc/systemd/system/openclaw-gateway.service`
   - 新建：`/etc/systemd/system/openclaw-panel.service`
   - 执行：`systemctl enable --now openclaw-gateway openclaw-panel`

## 验收证据
1. 端口监听：
   - `127.0.0.1:28080`（`node`）
   - `127.0.0.1:28789`（`openclaw-gateway`）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（`nginx`）
2. HTTP 状态码：
   - `panel-direct`：`http://127.0.0.1:28080/ => 200`
   - `gateway-direct`：`http://127.0.0.1:28789/ => 200`
   - `panel-front`：`http://127.0.0.1:18080/ => 401`（前置认证正常）
   - `gateway-front`：`http://127.0.0.1:18789/ => 401`（前置认证正常）
3. 更新接口：
   - `GET /api/update/check?target=bot`：`currentTag=2026.2.19-2`，`updateAvailable=false`
   - `GET /api/update/check?target=panel`：`currentTag=v2026.02.20-r4`，`updateAvailable=false`
4. 数据抽样一致性：
   - `source_sessions=6`，`target_sessions=6`
   - `source_workspace=584`，`target_workspace=584`
5. 运行权限：
   - 单元配置：`User=root`
   - 进程用户：`gateway_proc_user=root`、`panel_proc_user=root`
6. Docker 状态（保留回滚）：
   - `openclaw-panel`：`Exited`
   - `openclaw-gateway`：`Exited`

## 风险与回滚
1. 当前风险：
   - Docker 资源未删除，短期无业务风险，但会占部分磁盘。
2. 快速回滚：
   - `systemctl stop openclaw-gateway openclaw-panel`
   - `cd /opt/openclaw && docker compose start`
3. 配置回滚：
   - `openclaw.json` 回退到 `openclaw.json.bak.20260220073222`
   - 数据回退到 `/root/migrate-backup-105-2026-02-20_072938/*`

## 本机特殊问题与防复发
1. 问题现象：首次执行官方安装命令出现超时挂起。
2. 根因路径：`install.sh` 默认交互模式在 QGA 非交互环境下会卡在安装方式选择。
3. 处理：终止挂起进程后确认运行时落地成功，再继续后续迁移步骤。
4. 防复发规则：后续批量迁移统一使用非交互参数执行安装脚本（`--no-prompt --no-onboard --no-gum`）。
