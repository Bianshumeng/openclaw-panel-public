# 2026-02-20_102_去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=102`（`vm-260219-0001`，`10.10.10.11`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 102`）
- 执行日期：2026-02-20
- 执行目标：在保留回滚能力前提下完成“停 Docker 不删 -> 直装接管 -> 数据精准迁移 -> 可用性验证”

## 迁移前状态（扫描结论）
1. Docker 容器运行中：
   - `openclaw-gateway`（127.0.0.1:28789->18789）
   - `openclaw-panel`（127.0.0.1:28080->18080）
2. 数据来源目录存在：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
3. 直装目录不存在：
   - `/root/.openclaw`（迁移前缺失）

## 备份与校验（已完成）
1. 精准备份目录：`/root/migrate-backup-102-2026-02-20_070539`
2. 备份包：
   - `data-openclaw.tgz`
   - `data-panel.tgz`
   - `opt-openclaw.tgz`
   - `root-ssh.tgz`
3. 校验文件：`SHA256SUMS.txt`
4. 校验结果：`sha256sum -c` 全部 `OK`

## 执行动作（已完成）
1. 停 Docker（不删除）：
   - `docker compose stop`（在 `/opt/openclaw`）
   - 容器状态变为 `Exited`
2. 修复直装运行时：
   - 发现历史 `openclaw` 命令存在但缺失 `node`（残留壳子）
   - 执行官方安装脚本后，`node v22.22.0` 与 `openclaw 2026.2.19-2` 可用
3. 数据迁移到官方默认目录：
   - 来源：`/data/openclaw`
   - 目标：`/root/.openclaw`
   - 同步方式：`rsync -aHAX --delete`
   - 权限修正：`chown -R root:root /root/.openclaw`
4. 网关配置改造（对齐现有 Nginx）：
   - 文件：`/root/.openclaw/openclaw.json`
   - 关键变更：
     - `gateway.port: 28789`
     - `gateway.remote.url: ws://127.0.0.1:28789`
   - 配置备份：`/root/.openclaw/openclaw.json.bak.20260220071131`
5. 面板直装部署：
   - 发布版本：`v2026.02.20-r4`
   - 发布仓库：`Bianshumeng/openclaw-panel-public`
   - 安装目录：`/opt/openclaw-panel`
   - 版本标记：`/opt/openclaw-panel/.panel-release.json`
6. 面板配置切换：
   - 配置文件：`/etc/openclaw-panel/panel.config.json`
   - 关键参数：
     - `runtime.mode=systemd`
     - `panel.listen_host=127.0.0.1`
     - `panel.listen_port=28080`
     - `openclaw.config_path=/root/.openclaw/openclaw.json`
     - `openclaw.gateway_port=28789`
     - `docker.enabled=false`
7. 新建并启用系统服务：
   - `/etc/systemd/system/openclaw-gateway.service`
   - `/etc/systemd/system/openclaw-panel.service`
   - 状态：`enabled + active`
8. 权限等级确认（root）：
   - `openclaw-gateway.service` 配置：`User=root`
   - `openclaw-panel.service` 配置：`User=root`
   - 进程实测：
     - `openclaw-gateway` 主进程用户：`root`
     - `openclaw-panel` 进程用户：`root`

## 验证证据
1. 端口监听：
   - `127.0.0.1:28080`（node panel）
   - `127.0.0.1:28789`（openclaw gateway）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（nginx 前端）
2. HTTP 验证：
   - `http://127.0.0.1:28080/ => 200`
   - `http://127.0.0.1:28789/ => 200`
   - `http://127.0.0.1:18080/ => 401`（前置认证正常）
   - `http://127.0.0.1:18789/ => 401`（前置认证正常）
3. 更新接口验证（直装逻辑）：
   - `GET /api/update/check?target=bot => currentTag=2026.2.19-2`
   - `GET /api/update/check?target=panel => currentTag=v2026.02.20-r4`
4. 数据完整性抽样：
   - 顶层目录清单与来源一致（除新增备份文件）
   - 会话文件数：`2 -> 2`
   - workspace 文件数：`37 -> 37`
5. root 权限证据：
   - `systemctl cat openclaw-gateway` 命中 `User=root`
   - `systemctl cat openclaw-panel` 命中 `User=root`
   - `systemctl show -p MainPID openclaw-gateway` + `ps` 显示网关主进程为 `root`

## 当前结论
1. 102 已完成去 Docker 化直装接管，且核心链路可用。
2. 当前保留 Docker 容器为 `stopped` 状态，尚未执行删除，便于快速回滚。
3. 已满足“先迁移验证、后删除 Docker”的门禁要求。

## 风险与回滚
1. 若用户实测出现异常，可立即回滚：
   - `cd /opt/openclaw && docker compose start`
   - `systemctl stop openclaw-gateway openclaw-panel`
2. 若配置损坏，可恢复：
   - `openclaw.json` 回滚到 `openclaw.json.bak.20260220071131`
   - 数据回滚到 `/root/migrate-backup-102-2026-02-20_070539/*`

## 下一步建议（待确认）
1. 你先进行 102 前端实测（隧道 + 页面配置读写 + Telegram 基础配置）。
2. 实测通过后执行 Docker 删除收尾（`docker compose down --remove-orphans`）。
3. 复用本记录流程迁移下一台存量小鸡。
