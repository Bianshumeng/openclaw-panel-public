# 2026-02-20_106_去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=106`（`vm-260219-0005`，`10.10.10.15`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 106`）
- 执行日期：2026-02-20
- 执行目标：在可回滚前提下完成“停 Docker 不删 -> 直装接管 -> 数据精准迁移 -> 链路验收”

## 迁移前状态（扫描结论）
1. Docker 容器运行中：
   - `openclaw-panel`（`127.0.0.1:28080 -> 18080`）
   - `openclaw-gateway`（`127.0.0.1:28789 -> 18789`）
2. 数据来源目录存在：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
3. 直装目标目录缺失：
   - `/root/.openclaw`（迁移前不存在）

## 备份与校验（已完成）
1. 精准备份目录：`/root/migrate-backup-106-2026-02-20_072922`
2. 备份包：
   - `data-openclaw.tgz`
   - `data-panel.tgz`
   - `opt-openclaw.tgz`
   - `root-ssh.tgz`
3. 校验文件：`SHA256SUMS.txt`
4. 校验结果：
   - `sha256sum -c` 全部 `OK`
   - `tar -tzf` 抽检全部通过

## 执行动作（已完成）
1. 停 Docker（不删除）：
   - 在 `/opt/openclaw` 执行 `docker compose stop`
   - 容器状态变为 `Exited`，并保留容器与镜像用于回滚
2. 安装直装运行时：
   - 执行官方安装脚本后，`node` 与 `openclaw` 命令可用
   - 版本：`node v22.22.0`、`openclaw 2026.2.19-2`
3. 数据迁移到官方默认目录：
   - 来源：`/data/openclaw`
   - 目标：`/root/.openclaw`
   - 同步方式：`rsync -aHAX --delete`
   - 权限修正：`chown -R root:root /root/.openclaw`
4. 网关配置改造（对齐现有 Nginx 映射）：
   - 文件：`/root/.openclaw/openclaw.json`
   - 关键变更：
     - `gateway.port = 28789`
     - `gateway.bind = loopback`
     - `gateway.remote.url = ws://127.0.0.1:28789`
   - 配置备份：`/root/.openclaw/openclaw.json.bak.20260220073146`
5. 面板直装部署：
   - 发布版本：`v2026.02.20-r4`
   - 发布仓库：`Bianshumeng/openclaw-panel-public`
   - 安装目录：`/opt/openclaw-panel`
   - 版本标记：`/opt/openclaw-panel/.panel-release.json`
6. 面板配置切换（systemd 模式）：
   - 配置文件：`/etc/openclaw-panel/panel.config.json`
   - 关键参数：
     - `runtime.mode=systemd`
     - `panel.listen_host=127.0.0.1`
     - `panel.listen_port=28080`
     - `openclaw.config_path=/root/.openclaw/openclaw.json`
     - `openclaw.gateway_port=28789`
     - `docker.enabled=false`
7. 新建并启用 systemd 服务：
   - `/etc/systemd/system/openclaw-gateway.service`
   - `/etc/systemd/system/openclaw-panel.service`
   - 结果：`enabled + active`
8. 权限等级确认（root）：
   - `openclaw-gateway.service`：`User=root`
   - `openclaw-panel.service`：`User=root`
   - 进程用户：均为 `root`

## 验证证据
1. 端口监听：
   - `127.0.0.1:28080`（panel，node 进程）
   - `127.0.0.1:28789`（gateway）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（nginx 前端）
2. HTTP 验证：
   - `http://127.0.0.1:28080/ => 200`
   - `http://127.0.0.1:28789/ => 200`
   - `http://127.0.0.1:18080/ => 401`（前置认证正常）
   - `http://127.0.0.1:18789/ => 401`（前置认证正常）
3. 更新接口：
   - `GET /api/update/check?target=bot => currentTag=2026.2.19-2`
   - `GET /api/update/check?target=panel => currentTag=v2026.02.20-r4`
4. 数据完整性抽样：
   - 会话文件数：`1 -> 1`
   - workspace 文件数：`25 -> 25`
5. Docker 保留状态：
   - `openclaw-panel`、`openclaw-gateway` 均为 `Exited`
   - 未执行 `docker compose down`、未删镜像

## 问题与处理
1. 现象：网关首轮验收出现 `gateway-direct:000`。
2. 根因：`openclaw-gateway` 刚启动阶段存在短暂预热窗口，HTTP 探测早于监听建立。
3. 处理：等待并重试后恢复为 `gateway-direct:200`，后续监听稳定。
4. 防复发：验收脚本中对网关增加 5~30 秒重试窗口，避免把“启动中”误判为失败。

## 风险与回滚
1. 当前风险：
   - 已切到直装运行，若后续用户实测有特定场景异常，需要快速回切。
2. 快速回滚路径：
   - 停直装：`systemctl stop openclaw-gateway openclaw-panel`
   - 恢复 Docker：`cd /opt/openclaw && docker compose start`
3. 配置回滚：
   - `openclaw.json` 可回滚到 `openclaw.json.bak.20260220073146`
   - 数据可从 `/root/migrate-backup-106-2026-02-20_072922` 恢复

## 当前结论
1. `106` 已完成去 Docker 化直装接管。
2. 核心链路可用，用户前端入口与网关入口响应符合预期。
3. 按门禁要求保留 Docker 停机态，等待用户确认后再执行删除收尾。
