# 2026-02-20_101_去Docker直装执行方案

## 目标
在 `101` 小鸡完成一次可回滚的“Docker -> 直装 OpenClaw”迁移，作为后续批量迁移模板。

## 范围
- 包含：
  - 备份宿主机核心数据目录（默认精准备份）
  - 下线 Docker 版 OpenClaw（gateway + panel）
  - 安装官方直装版 OpenClaw
  - 恢复并验证关键数据与服务
- 不包含：
  - 批量迁移其他小鸡
  - 业务端口策略变更

## 迁移前前提
1. 已完成扫描基线：`用户小鸡去 Docker 化/2026-02-20_101_扫描基线.md`
2. 已确认关键数据目录：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
3. 迁移窗口内允许短时中断。
4. 本次路径策略已确认：
   - `/data/*` 只作为迁移来源
   - 直装运行目标目录采用官方默认结构（按运行用户确定）

## 路径映射（本次固定）
| 类型 | 旧来源（Docker） | 新目标（直装） |
|---|---|---|
| OpenClaw 主数据 | `/data/openclaw` | `<运行用户默认目录>/.openclaw` |
| 面板配置（如有） | `/data/panel` | 面板直装配置目录（按面板实现） |
| compose 与环境 | `/opt/openclaw` | 仅保留为迁移证据/回滚证据，不作为直装运行目录 |

## 执行步骤（101）

### 1) 备份策略（必须）

#### 1.1 精准备份（默认执行）
```bash
set -euo pipefail
TS=$(date +%F_%H%M%S)
BK=/root/migrate-backup-101-$TS
mkdir -p "$BK"

tar -C / -czf "$BK/data-openclaw.tgz" data/openclaw
tar -C / -czf "$BK/data-panel.tgz" data/panel
tar -C / -czf "$BK/opt-openclaw.tgz" opt/openclaw
tar -C / -czf "$BK/root-ssh.tgz" root/.ssh root/OPENCLAW_WEB_LOGIN.txt

sha256sum "$BK"/*.tgz > "$BK/SHA256SUMS.txt"
echo "backup done: $BK"
```

验收：
- `SHA256SUMS.txt` 存在；
- 4 个压缩包均可 `tar -tzf` 列出内容。

#### 1.2 重型全备（按条件触发，非默认）
仅在以下情况执行：
1. 不确定是否有容器层未挂载数据；
2. 需要“一键整机回滚”能力；
3. 正式批量迁移前的最后一道灾备。

典型全备内容：
- `/var/lib/docker`（体积大，耗时高）
- 整机快照（例如 `vzdump`）

结论：
- 后续面向真实客户小鸡，默认先执行“精准备份”即可，不强制每次做最重全备。

### 2) 下线 Docker 版 OpenClaw（仅停止，不删除）

```bash
set -euo pipefail
cd /opt/openclaw
docker compose ps
docker compose stop
docker ps -a --format 'table {{.Names}}\t{{.Status}}'
```

验收：
- `openclaw-gateway`、`openclaw-panel` 不再运行；
- 容器与镜像仍存在，可随时回滚。

### 3) 官方直装 OpenClaw（非 Docker）

```bash
set -euo pipefail
curl -fsSL https://openclaw.ai/install.sh | bash
```

可选（不重复 onboarding）：

```bash
curl -fsSL https://openclaw.ai/install.sh | bash -s -- --no-onboard
```

### 4) 恢复配置与数据（按目录迁移）

说明：
- 直装目标必须使用官方默认目录（按运行用户确定）。
- 本机历史数据来源在 `/data/openclaw`，迁移时只读该来源并写入官方默认目录。
- 不再把 `/data/openclaw` 作为直装运行时目录。

```bash
set -euo pipefail
RUN_USER=root
RUN_HOME=$(getent passwd "$RUN_USER" | cut -d: -f6)
TARGET_DIR="$RUN_HOME/.openclaw"
mkdir -p "$TARGET_DIR"
# 兼容最小系统：优先 rsync，无 rsync 时使用 cp -a
if command -v rsync >/dev/null 2>&1; then
  rsync -aHAX /data/openclaw/ "$TARGET_DIR/"
else
  cp -a /data/openclaw/. "$TARGET_DIR/"
fi
chown -R "$RUN_USER":"$RUN_USER" "$TARGET_DIR"
```
 
验收补充：
- 运行进程读取路径应命中 `$TARGET_DIR`；
- `/data/openclaw` 仅保留备份来源，不作为在线写入目录。

### 5) 启动与健康检查

```bash
set -euo pipefail
openclaw doctor
openclaw gateway restart
openclaw health
```

验收：
- `doctor` 通过；
- `health` 返回正常；
- 管理页面经隧道 + token 可访问。

### 6) 更新能力验证（为可视化页面改造提供基线）

按安装方式验证：
- `global`：包管理器全局更新到指定版本再回滚；
- `source`：`openclaw update` 及 source pin 回滚。

最小验证：
1. 成功执行一次升级；
2. 成功执行一次回滚；
3. 每次后都执行 `openclaw doctor` + `openclaw health`。

## 回滚预案

触发条件：
- 升级后核心功能不可用（gateway/配置读写/渠道连接失败）。

回滚步骤：
1. 停止直装服务（如已启用 systemd，则 `systemctl stop <service>`）。
2. 恢复 Docker 编排：
   - `cd /opt/openclaw`
   - `docker compose up -d`（因为前面仅 stop，恢复会更快）
3. 若配置已被覆盖，从备份包恢复：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
4. 验证 Docker 版功能恢复。

## 删 Docker 的最终门禁（必须同时满足）
1. 直装版链路验证通过（至少包含 gateway/UI 可访问）。
2. 用户关键资产验收通过（历史会话、记忆、用户文件、脚本）。
3. 可视化面板侧功能在直装路径下可用（避免迁完页面不可用）。
4. 已确认存在可回滚备份包。

满足后才允许执行删除动作：
```bash
cd /opt/openclaw
docker compose down --remove-orphans
docker image prune -f
```

## 与可视化页面更新功能的联动要求
本次迁移完成后，面板更新功能必须同步切换：
1. 不再以 Docker 镜像更新为主。
2. 改为“安装方式识别 -> 对应更新策略（global/source）-> 健康检查”。
3. 更新页面文案与按钮去 Docker 化（移除“拉镜像/应用镜像”等表述）。
4. 后端路径解析默认指向“官方默认目录”，`/data` 仅用于迁移模式与回滚模式。

## 与 Bot 交付输出的联动要求（新增）
1. 必须生成并回传两枚 token：`panel_token`、`gateway_token`。
2. `VM_READY` 必须输出两个本地隧道 URL，并预拼接各自 token：
   - `local_panel_url` 携带 `panel_token`
   - `local_gateway_url` 携带 `gateway_token`
3. 用户复制 URL 后，在已建立 SSH 隧道的前提下应可直接访问，无需手工补 token。
4. 可视化控制台未携带 `panel_token` 或 token 错误时，服务端必须直接返回 `401/403`，不得进入空壳页面。
5. OpenClaw 自带 UI 保持原生 token 输入/连接交互，不强改其页面行为。

## 存量用户切换影响说明（迁移批量前必须固化）
1. SSH：若已改为仅密钥登录，密码登录将不可用；必须先完成公钥验证再关密码。
2. 管理 Web：不再提供公网 `IP:port` 直连入口；用户需先建 SSH 隧道，再打开本地 URL（已带 token）。
3. 业务端口：仍按 50 端口块保留，不受本次管理面策略影响。
4. 数据目录将迁入官方默认结构；用户侧体验不变，但运维侧路径以默认目录为准。

## 参考文档
- 安装：`https://docs.openclaw.ai/install`
- 更新：`https://docs.openclaw.ai/install/updating`
