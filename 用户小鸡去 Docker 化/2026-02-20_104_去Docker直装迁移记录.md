# 2026-02-20_104_去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=104`（`vm-260219-0003`，`10.10.10.13`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 104`）
- 执行日期：2026-02-20
- 执行目标：在可回滚前提下完成“停 Docker 不删 -> 直装接管 -> 数据精准迁移 -> 链路验收”

## 迁移前状态（扫描结论）
1. Docker 容器运行中：
   - `openclaw-panel`（`127.0.0.1:28080->18080`）
   - `openclaw-gateway`（`127.0.0.1:28789->18789`）
2. 数据来源目录存在：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
3. 直装目录迁移前缺失：
   - `/root/.openclaw`
4. 母机配置确认：
   - `qm config 104` 的 `ipconfig0=10.10.10.13/24,gw=10.10.10.1`

## 备份与校验（已完成）
1. 精准备份目录：`/root/migrate-backup-104-2026-02-20_072934`
2. 备份包：
   - `data-openclaw.tgz`
   - `data-panel.tgz`
   - `opt-openclaw.tgz`
   - `root-ssh.tgz`
3. 校验文件：`SHA256SUMS.txt`
4. 校验结果：
   - `sha256sum -c` 全部 `OK`
   - 每个 `*.tgz` 均可 `tar -tzf` 成功读取

## 执行动作（已完成）
1. 停 Docker（不删除）：
   - 在 `/opt/openclaw` 执行 `docker compose stop`
   - 容器状态变为 `Exited`
2. 修复直装运行时：
   - 发现历史环境存在 `openclaw` 命令壳子，但 `node` 缺失
   - 首轮安装因并发触发两路 `npm install openclaw@latest` 卡住
   - 处理：清理并发安装进程，改为单次串行安装
   - 结果：`node v22.22.0`、`openclaw 2026.2.19-2`
3. 数据迁移到官方默认目录：
   - 来源：`/data/openclaw`
   - 目标：`/root/.openclaw`
   - 同步方式：`rsync -aHAX --delete`
   - 权限修正：`chown -R root:root /root/.openclaw`
4. 网关配置改造：
   - 文件：`/root/.openclaw/openclaw.json`
   - 关键变更：
     - `gateway.port=28789`
     - `gateway.remote.url=ws://127.0.0.1:28789`
   - 配置备份：`/root/.openclaw/openclaw.json.bak.20260220073314`
5. 面板直装部署：
   - 发布版本：`v2026.02.20-r4`
   - 发布仓库：`Bianshumeng/openclaw-panel-public`
   - 安装目录：`/opt/openclaw-panel`
   - 版本标记：`/opt/openclaw-panel/.panel-release.json`
6. 面板配置切换：
   - 配置文件：`/etc/openclaw-panel/panel.config.json`
   - 关键参数：
     - `runtime.mode=systemd`
     - `panel.listen_host=127.0.0.1`
     - `panel.listen_port=28080`
     - `openclaw.config_path=/root/.openclaw/openclaw.json`
     - `openclaw.gateway_port=28789`
     - `docker.enabled=false`
7. systemd 服务创建与启用：
   - `/etc/systemd/system/openclaw-gateway.service`
   - `/etc/systemd/system/openclaw-panel.service`
   - 状态：`enabled + active`
8. 权限等级确认：
   - `openclaw-gateway` 服务 `User=root`，主进程用户 `root`
   - `openclaw-panel` 服务 `User=root`，主进程用户 `root`

## 验证证据
1. 端口监听：
   - `127.0.0.1:28080`（panel）
   - `127.0.0.1:28789`（gateway）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（nginx 前端）
2. HTTP 验证：
   - `http://127.0.0.1:28080/ => 200`
   - `http://127.0.0.1:28789/ => 200`
   - `http://127.0.0.1:18080/ => 401`（前置认证正常）
   - `http://127.0.0.1:18789/ => 401`（前置认证正常）
3. 更新接口：
   - `GET /api/update/check?target=bot => currentTag=2026.2.19-2`
   - `GET /api/update/check?target=panel => currentTag=v2026.02.20-r4`
4. 数据一致性抽样：
   - `sessions: 1 -> 1`
   - `workspace files: 25 -> 25`
5. Docker 保留状态（门禁通过）：
   - `openclaw-panel Exited`
   - `openclaw-gateway Exited`

## 风险与回滚
1. 当前风险：
   - 首次安装阶段出现“并发安装卡住”风险，已通过串行安装修复。
2. 快速回滚步骤：
   - `systemctl stop openclaw-gateway openclaw-panel`
   - `cd /opt/openclaw && docker compose start`
3. 配置回滚：
   - 若网关配置异常，回退到 `/root/.openclaw/openclaw.json.bak.20260220073314`
4. 数据回滚：
   - 从 `/root/migrate-backup-104-2026-02-20_072934` 恢复

## 当前结论
1. 104 已完成去 Docker 化直装接管，主链路可用。
2. 已满足“先停 Docker 不删、验收通过后再删 Docker”的门禁要求。
3. 当前保留 Docker 容器为 `stopped`，尚未执行删除，便于快速回滚。

## 经验记录（防复发）
1. 同一台机器禁止并发触发安装脚本；若超时重试，先确认无遗留 `npm install openclaw@latest` 进程。
2. 处理“`openclaw` 在、`node` 不在”的半安装状态时，优先走单次串行安装并验 `node/openclaw` 版本。
3. 删 Docker 必须后置到用户验收通过，避免中间问题失去快速回切能力。
