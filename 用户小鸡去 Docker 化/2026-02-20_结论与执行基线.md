# 2026-02-20_结论与执行基线

## 文档目的
把当前对话中已经确认的目标、边界、先后顺序和已完成证据写死，避免后续执行跑偏。

## 已确认的目标（最终口径）
1. 最终要实现“用户几乎无感”的去 Docker 化迁移：安装方式改为直装，但用户数据和使用体验保持连续。
2. 必须保留并可恢复以下用户资产：
   - 历史对话
   - 记忆数据
   - 服务器中用户新增文件
   - 让 Bot 生成/保存的脚本与配置
3. 管理面连接口径：
   - 仅输出 SSH 脚本和隧道后的本地访问地址
   - 不再依赖管理 Web 公网直连地址
4. 业务端口口径不变：每台小鸡 50 端口块策略保持不变。
5. 路径策略统一为“官方默认结构”：
   - 新开小鸡使用直装官方默认数据目录
   - 存量迁移目标也写入官方默认数据目录
   - `/data/*` 仅作为迁移来源与备份来源，不作为长期运行目录

## 已确认的边界（防止加戏）
1. 当前阶段不改 SSH 策略（你明确说“现在先不改 SSH”）。
2. 存量用户小鸡迁移必须“先停不删 Docker -> 直装验证 -> 验收通过后再删 Docker”。
3. 本轮不新增“token 轮换”需求，不引入额外需求项。

## 实施顺序（按当前确认）
1. 先完成 101 小鸡备份（已完成，见下文证据）。
2. 先完成“龙虾可视化页面”对直装运行时的适配（这是迁移前置门禁）。
3. 页面适配验收通过后，再对 101 执行去 Docker 化迁移演练。
4. 101 演练通过后，固化 SOP，再批量迁移存量用户小鸡。

## 101 已完成备份证据（最新）

### A. 逻辑全量备份（最新有效）
- 目录：`/root/migrate-backup-101-2026-02-20_021222`
- 内容包：
  - `data.tgz`
  - `opt-openclaw.tgz`
  - `root-home.tgz`
  - `etc.tgz`
  - `usr-local.tgz`
  - `var-lib-docker.tgz`
- 校验：`SHA256SUMS.txt` 已生成
- 备注：此次备份已包含你“重新登录后新增写入”的内容（`data/openclaw/openclaw.json` 时间戳已更新）。

### B. 整机回滚备份（灾备）
- 文件：`/var/lib/vz/dump/vzdump-qemu-101-2026_02_19-18_58_12.vma.zst`
- 对应日志：`/var/lib/vz/dump/vzdump-qemu-101-2026_02_19-18_58_12.log`
- SHA256：`184bb1ccffcc70ad48a1799f78c8a80fc1c9a44077da9314eb0707d0a5282cad`

### C. 备份异常处理记录
- 目录 `/root/migrate-backup-101-2026-02-20_020922` 因递归打包风险已判定为无效并清理。
- 后续备份命令已加入排除规则（排除历史备份目录），避免再次递归膨胀。

## 后续迁移时的数据恢复原则
1. 先恢复宿主机核心数据目录，再启动直装服务。
2. 迁移目标必须落到官方默认数据目录（按运行用户解析），不再长期运行在 `/data/openclaw`。
3. `/data/openclaw` 与 `/data/panel` 保留为迁移来源/回滚来源，不作为直装运行时主目录。
4. 恢复后必须按用户视角验收，不只看服务进程是否启动。

## 迁移验收（用户视角）
1. 历史会话可见且可继续。
2. 记忆内容可读写。
3. 用户新增文件和脚本仍存在且可执行。
4. 可视化页面可正常连接和操作（在新运行时下）。
5. 面板后端路径探测返回“官方默认目录命中”，不依赖 `/data` 作为在线运行路径。

## 当前状态结论
1. 101 已完成第一轮“先停不删 Docker -> 直装 -> 数据迁移 -> 自带 UI 联调”验证。
2. 默认备份策略已确定为“精准备份优先”，全量重备仅在特定风险场景触发。
3. 下一阶段仍是可视化页面适配与联调，未到批量迁移阶段。

## 经验固化（可复制到真实客户小鸡）
1. 默认不做最重全备：先做精准备份（`/data/openclaw`、`/data/panel`、`/opt/openclaw`、`/root/.ssh`）即可显著提速。
2. 只有在“容器层数据不确定 / 需要整机级回滚 / 批量迁移前最终灾备”时，才补全量备份（`/var/lib/docker`、vzdump）。
3. 迁移顺序固定：
   - 停 Docker（不删）
   - 安装直装版并启动
   - 对照映射迁移关键数据到官方默认目录
   - 用户视角验收通过
   - 最后删除 Docker
4. 这套顺序的价值是：回滚快、风险低、用户感知最小。
