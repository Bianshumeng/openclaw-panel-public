# 2026-02-20_107_去Docker直装迁移记录

## 基本信息
- 目标机器：`vmid=107`（`vm-260219-0006`，`10.10.10.16`）
- 执行入口：母机 `9900K-1` 通过 QGA（`qm guest exec 107`）
- 执行日期：2026-02-20
- 执行目标：按 SOP 完成“停 Docker 不删 -> 直装接管 -> 数据精准迁移 -> 可用性验收”

## 迁移前状态（扫描结论）
1. Docker 容器运行中：
   - `openclaw-panel`（`127.0.0.1:28080->18080`）
   - `openclaw-gateway`（`127.0.0.1:28789->18789`）
2. 数据来源目录存在：
   - `/data/openclaw`
   - `/data/panel`
   - `/opt/openclaw`
3. 直装目录缺失：
   - `/root/.openclaw`（迁移前不存在）

## 备份与校验（已完成）
1. 精准备份目录：`/root/migrate-backup-107-2026-02-20_072911`
2. 备份包：
   - `data-openclaw.tgz`
   - `data-panel.tgz`
   - `opt-openclaw.tgz`
   - `root-ssh.tgz`
3. 校验文件：`SHA256SUMS.txt`
4. 校验结果：`sha256sum -c` 全部 `OK`

## 执行动作（已完成）
1. 停 Docker（不删除）：
   - 在 `/opt/openclaw` 执行 `docker compose stop`
   - 容器状态变为 `Exited`
2. 直装运行时补齐：
   - 官方脚本安装后 `node v22.22.0` 与 `openclaw 2026.2.19-2` 可用
3. 数据迁移到官方默认目录：
   - 来源：`/data/openclaw`
   - 目标：`/root/.openclaw`
   - 同步方式：`rsync -aHAX --delete`
   - 权限修正：`chown -R root:root /root/.openclaw`
4. 网关配置改造（对齐现有 Nginx 转发）：
   - 文件：`/root/.openclaw/openclaw.json`
   - 备份：`/root/.openclaw/openclaw.json.bak.20260220073246`
   - 关键变更：
     - `gateway.port=28789`
     - `gateway.bind=loopback`
     - `gateway.mode=remote`
     - `gateway.remote.url=ws://127.0.0.1:28789`
     - `gateway.controlUi.allowedOrigins` 追加 `http://127.0.0.1:18789` 和 `http://localhost:18789`
5. 直装 panel 部署：
   - 版本：`v2026.02.20-r4`
   - 仓库：`Bianshumeng/openclaw-panel-public`
   - 目录：`/opt/openclaw-panel`
   - 版本标记：`/opt/openclaw-panel/.panel-release.json`
6. 面板配置切换：
   - 配置文件：`/etc/openclaw-panel/panel.config.json`
   - 关键参数：
     - `runtime.mode=systemd`
     - `panel.listen_host=127.0.0.1`
     - `panel.listen_port=28080`
     - `openclaw.config_path=/root/.openclaw/openclaw.json`
     - `openclaw.gateway_port=28789`
     - `docker.enabled=false`
7. 创建并启用 systemd 服务：
   - `/etc/systemd/system/openclaw-gateway.service`
   - `/etc/systemd/system/openclaw-panel.service`
   - 启用状态：`enabled + active`
   - 运行用户：均为 `root`

## 验证证据
1. 端口监听：
   - `127.0.0.1:28080`（panel）
   - `127.0.0.1:28789`（gateway）
   - `0.0.0.0:18080`、`0.0.0.0:18789`（nginx 前置）
2. HTTP 验证：
   - `http://127.0.0.1:28080/ => 200`
   - `http://127.0.0.1:28789/ => 200`
   - `http://127.0.0.1:18080/ => 401`（前置认证正常）
   - `http://127.0.0.1:18789/ => 401`（前置认证正常）
3. 更新接口验证：
   - `GET /api/update/check?target=bot => currentTag=2026.2.19-2`
   - `GET /api/update/check?target=panel => currentTag=v2026.02.20-r4`
4. 数据完整性抽样：
   - `sessions` 文件数：`6 -> 6`
   - `workspace` 文件数：`25 -> 25`
5. Docker 保留态确认（未删）：
   - `openclaw-panel`：`Exited`
   - `openclaw-gateway`：`Exited`

## 当前结论
1. `107` 已完成去 Docker 化直装接管，核心链路可用。
2. 当前仍保留 Docker 容器（停止态），满足“先验证后删除”的门禁要求。
3. 可进入“用户实测 -> 确认后删 Docker 收尾”阶段。

## 风险与回滚
1. 若用户实测异常，立即回滚：
   - `systemctl stop openclaw-gateway openclaw-panel`
   - `cd /opt/openclaw && docker compose start`
2. 若配置损坏，恢复：
   - `openclaw.json` 回退到 `openclaw.json.bak.20260220073246`
   - 数据回退到 `/root/migrate-backup-107-2026-02-20_072911/*`

## 经验记录
1. 直装安装脚本在 QGA 下可能超过会话超时，不能按“命令返回超时”直接判失败，必须用 `node/openclaw` 版本探针做结果确认。
2. `panel.config.json` 若来源文件已有 `log.file_path`，当前脚本会保留旧值；若要完全对齐直装日志目录，需在下一轮规则中明确“覆盖而非 setdefault”。
