import{api as e,getInputValue as l,setInput as t,setMessage as s,setText as i,skillsPageState as n}from"../core/panel-core.js";function r(e,l=72){const t=String(e||"").trim();return t?t.length<=l?t:`${t.slice(0,l-1)}…`:"-"}function a(e,l=""){const t=document.querySelector("#skills_save_result");t&&(t.textContent=e,t.classList.toggle("success","success"===l),t.classList.toggle("fail","fail"===l))}function o(){t("skills_edit_enabled",!1),t("skills_edit_apikey",""),t("skills_edit_clear_apikey",!1),t("skills_edit_env",""),a("选择一个 Skill 后可编辑配置。","")}function c(e=[]){const l=document.querySelector("#skills_list");if(l){if(l.innerHTML="",!Array.isArray(e)||0===e.length){const e=document.createElement("p");return e.className="muted-line",e.textContent="暂无可展示的 Skills。",void l.appendChild(e)}e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="skill-row",String(e?.key||"")===n.selectedSkillKey&&t.classList.add("is-selected"),t.innerHTML=`\n      <span class="skill-row-main">${r(e?.key||"-",40)}</span>\n      <span class="skill-row-meta">${e?.enabled?"已启用":"未启用"} · 更新 ${e?.updatedAtText||"-"}</span>\n      <span class="skill-row-desc">${r(e?.summary||"暂无说明",80)}</span>\n    `,t.addEventListener("click",()=>{k(String(e?.key||"").trim(),{silent:!1}).catch(e=>s(e.message||"Skill 配置读取失败","error"))}),l.appendChild(t)})}}async function k(l,{silent:r=!1}={}){const k=String(l||"").trim();if(!k)return n.selectedSkillConfig=null,n.selectedSkillKey="",o(),void c(n.skills);const d=await e(`/api/skills/${encodeURIComponent(k)}/config`);n.selectedSkillConfig=d?.result||null,n.selectedSkillKey=k;const S=d?.result||{};t("skills_edit_enabled",!!S.enabled),t("skills_edit_apikey",""),t("skills_edit_clear_apikey",!1),t("skills_edit_env",JSON.stringify(S.env||{},null,2)),i("skills_selected_key",k),a(S.apiKeyMasked?`当前 API Key：${S.apiKeyMasked}（可留空保持不变）`:"当前未设置 API Key",""),c(n.skills),r||s(`已加载 Skill：${k}`,"ok")}async function d({silent:l=!1,preserveSelection:t=!0,selectedSkillKey:r=""}={}){const a=await e("/api/skills/status"),d=Array.isArray(a?.result?.skills)?a.result.skills:[];n.skills=d;const S=String(r||"").trim(),u=String(n.selectedSkillKey||"").trim();let y="";S&&d.some(e=>String(e?.key||"").trim()===S)?y=S:t&&u&&d.some(e=>String(e?.key||"").trim()===u)?y=u:d.length>0&&(y=String(d[0]?.key||"").trim()),n.selectedSkillKey=y,c(d),y?await k(y,{silent:!0}):(n.selectedSkillConfig=null,i("skills_selected_key","未选择"),o()),l||s(`Skills 状态已刷新（${d.length} 项）`,"ok")}function S(){n.bound||(n.bound=!0,document.querySelector("#skills_refresh")?.addEventListener("click",()=>{d({silent:!1,preserveSelection:!0}).catch(e=>s(e.message||"Skills 刷新失败","error"))}),document.querySelector("#skills_toggle_enabled")?.addEventListener("click",async()=>{const l=String(n.selectedSkillKey||"").trim();if(!l)return void s("请先选择一个 Skill","error");const t=n.skills.find(e=>String(e?.key||"").trim()===l);if(!t)return s("当前 Skill 不存在，已刷新列表","error"),void await d({silent:!0,preserveSelection:!1});const i=!t.enabled;!function(e,l){const t=String(e?.riskLevel||"").trim().toLowerCase();return l&&"restricted"===t?window.confirm(`Skill "${e?.key}" 标记为受限能力，启用后可能影响运行态，确认继续吗？`):!!l||window.confirm(`确认停用 Skill "${e?.key}"？停用后相关能力将立即不可用。`)}(t,i)?s("已取消 Skill 操作","info"):(await async function(l,t){const i=await e(`/api/skills/${encodeURIComponent(l)}/enabled`,{method:"POST",body:JSON.stringify({enabled:!!t})});s(i.message||"Skill 状态已更新",i.ok?"ok":"error")}(l,i),await d({silent:!0,preserveSelection:!0,selectedSkillKey:l}))}),document.querySelector("#skills_save_config")?.addEventListener("click",()=>{(async function(){const t=String(n.selectedSkillKey||"").trim();if(!t)throw new Error("请先选择一个 Skill");const i=function(){const e=!!l("skills_edit_enabled"),t=String(l("skills_edit_apikey")||"").trim(),s=!!l("skills_edit_clear_apikey"),i=function(e){const l=String(e||"").trim();if(!l)return{};let t;try{t=JSON.parse(l)}catch{throw new Error("环境变量 JSON 格式不合法")}if(!t||"object"!=typeof t||Array.isArray(t))throw new Error("环境变量必须是对象 JSON");const s={};return Object.entries(t).forEach(([e,l])=>{const t=String(e||"").trim();t&&(s[t]=null==l?"":String(l))}),s}(l("skills_edit_env"));return{enabled:e,apiKey:t,clearApiKey:s,env:i}}(),r=await e(`/api/skills/${encodeURIComponent(t)}/config`,{method:"PUT",body:JSON.stringify(i)});a(r.message||"保存完成",r.ok?"success":"fail"),s(r.message||"Skill 配置已更新",r.ok?"ok":"error"),await d({preserveSelection:!0,selectedSkillKey:t})})().catch(e=>{a(e.message||"保存失败","fail"),s(e.message||"Skill 配置保存失败","error")})}))}export{d as loadSkillsStatus,S as setupSkillsPage};