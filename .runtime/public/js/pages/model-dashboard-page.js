import{AICODECAT_PROVIDER as e,DASHBOARD_CONTEXT_KEY as t,DEFAULT_MODEL_OPTIONS as r,MODEL_PROFILE_BY_FAMILY as o,MODEL_TEMPLATE_MAP as n,api as i,buildDefaultModelEntry as d,buildModelPayload as a,createDashboardStatusTag as s,dashboardSummaryState as m,formatLocalTime as c,getDashboardContextTokens as l,getInputValue as u,modelEditorState as p,modelFamilyById as _,normalizeModelDraft as g,parseModelRef as v,setInput as f,setMessage as y,setStackListEmpty as h,setText as S,toNonNegativeInt as b}from"../core/panel-core.js";import{resolveAicodecatBaseUrl as w,resolveProviderId as k}from"../../config-generator.js";function x(e,t){return{ref:`${e.id}/${t.id}`,providerId:e.id,providerApi:e.api,providerBaseUrl:e.baseUrl,modelId:t.id,modelName:t.name||t.id,contextWindow:Number(t.contextWindow||0)||void 0,maxTokens:Number(t.maxTokens||0)||void 0,thinkingStrength:String(t?.thinkingStrength||"").trim()||"无"}}function E(e,t){const r=String(t||"").trim();if(!r)return null;const o=function(e){const t=Array.isArray(e?.catalog?.providers)?e.catalog.providers:[],r=[];return t.forEach(e=>{(Array.isArray(e?.models)?e.models:[]).forEach(t=>{r.push(x(e,t))})}),r}(e).find(e=>e.ref===r);return o||(String(e?.primary||"").trim()===r?{ref:r,providerId:e?.providerId,providerApi:e?.providerApi,providerBaseUrl:e?.providerBaseUrl,modelId:e?.modelId,modelName:e?.modelName||e?.modelId,contextWindow:Number(e?.contextWindow||0)||void 0,maxTokens:Number(e?.maxTokens||0)||void 0,thinkingStrength:String(e?.thinkingStrength||"").trim()||"无"}:null)}function I(e,t){const r=String(e||"").trim(),o=String(p.currentModelSettings?.primary||p.currentModelPayload?.primary||"").trim();return u(t)?r||o:o||r}async function $(e,t,r="已切换默认模型到"){if(!t?.ref||!t?.modelId)throw new Error("目标模型无效，请重新选择");if(!function(e,t){const r=Number(e?.contextWindow||0)||void 0,o=Number(t?.contextWindow||0)||void 0,n=l();return o&&null!==n&&n>o?window.confirm(`当前会话上下文约 ${n.toLocaleString()}，目标模型上限为 ${o.toLocaleString()}。\n切换后可能因上下文超限报错，确认继续切换吗？`):!(o&&null===n&&r&&r>o)||window.confirm(`目标模型上下文上限更小（${o.toLocaleString()}），但你还没填写“当前会话上下文”。\n如果当前会话已超过目标上限，切换后会报错。确认继续切换吗？`)}(e,t))return;const o=a({primary:t.ref,providerId:t.providerId,providerApi:t.providerApi,providerBaseUrl:t.providerBaseUrl,providerApiKey:"",modelId:t.modelId,modelName:t.modelName||t.modelId,contextWindow:t.contextWindow||2e5,maxTokens:t.maxTokens||8192,providerModels:[]});await ke(o,`${r} ${t.modelId}`)}function T(e){if(!e)return void S("dashboard_quick_switch_hint","请选择目标模型后再切换。");const t=v(e.ref),r=String(e?.modelId||t.modelId||e?.modelName||"-").trim()||"-",o=String(e?.providerId||t.providerId||"-").trim()||"-";S("dashboard_quick_switch_hint",`将切换到：${r}（${o}）`)}function C(e){const t=document.querySelector("#dashboard_quick_model_ref");if(!(t instanceof HTMLSelectElement))return;const r=[],o=new Set;p.defaultModelRefs.forEach(t=>{const n=String(t?.ref||"").trim();if(!n||o.has(n))return;const i=E(e,n)||t;r.push(i),o.add(n)});const n=String(e?.primary||"").trim();if(0===r.length&&n){const t=E(e,n);t&&r.push(t)}t.innerHTML="",r.forEach(e=>{const r=document.createElement("option");r.value=e.ref;const o=v(e.ref),n=String(e?.modelId||o.modelId||e?.modelName||e.ref||"").trim(),i=String(e?.providerId||o.providerId||"-").trim()||"-";r.textContent=`${n||"-"}（${i}）`,t.appendChild(r)}),r.some(e=>e.ref===n)?t.value=n:r.length>0&&(t.selectedIndex=0),T(r.find(e=>e.ref===t.value)||r[0]||null)}function L(e){const t=document.querySelector("#model_add_workspace"),r=document.querySelector("#model_add_toggle");if(!t||!r)return;const o=!!e;t.classList.toggle("is-hidden",!o),t.setAttribute("aria-hidden",o?"false":"true"),r.setAttribute("aria-expanded",o?"true":"false"),r.classList.toggle("is-active",o),r.title=o?"关闭添加模型面板":"添加模型";const n=r.querySelector("span");n&&(n.textContent=o?"×":"+")}const A={pending:!1,providerEditId:"",modelEditProviderId:"",modelEditId:"",dialogBound:!1},M={bound:!1,pending:!1,lastSyncMtimeMs:null};function N(e){const t=document.querySelector(`#${e}`);return t&&"function"==typeof t.show&&"function"==typeof t.hide?t:null}function q(e){const t=N(e);t&&t.show()}function W(e){const t=N(e);t&&t.hide()}function U(e,t){const r=String(e||"").trim();if(!r)return;const o=Number(r);if(!Number.isFinite(o)||o<=0)throw new Error(`${t} 必须是正整数`);return Math.floor(o)}async function B(e){if(A.pending)y("模型配置正在写入，请稍等片刻再操作","info");else{A.pending=!0;try{await e()}finally{A.pending=!1}}}function H(e,t="info"){const r=document.querySelector("#model_raw_config_status");r&&(r.textContent=String(e||"").trim(),r.classList.toggle("is-fail","error"===t),r.classList.toggle("is-done","ok"===t))}function P(e,t,r="info"){const o=document.querySelector(`#${e}`);o&&(o.textContent=String(t||"").trim(),o.classList.toggle("is-working","working"===r),o.classList.toggle("is-done","ok"===r),o.classList.toggle("is-fail","error"===r))}function D(e){const t=!!e;document.querySelector("#model_raw_config_reload")?.toggleAttribute("disabled",t),document.querySelector("#model_raw_config_save")?.toggleAttribute("disabled",t)}function R(e={}){const t=document.querySelector("#model_raw_config_editor");t instanceof HTMLTextAreaElement&&(t.value=String(e.rawText||""),M.lastSyncMtimeMs=Number.isFinite(Number(e.mtimeMs))?Number(e.mtimeMs):null,S("model_raw_config_mtime",e.mtimeMs?c(e.mtimeMs):"-"),S("model_raw_config_size",Number.isFinite(e.size)?`${e.size} bytes`:"-"))}async function O({silent:e=!1}={}){if(document.querySelector("#model_raw_config_editor")instanceof HTMLTextAreaElement&&!M.pending){M.pending=!0,D(!0),H("正在读取真实配置文件...","info");try{const t=await i("/api/openclaw-config/raw");R(t),!1===t.exists?H("配置文件当前不存在，你可以粘贴 JSON 后直接保存创建。","info"):H("已与真实配置文件同步。","ok"),!e&&t.path&&y(`已读取真实配置文件：${t.path}`,"ok")}catch(t){H(`读取失败：${t.message||String(t)}`,"error"),e||y(t.message||String(t),"error")}finally{M.pending=!1,D(!1)}}}async function G(e=""){const t=(await i("/api/settings"))?.settings?.model;if(!t||"object"!=typeof t)throw new Error("模型配置刷新失败，请手动刷新页面");K(t),he(t),e&&y(e,"ok")}function j(e={},t={}){const r=String(e?.id||t?.providerId||"").trim(),o=String(t?.modelId||t?.id||"").trim();r&&o?(A.modelEditProviderId=r,A.modelEditId=o,f("model_item_edit_provider",r),f("model_item_edit_id",o),f("model_item_edit_name",String(t?.modelName||t?.name||o).trim()||o),f("model_item_edit_context_window",t?.contextWindow||""),f("model_item_edit_max_tokens",t?.maxTokens||""),q("model_item_edit_dialog")):y("模型数据无效，无法编辑","error")}function F(e){const t=String(e||"").trim(),r="custom"===t||"existing"===t?t:"template";p.providerMode=r;const o={template:"直接添加模型：选择或自定义模型 ID，每次只写入一个模型。",custom:"新增供应商并添加模型：创建供应商并只写入一个模型。",existing:"基于已有供应商添加：不会新建供应商，每次只写入一个模型。"};S("model_provider_mode_hint",o[r]||o.template),document.querySelectorAll("[data-model-provider-mode]").forEach(e=>{const t=String(e.getAttribute("data-model-provider-mode")||"").trim()===r;e.classList.toggle("is-active",t),e.setAttribute("aria-pressed",t?"true":"false")}),document.querySelectorAll("[data-model-provider-mode-panel]").forEach(e=>{const t=String(e.getAttribute("data-model-provider-mode-panel")||"").trim();e.classList.toggle("is-hidden",t!==r)})}function V(e,t){const r=e||{};f("model_current_primary",t||""),f("model_current_provider",r.providerId||""),f("model_current_api",r.providerApi||""),f("model_current_baseurl",r.providerBaseUrl||""),f("model_current_id",r.modelId||""),f("model_current_name",r.modelName||r.modelId||""),f("model_current_context_window",r.contextWindow||""),f("model_current_max_tokens",r.maxTokens||"")}function K(e){const t=document.querySelector("#model_provider_cards");if(!t)return;const r=function(e){const t=Array.isArray(e?.catalog?.providers)?e.catalog.providers:[];if(t.length>0)return t;const r=String(e?.modelId||"").trim();return r?[{id:String(e?.providerId||"").trim(),api:String(e?.providerApi||"").trim(),baseUrl:String(e?.providerBaseUrl||"").trim(),models:[{id:r,name:String(e?.modelName||r).trim()||r,contextWindow:Number(e?.contextWindow||0)||void 0,maxTokens:Number(e?.maxTokens||0)||void 0,thinkingStrength:String(e?.thinkingStrength||"").trim()||"无"}]}]:[]}(e),o=String(e?.primary||"").trim(),n=v(o);if(t.innerHTML="",0===r.length){const e=document.createElement("article");e.className="model-provider-group model-provider-group-empty";const r=document.createElement("div");r.className="model-provider-empty-body";const o=document.createElement("p");o.className="model-provider-empty-title",o.textContent="当前配置没有可用提供商和模型";const n=document.createElement("p");n.className="model-provider-empty-hint",n.textContent="你可以先添加一个供应商和模型，然后回到这里管理。";const i=document.createElement("a");return i.className="model-provider-empty-action",i.href="/model/add",i.textContent="点击添加",i.setAttribute("aria-label","点击添加模型"),r.appendChild(o),r.appendChild(n),r.appendChild(i),e.appendChild(r),t.appendChild(e),f("dashboard_current_model","-"),f("dashboard_current_provider","-"),f("dashboard_current_context_window","-"),void f("dashboard_current_thinking_strength","无")}r.forEach(r=>{const n=Array.isArray(r?.models)?r.models:[];if(0===n.length)return;const d=document.createElement("article");d.className="model-provider-group";const a=String(r?.id||"").trim();if(a){const e=document.createElement("div");e.className="model-provider-group-head";const t=document.createElement("div");t.className="model-provider-group-head-row";const o=document.createElement("h3");o.className="model-provider-group-title",o.textContent=a,t.appendChild(o);const n=document.createElement("div");n.className="model-provider-group-actions";const s=document.createElement("button");s.type="button",s.className="model-provider-action-btn",s.textContent="编辑供应商",s.addEventListener("click",()=>{!function(e={}){const t=String(e?.id||"").trim();t?(A.providerEditId=t,f("model_provider_edit_id",t),f("model_provider_edit_api",String(e?.api||"").trim()),f("model_provider_edit_baseurl",String(e?.baseUrl||"").trim()),f("model_provider_edit_apikey",""),q("model_provider_edit_dialog")):y("供应商数据无效，无法编辑","error")}(r)}),n.appendChild(s);const m=document.createElement("button");m.type="button",m.className="model-provider-action-btn model-provider-action-btn-danger",m.textContent="删除供应商",m.addEventListener("click",()=>{B(async()=>{await async function(e={}){const t=String(e?.id||"").trim();if(!t)throw new Error("供应商标识无效");const r=Array.isArray(e?.models)?e.models:[];window.confirm(`确认删除供应商 ${t} 吗？\n将连带删除其下 ${r.length} 个模型。`)&&(await i(`/api/models/providers/${encodeURIComponent(t)}`,{method:"DELETE"}),await G(`供应商 ${t} 已删除`))}(r)}).catch(e=>{y(e.message||String(e),"error")})}),n.appendChild(m),t.appendChild(n);const c=document.createElement("p");c.className="model-provider-group-meta",c.textContent=`API: ${r.api||"-"} | Base URL: ${r.baseUrl||"-"}`,e.appendChild(t),e.appendChild(c),d.appendChild(e)}const s=document.createElement("div");s.className="model-chip-grid",n.forEach(t=>{const n=x(r,t),d=`${String(r?.id||"").trim()}/${String(t?.id||"").trim()}`.replace(/^\/+/,""),a=String(n.ref||d).trim();n.ref=a;const m=!!(n.ref&&String(n.providerId||"").trim()&&String(n.modelId||"").trim()),c=a===o||String(n.modelId||"").trim()===String(e?.modelId||"").trim()&&String(n.providerId||"").trim()===String(e?.providerId||"").trim(),l=function(e={}){const t=`${String(e?.modelId||"").trim().toLowerCase()} ${String(e?.modelName||"").trim().toLowerCase()}`.trim();return t.startsWith("claude")||t.includes(" claude")?"claude":t.startsWith("gemini")||t.includes(" gemini")?"gemini":t.startsWith("gpt")||t.includes(" gpt")?"gpt":"other"}(n),u=document.createElement("article");u.className=`model-chip family-${l}${c?" is-current":""}`,u.classList.toggle("is-disabled",!m),u.title=m?"点击卡片编辑模型":"模型信息不完整，暂不可编辑",m&&(u.tabIndex=0,u.setAttribute("role","button"));const p=document.createElement("span");p.className="model-chip-name",p.textContent=String(n.modelName||n.modelId||"-").trim()||"-",u.appendChild(p);const _=document.createElement("span");_.className="model-chip-meta";const g=n.contextWindow&&n.contextWindow>0?`Context ${Number(n.contextWindow).toLocaleString()}`:"Context -",v=n.maxTokens&&n.maxTokens>0?`Max ${Number(n.maxTokens).toLocaleString()}`:"Max -";if(_.textContent=`${n.modelId||"-"} | ${g} | ${v}`,u.appendChild(_),c){const e=document.createElement("span");e.className="model-chip-current",e.textContent="当前使用",u.appendChild(e)}const f=document.createElement("div");f.className="model-chip-actions";const h=document.createElement("button");if(h.type="button",h.className="model-chip-action",h.textContent="编辑",h.disabled=!m,h.addEventListener("click",e=>{e.stopPropagation(),m&&j(r,n)}),f.appendChild(h),!c){const t=document.createElement("button");t.type="button",t.className="model-chip-action",t.textContent="设为默认",t.disabled=!m,t.addEventListener("click",t=>{t.stopPropagation(),m&&B(async()=>{await $(e,n)}).catch(e=>{y(e.message||String(e),"error")})}),f.appendChild(t)}const S=document.createElement("button");S.type="button",S.className="model-chip-action model-chip-action-danger",S.textContent="删除",S.disabled=!m,S.addEventListener("click",e=>{e.stopPropagation(),m&&B(async()=>{await async function(e={},t={}){const r=String(e?.id||t?.providerId||"").trim(),o=String(t?.modelId||t?.id||"").trim();if(!r||!o)throw new Error("模型标识无效");window.confirm(`确认删除模型 ${r}/${o} 吗？\n删除后将无法自动恢复。`)&&(await i(`/api/models/providers/${encodeURIComponent(r)}/models/${encodeURIComponent(o)}`,{method:"DELETE"}),await G(`模型 ${r}/${o} 已删除`))}(r,n)}).catch(e=>{y(e.message||String(e),"error")})}),f.appendChild(S),u.appendChild(f),m&&(u.addEventListener("click",e=>{e.target instanceof HTMLElement&&e.target.closest(".model-chip-action")||j(r,n)}),u.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||e.target instanceof HTMLElement&&e.target.closest(".model-chip-action")||(e.preventDefault(),j(r,n))})),s.appendChild(u)}),d.appendChild(s),t.appendChild(d)}),f("dashboard_current_model",e.modelId||n.modelId||"-"),f("dashboard_current_provider",e.providerId||n.providerId||"-"),f("dashboard_current_context_window",e.contextWindow?`${Number(e.contextWindow).toLocaleString()} tokens`:"-"),f("dashboard_current_thinking_strength",e.thinkingStrength||"无")}let J=!1,z=!1,Y=!1,Q=!1,X=!1;function Z(e,t="info"){const r=document.querySelector("#dashboard_gateway_token_status");r&&(r.textContent=String(e||"").trim(),r.classList.toggle("is-done","ok"===t),r.classList.toggle("is-fail","error"===t))}function ee(e,t="info"){const r=document.querySelector("#dashboard_gateway_pairing_status");r&&(r.textContent=String(e||"").trim(),r.classList.toggle("is-done","ok"===t),r.classList.toggle("is-fail","error"===t))}function te(e={}){const t=Number(e.pendingCount||0),r=Number(e.approvedCount||0),o=Number(e.failedCount||0),n=!1!==e?.ok,i=String(e.message||"").trim();return 0===t?{state:"empty",pendingCount:t,approvedCount:r,failedCount:o,message:i}:!n||o>0?{state:"failed",pendingCount:t,approvedCount:r,failedCount:o,message:i||"存在审批失败项"}:{state:"approved",pendingCount:t,approvedCount:r,failedCount:o,message:i||`已批准 ${r} 个待处理配对请求`}}async function re(e){const t=Math.max(0,Number(e)||0);await new Promise(e=>{window.setTimeout(e,t)})}async function oe({durationMs:e=12e4,intervalMs:t=3e3}={}){if(X)return;X=!0;const r=Date.now();let o=0;try{for(;Date.now()-r<e;){o+=1;const n=Math.max(0,Math.ceil((e-(Date.now()-r))/1e3));if((1===o||o%4==0)&&ee(`自动监听待处理配对中（剩余约 ${n} 秒），你可以直接去 Control UI 点连接。`,"info"),Y){await re(Math.min(1e3,t));continue}const d=await i("/api/gateway/pairing/approve-pending",{method:"POST",allowBusinessError:!0}),a=d?.result||{};if(!d.ok){const e=String(a.message||d.message||"自动监听审批失败").trim();return ee(`自动监听审批失败：${e}`,"error"),void y(`自动监听审批失败：${e}`,"error")}const s=te(a);if("approved"===s.state)return ee(`自动监听审批成功：已批准 ${s.approvedCount} 个待处理配对`,"ok"),void y(`已自动批准 ${s.approvedCount} 个待处理配对，请在 Control UI 重试连接。`,"ok");if("failed"===s.state)return ee(`自动监听审批部分失败：成功 ${s.approvedCount} / 失败 ${s.failedCount}`,"error"),void y(`自动监听审批失败：${s.message}`,"error");await re(t)}ee("自动监听结束：2 分钟内未检测到新的待处理配对，可手动点击“批准待处理配对”。","info")}catch(e){const t=e.message||String(e);ee(`自动监听审批失败：${t}`,"error"),y(`自动监听审批失败：${t}`,"error")}finally{X=!1}}function ne(e=""){const t=String(e||"").trim(),r=document.querySelector("#dashboard_gateway_token_value");r instanceof HTMLInputElement&&(r.value=t);const o=document.querySelector("#dashboard_gateway_token_copy");o instanceof HTMLButtonElement&&(o.disabled=!t)}function ie(){const e=document.querySelector("#dashboard_gateway_token_value");return e instanceof HTMLInputElement?String(e.value||"").trim():""}function de(){if(p.dashboardBound)return;p.dashboardBound=!0;const e=Array.from(document.querySelectorAll("[data-dashboard-context-input]")),r=t=>{e.forEach(e=>{String(e.value||"")!==t&&(e.value=t)})},o=b(localStorage.getItem(t)||"");null!==o&&r(String(o)),e.forEach(e=>{e.addEventListener("input",()=>{const o=b(e.value||"");if(null===o)return localStorage.removeItem(t),void r("");const n=String(o);localStorage.setItem(t,n),r(n)})}),document.querySelectorAll("[data-dashboard-jump]").forEach(e=>{e.addEventListener("click",()=>{const t=String(e.getAttribute("data-dashboard-jump")||"").trim();if(!t)return;const r=document.querySelector(`.tab[data-tab-target="${t}"]`);r instanceof HTMLElement&&r.click()})}),document.querySelector("#dashboard_summary_refresh")?.addEventListener("click",()=>{Promise.allSettled([ce({silent:!0}),loadErrorSummary({silent:!0}),checkUpdate({silent:!0})]).then(e=>{const t=e.filter(e=>"rejected"===e.status);if(t.length>0){const e=t.map(e=>e.reason?.message||String(e.reason||"unknown"));return void y(`仪表盘刷新部分失败：${e.join(" | ")}`,"error")}y("仪表盘状态总览刷新完成","ok")})}),document.querySelector("#dashboard_quick_model_ref")?.addEventListener("change",()=>{T(E(p.currentModelSettings,String(u("dashboard_quick_model_ref")||"").trim()))}),document.querySelector("#dashboard_quick_switch")?.addEventListener("click",()=>{const e=p.currentModelSettings;if(!e)return void y("模型配置尚未加载完成，请稍后重试","error");const t=String(u("dashboard_quick_model_ref")||"").trim();if(!t)return void y("请先选择目标模型","error");const r=E(e,t);r?$(e,r,"已从仪表盘切换默认模型到").catch(e=>y(e.message||String(e),"error")):y("目标模型不存在，请刷新页面后重试","error")}),document.querySelector("#dashboard_gateway_token_sync")?.addEventListener("click",()=>{(async function(){if(J)return void y("Gateway Token 自动配置正在进行，请稍候","info");const e=document.querySelector("#dashboard_gateway_token_sync");J=!0,e instanceof HTMLButtonElement&&(e.disabled=!0,e.setAttribute("aria-busy","true")),Z("正在生成新的 Gateway Token 并写入真实配置...","info"),ee("重置完成后会自动监听 2 分钟并批准新出现的待处理配对。","info");try{const e=await i("/api/gateway/token/sync",{method:"POST",allowBusinessError:!0}),t=e?.result||{};if(!e.ok)throw new Error(t.message||e.message||"自动配置失败");const r=String(t.token||"").trim();r&&ne(r),Z(`配置完成：${String(t.tokenMasked||"").trim()||"已写入"}（来源：${String(t.source||"runtime").trim()}）。请把新 Token 粘贴到 Control UI 后重新连接。`,"ok");const o=t?.autoApprove&&"object"==typeof t.autoApprove?t.autoApprove:null;if(!o)return ee("未返回首轮自动审批结果，已切换到 2 分钟自动监听模式。","info"),y(`Gateway Token 已重置：${t.path||"-"}。请在 Control UI 更新新 Token 后直接连接。`,"ok"),void oe().catch(()=>{});const n=te(o);if("empty"===n.state)return ee("首轮自动审批完成：当前没有待处理配对请求，已进入 2 分钟自动监听。","ok"),y(`Gateway Token 已重置：${t.path||"-"}。当前无待处理配对，请在 Control UI 粘贴新 Token 并连接。`,"ok"),void oe().catch(()=>{});if("failed"===n.state)return ee(`自动审批部分失败：成功 ${n.approvedCount} / 失败 ${n.failedCount}`,"error"),void y(`Gateway Token 已重置，但自动审批失败：${n.message}`,"error");ee(`首轮自动审批成功：已批准 ${n.approvedCount} 个待处理配对，已进入 2 分钟自动监听。`,"ok"),y(`Gateway Token 已重置并自动批准 ${n.approvedCount} 个待处理配对。请在 Control UI 粘贴新 Token 后重连。`,"ok"),oe().catch(()=>{})}catch(e){const t=e.message||String(e);Z(`自动配置失败：${t}`,"error"),y(`Gateway Token 自动配置失败：${t}`,"error")}finally{J=!1,e instanceof HTMLButtonElement&&(e.disabled=!1,e.setAttribute("aria-busy","false"))}})().catch(e=>{const t=e.message||String(e);Z(`自动配置失败：${t}`,"error"),y(`Gateway Token 自动配置失败：${t}`,"error")})}),document.querySelector("#dashboard_gateway_token_copy")?.addEventListener("click",()=>{(async function(){const e=ie();if(!e)return void y("当前没有可复制的 Gateway Token，请先点击自动配置。","error");const t=document.querySelector("#dashboard_gateway_token_copy"),r=t instanceof HTMLButtonElement?t.textContent:"";t instanceof HTMLButtonElement&&(t.disabled=!0,t.textContent="复制中...");try{await async function(e){const t=String(e||"");if(!t)return;if(navigator?.clipboard?.writeText&&window.isSecureContext)return void await navigator.clipboard.writeText(t);const r=document.createElement("textarea");r.value=t,r.setAttribute("readonly","true"),r.style.position="fixed",r.style.opacity="0",r.style.pointerEvents="none",document.body.appendChild(r),r.focus(),r.select();const o=document.execCommand("copy");if(document.body.removeChild(r),!o)throw new Error("浏览器未允许复制，请手动复制")}(e),Z("Gateway Token 已复制到剪贴板。","ok"),y("Gateway Token 已复制到剪贴板","ok"),t instanceof HTMLButtonElement&&(t.textContent="已复制")}catch(e){const r=e.message||String(e);y(`Gateway Token 复制失败：${r}`,"error"),t instanceof HTMLButtonElement&&(t.textContent="复制失败")}finally{t instanceof HTMLButtonElement&&setTimeout(()=>{t.textContent=r||"复制 Gateway Token",t.disabled=!ie()},1200)}})().catch(e=>{const t=e.message||String(e);y(`Gateway Token 复制失败：${t}`,"error")})}),document.querySelector("#dashboard_gateway_pairing_approve")?.addEventListener("click",()=>{(async function(){if(Y)return void y("待处理配对审批正在执行，请稍候","info");const e=document.querySelector("#dashboard_gateway_pairing_approve");Y=!0,e instanceof HTMLButtonElement&&(e.disabled=!0,e.setAttribute("aria-busy","true")),ee("正在读取并批准待处理配对请求...","info");try{const e=await i("/api/gateway/pairing/approve-pending",{method:"POST",allowBusinessError:!0}),t=e?.result||{};if(!e.ok)throw new Error(t.message||e.message||"待处理配对审批失败");const r=Number(t.pendingCount||0),o=Number(t.approvedCount||0),n=Number(t.failedCount||0);if(0===r)return ee("当前没有待处理配对请求，无需审批。","ok"),void y("当前没有待处理配对请求","ok");if(n>0){const e=String(t.message||"存在审批失败项").trim();return ee(`审批部分失败：成功 ${o} / 失败 ${n}`,"error"),void y(`待处理配对审批失败：${e}`,"error")}ee(`已批准 ${o} 个待处理配对请求`,"ok"),y(`待处理配对审批完成：${o} 个`,"ok")}catch(e){const t=e.message||String(e);ee(`审批失败：${t}`,"error"),y(`待处理配对审批失败：${t}`,"error")}finally{Y=!1,e instanceof HTMLButtonElement&&(e.disabled=!1,e.setAttribute("aria-busy","false"))}})().catch(e=>{const t=e.message||String(e);ee(`审批失败：${t}`,"error"),y(`待处理配对审批失败：${t}`,"error")})}),document.querySelector("#dashboard_gateway_restart")?.addEventListener("click",()=>{(async function(){if(Q)return void y("网关重启正在执行，请稍候","info");const e=document.querySelector("#dashboard_gateway_restart");Q=!0,e instanceof HTMLButtonElement&&(e.disabled=!0,e.setAttribute("aria-busy","true")),ee("正在重启网关服务...","info");try{const e=await i("/api/service/restart",{method:"POST",allowBusinessError:!0}),t=e?.result||{};if(!e.ok||!1===t?.ok){const r=String(t.output||t.message||e.message||"网关重启失败").trim();throw new Error(r)}const r=ae(String(t.message||t.output||"执行成功").trim());ee(`网关重启完成：${r}`,"ok"),y(`网关重启完成：${r}`,"ok")}catch(e){const t=e.message||String(e);ee(`网关重启失败：${t}`,"error"),y(`网关重启失败：${t}`,"error")}finally{Q=!1,e instanceof HTMLButtonElement&&(e.disabled=!1,e.setAttribute("aria-busy","false"))}})().catch(e=>{const t=e.message||String(e);ee(`网关重启失败：${t}`,"error"),y(`网关重启失败：${t}`,"error")})}),async function({silent:e=!1}={}){if(!z){z=!0;try{const t=await i("/api/gateway/token/current",{allowBusinessError:!0}),r=t?.result||{};if(!t.ok)throw new Error(r.message||t.message||"读取 Gateway Token 失败");const o=String(r.token||"").trim();if(!o)return ne(""),Z("当前未检测到 Gateway Token，请先点击自动配置。","info"),void(e||y("当前未检测到 Gateway Token，请先自动配置。","info"));ne(o),Z(`当前 Token：${String(r.tokenMasked||"").trim()||"已加载"}（来源：${String(r.source||"openclaw-config").trim()}）`,"ok"),e||y("Gateway Token 已读取，可直接复制使用","ok")}catch(t){const r=t.message||String(t);ne(""),Z(`读取 Gateway Token 失败：${r}`,"error"),e||y(`读取 Gateway Token 失败：${r}`,"error")}finally{z=!1}}}({silent:!0}).catch(()=>{})}function ae(e,t=72){const r=String(e||"").replace(/\s+/g," ").trim();return r?r.length<=t?r:`${r.slice(0,Math.max(0,t-1))}…`:""}function se(e=[]){const t=Array.isArray(e)?e:[],r=t.length>0?String(t[t.length-1]||"").trim():"";if(m.errorCount=t.length,m.latestError=r,0===t.length)return S("dashboard_summary_errors","无错误"),void S("dashboard_summary_errors_meta","最近 20 条中未发现错误关键字");S("dashboard_summary_errors",`${t.length} 条错误`),S("dashboard_summary_errors_meta",ae(r,80)||"已命中错误关键字")}function me(e={}){const t=String(e?.currentTag||"").trim(),r=String(e?.latestTag||"").trim(),o=String(e?.warning||"").trim(),n=!!e?.updateAvailable;return m.currentTag=t,m.latestTag=r,m.updateAvailable=n,m.updateWarning=o,o?(S("dashboard_summary_version",t?`当前 ${t}`:"检查失败"),void S("dashboard_summary_version_meta",ae(`最新版本读取失败：${o}`,90))):t||r?(S("dashboard_summary_version",n?`可升级到 ${r||"-"}`:`当前 ${t||"-"}`),void S("dashboard_summary_version_meta",n?`当前 ${t||"-"}，检测到新版本`:`当前 ${t||"-"}，已是最新`)):(S("dashboard_summary_version","未读取"),void S("dashboard_summary_version_meta","尚未获取版本信息"))}async function ce({silent:e=!1}={}){const t=await i("/api/dashboard/summary"),r=t?.summary&&"object"==typeof t.summary?t.summary:{},o=r.runtime&&"object"==typeof r.runtime?r.runtime:{},n=r.model&&"object"==typeof r.model?r.model:{},d=r.channels&&"object"==typeof r.channels?r.channels:{},a=d.runtime&&"object"==typeof d.runtime?d.runtime:{},m=r.skills&&"object"==typeof r.skills?r.skills:{},l=(new Date).toLocaleString();(function(e=[]){!function(e,t=[],r="暂无渠道运行数据"){const o=document.querySelector("#dashboard_channel_runtime_list");if(o){if(!Array.isArray(t)||0===t.length)return void h(o,r);o.innerHTML="",t.forEach(e=>{const t=document.createElement("sl-card");t.className="dashboard-runtime-item dashboard-runtime-item-channel",t.title=`${e?.name||e?.key||"未命名 Skill"}\nkey: ${e?.key||"-"}\nsource: ${e?.source||"-"}`;const r=document.createElement("div");r.className="dashboard-runtime-item-body";const n=document.createElement("div");n.className="stack-item-row";const i=document.createElement("span");i.className="stack-item-title",i.textContent=e?.label||e?.id||"未命名渠道",n.appendChild(i);const d=document.createElement("div");d.className="chip-line";const a=s(e?.configured?"已配置":"未配置",e?.configured?"success":"neutral");d.appendChild(a);const m=s(e?.running?"运行中":"未运行",e?.running?"primary":"warning");d.appendChild(m),String(e?.lastError||"").trim()&&d.appendChild(s("最近有报错","danger")),n.appendChild(d),r.appendChild(n);const l=document.createElement("p");l.className="stack-item-meta";const u=String(e?.lastError||"").trim(),p=c(e?.lastProbeAt);l.textContent=u?`最近错误: ${u}`:`最近检查: ${p}`,r.appendChild(l),t.appendChild(r),o.appendChild(t)})}}(0,e,"暂无渠道运行数据")})(Array.isArray(a.items)?a.items:[]),function(e=[]){!function(e,t=[],r="暂无 Skills 运行数据"){const o=document.querySelector("#dashboard_skills_runtime_list");if(!o)return;if(!Array.isArray(t)||0===t.length)return void h(o,r);const n=t.length,i=t.filter(e=>e?.enabled).length,d=document.querySelector("#dashboard_skills_summary_text");d&&(d.textContent=`${n} 个技能，${i} 个已启用`);const a=t.filter(e=>!e?.enabled||e?.blocked||!e?.eligible),m=t.filter(e=>e?.enabled&&!e?.blocked&&e?.eligible);o.innerHTML="";const c=e=>{const t=document.createElement("div");t.className="dashboard-runtime-item-flat dashboard-runtime-item-body";const r=document.createElement("div");r.className="stack-item-row";const o=document.createElement("span");o.className="stack-item-title",o.textContent=e?.name||e?.key||"未命名 Skill",r.appendChild(o);const n=document.createElement("div");let i,d;return n.className="chip-line",e?.blocked?(i="受限",d="danger"):e?.enabled?e?.eligible?(i="正常",d="success"):(i="未就绪",d="warning"):(i="已禁用",d="neutral"),n.appendChild(s(i,d)),r.appendChild(n),t.appendChild(r),t};a.forEach(e=>o.appendChild(c(e)));const l=m.map(e=>{const t=c(e);return t.style.display="none",t.dataset.skillNormal="1",o.appendChild(t),t}),u=document.querySelector("#dashboard_skills_toggle_all");if(u)if(0===m.length)u.style.display="none";else{u.style.display="",u.textContent=`显示全部 (${n})`;let e=!1;u.onclick=()=>{e=!e,l.forEach(t=>t.style.display=e?"":"none"),u.textContent=e?"只看有问题的":`显示全部 (${n})`}}}(0,e,"暂无 Skills 运行数据")}(Array.isArray(m.items)?m.items:[]),function({runtime:e={},model:t={},channels:r={},skills:o={},refreshedAt:n=""}={}){const i=String(e?.mode||"-");S("dashboard_summary_runtime",e?.active?"运行中":!1===e?.ok?"状态异常":"未运行"),S("dashboard_summary_runtime_meta",`模式: ${i} | ${ae(e?.message||"-",56)}`);const d=document.querySelector("#runtime_state");if(d){d.textContent=e?.active?"机器人运行中":!1===e?.ok?"状态异常":"未运行";const t=d.previousElementSibling;t&&t.classList.contains("dot")&&(t.style.background=e?.active?"var(--success, #22c55e)":"var(--danger, #ef4444)")}const a=t?.current&&"object"==typeof t.current?t.current:{},s=String(a?.modelName||a?.modelId||"-"),m=String(a?.providerId||"-");S("dashboard_summary_model",s||"-"),S("dashboard_summary_model_meta",`提供商: ${m}`),S("dashboard_hero_model","-"!==s?`· ${s}`:""),S("dashboard_model_display",s||"-");const c=r?.runtime&&"object"==typeof r.runtime?r.runtime:{},l=Number(c?.running??0),u=Number(c?.total??0);S("dashboard_summary_channels",`${l}/${u}`),S("dashboard_summary_channels_meta",!1===c?.ok?`渠道状态读取失败: ${ae(c?.message||"-",56)}`:"运行中 / 总渠道数");const p=o&&"object"==typeof o?o:{},_=Number(p?.enabled??0),g=Number(p?.total??0);S("dashboard_summary_skills",`${_}/${g}`),S("dashboard_summary_skills_meta",!1===p?.ok?`Skills 状态读取失败: ${ae(p?.message||"-",56)}`:"已启用 / 总技能数");const v=document.querySelector("#dashboard_summary_hint");v&&(v.textContent=n?`最后刷新：${n}`:'点击"刷新总览"后显示最新状态。')}({runtime:o,model:n,channels:d,skills:m,refreshedAt:l}),e||y("状态总览刷新完成","ok")}function le(e,t,r){const o=document.querySelector(`#${e}`);if(!o)return;const n=t?document.querySelector(`#${t}`):null,i=String(r||"").trim();return Array.from(o.options||[]).some(e=>e.value===i)?(o.value=i,void(n&&(n.value="",n.classList.remove("is-visible")))):Array.from(o.options||[]).some(e=>"custom"===e.value)?(o.value="custom",void(n&&(n.value=i,n.classList.add("is-visible")))):void(o.value=i)}function ue(e,t){const r=document.querySelector(`#${e}`);if(!r)return"";if("custom"!==String(r.value||""))return String(r.value||"").trim();const o=t?document.querySelector(`#${t}`):null;return String(o?.value||"").trim()}function pe(e,t,{modelIds:o=[],selectedValue:n=""}={}){const i=document.querySelector(`#${e}`);if(!(i instanceof HTMLSelectElement))return"";const d=new Set,a=[];o.forEach(e=>{const t=String(e||"").trim();!t||d.has(t)||(d.add(t),a.push(t))}),r.forEach(e=>{const t=String(e?.id||"").trim();!t||d.has(t)||(d.add(t),a.push(t))}),i.innerHTML="",a.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)});const s=document.createElement("option");return s.value="custom",s.textContent="自定义",i.appendChild(s),le(e,t,String(n||"").trim()||a[0]||"custom"),ue(e,t)}function _e(e={}){const t=String(e?.modelId||"").trim();return t?{id:t,name:String(e?.modelName||t).trim()||t,contextWindow:Number(e?.contextWindow||0)||void 0,maxTokens:Number(e?.maxTokens||0)||void 0}:{}}function ge(e,t={}){const i=n[e]||n["aicodecat-gpt"],a=String(t.apiOverride||i.api||"").trim(),s=!!t.forceModelName,m=String(i.providerId||"").startsWith("aicodecat-"),c=String(t.modelId||ue("template_model_id","template_model_id_custom")||"").trim();f("template_provider_id",i.providerId),le("template_api","template_api_custom",a),f("template_base_url",m?w(a):i.baseUrl);const l=pe("template_model_id","template_model_id_custom",{modelIds:(i.models||[]).map(e=>e?.id),selectedValue:c}),p=i.models.find(e=>String(e?.id||"").trim()===l)||i.models[0]||{},v=String(u("template_model_name")||"").trim();(s||!v)&&f("template_model_name",p?.name||l||"");const y=String(u("template_model_name")||"").trim(),h=_(l),S=o[h]||o.gpt,b=g({id:l,name:y||p?.name||l},{id:l,name:p?.name||l,reasoning:void 0!==p?.reasoning?!!p.reasoning:!!i.models?.[0]?.reasoning,input:Array.isArray(p?.input)&&p.input.length>0?p.input:Array.isArray(i.models?.[0]?.input)&&i.models[0].input.length>0?i.models[0].input:["text"],contextWindow:p?.contextWindow||S.contextWindow,maxTokens:p?.maxTokens||S.maxTokens}),k=document.querySelector("#template_model_preview");k&&(k.textContent=b?`- ${b.name||b.id} (${b.id}) | 输入: ${(b.input||[]).join("+")} | 思考: ${b.reasoning?"开启":"关闭"} | 上下文: ${b.contextWindow} | 最大输出: ${b.maxTokens}`:"请先选择或输入模型 ID"),le("custom_api","custom_api_custom",a||i.api),f("custom_base_url",m?w(a):i.baseUrl),f("custom_provider_id",i.providerId);const x=pe("custom_model_id","custom_model_id_custom",{modelIds:(i.models||[]).map(e=>e?.id),selectedValue:l||i.models[0]?.id||r[0]?.id||""});if(!String(u("custom_model_name")||"").trim()){const e=i.models.find(e=>String(e?.id||"").trim()===x);f("custom_model_name",String(e?.name||x||"").trim())}const E=d(x,String(u("custom_model_name")||"").trim());String(u("custom_model_context_window")||"").trim()||f("custom_model_context_window",E?.contextWindow||""),String(u("custom_model_max_tokens")||"").trim()||f("custom_model_max_tokens",E?.maxTokens||"")}function ve(e=p.currentModelSettings){return Array.isArray(e?.catalog?.providers)?e.catalog.providers:[]}function fe(e,t=p.currentModelSettings){const r=String(e||"").trim();return r&&ve(t).find(e=>String(e?.id||"").trim()===r)||null}function ye(e=p.currentModelSettings){const t=fe(String(u("existing_provider_id")||"").trim(),e);f("existing_provider_api",t?.api||""),f("existing_provider_baseurl",t?.baseUrl||"");const r=pe("existing_model_id","existing_model_id_custom",{modelIds:Array.isArray(t?.models)?t.models.map(e=>String(e?.id||"").trim()).filter(Boolean):[],selectedValue:ue("existing_model_id","existing_model_id_custom")}),o=document.querySelector("#existing_model_id");o instanceof HTMLSelectElement&&(o.disabled=!t);const n=Array.isArray(t?.models)?t.models.find(e=>String(e?.id||"").trim()===r):null,i=_e(d(r,r)),a=String(n?.name||n?.id||i.name||r||"").trim(),s=Number(n?.contextWindow||i.contextWindow||0)||"",m=Number(n?.maxTokens||i.maxTokens||0)||"";f("existing_model_name",a),f("existing_model_context_window",s),f("existing_model_max_tokens",m)}function he(e){const t=e?.catalog||{providers:[],modelRefs:[]},r=Array.isArray(t.modelRefs)?t.modelRefs:[];p.currentModelSettings=e||null,p.modelCatalog={providers:Array.isArray(t.providers)?t.providers:[],modelRefs:r};const o=[],n=new Set;r.forEach(e=>{const t=String(e?.ref||"").trim();!t||n.has(t)||(n.add(t),o.push({...e,ref:t}))});const i=String(e?.primary||"").trim();if(i&&!n.has(i)){const t={ref:i,providerId:e.providerId,providerApi:e.providerApi,providerBaseUrl:e.providerBaseUrl,modelId:e.modelId,modelName:e.modelName,contextWindow:e.contextWindow,maxTokens:e.maxTokens,thinkingStrength:e.thinkingStrength||"无"};n.add(i),o.push(t)}0===o.length&&i&&o.push({ref:i,providerId:e.providerId,providerApi:e.providerApi,providerBaseUrl:e.providerBaseUrl,modelId:e.modelId,modelName:e.modelName,contextWindow:e.contextWindow,maxTokens:e.maxTokens,thinkingStrength:e.thinkingStrength||"无"}),p.defaultModelRefs=o;const d=document.querySelector("#model_default_ref");d&&(d.innerHTML="",p.defaultModelRefs.forEach(e=>{const t=document.createElement("option");t.value=e.ref,t.textContent=e.modelId||e.modelName||e.ref,d.appendChild(t)}),e.primary&&p.defaultModelRefs.some(t=>t.ref===e.primary)?d.value=e.primary:d.options.length>0&&(d.selectedIndex=0));const s=p.defaultModelRefs.find(t=>t.ref===e.primary)||p.defaultModelRefs[0]||{ref:e.primary,providerId:e.providerId,providerApi:e.providerApi,providerBaseUrl:e.providerBaseUrl,modelId:e.modelId,modelName:e.modelName,contextWindow:e.contextWindow,maxTokens:e.maxTokens};V(s,s.ref||e.primary),p.currentModelPayload=a({primary:e.primary||s.ref,providerId:e.providerId||s.providerId,providerApi:e.providerApi||s.providerApi,providerBaseUrl:e.providerBaseUrl||s.providerBaseUrl,providerApiKey:"",modelId:e.modelId||s.modelId,modelName:e.modelName||s.modelName||s.modelId,contextWindow:e.contextWindow||s.contextWindow,maxTokens:e.maxTokens||s.maxTokens,providerModels:[]}),f("template_set_as_primary",!1),f("existing_set_as_primary",!1),f("custom_set_as_primary",!1),function(e){const t=document.querySelector("#existing_provider_id");if(!(t instanceof HTMLSelectElement))return;const r=ve(e).filter(e=>String(e?.id||"").trim());if(t.innerHTML="",0===r.length){const e=document.createElement("option");e.value="",e.textContent="暂无可用供应商",t.appendChild(e),t.disabled=!0,f("existing_provider_api",""),f("existing_provider_baseurl",""),pe("existing_model_id","existing_model_id_custom",{modelIds:[],selectedValue:""});const r=document.querySelector("#existing_model_id");return void(r instanceof HTMLSelectElement&&(r.disabled=!0))}t.disabled=!1,r.forEach(e=>{const r=document.createElement("option");r.value=String(e.id||"").trim(),r.textContent=String(e.id||"").trim(),t.appendChild(r)});const o=String(e?.providerId||"").trim();o&&r.some(e=>String(e.id||"").trim()===o)?t.value=o:t.options.length>0&&(t.selectedIndex=0),ye(e)}(e),F("template"),L(!1),C(e),document.querySelector("#model_raw_config_editor")&&O({silent:!0}).catch(e=>{H(`读取失败：${e.message||String(e)}`,"error")})}function Se(){const t=document.querySelector('[data-panel="panel-model"], [data-panel="panel-model-add"]');if(!t||"1"===t.dataset.boundModelEditor)return;t.dataset.boundModelEditor="1",A.dialogBound||(A.dialogBound=!0,document.querySelector("#model_provider_edit_cancel")?.addEventListener("click",()=>{W("model_provider_edit_dialog")}),document.querySelector("#model_provider_edit_submit")?.addEventListener("click",()=>{B(async()=>{await async function(){const e=String(A.providerEditId||"").trim();if(!e)throw new Error("未找到待编辑的供应商");const t=String(u("model_provider_edit_id")||"").trim(),r=String(u("model_provider_edit_api")||"").trim(),o=String(u("model_provider_edit_baseurl")||"").trim(),n=String(u("model_provider_edit_apikey")||"").trim();if(!t||!r||!o)throw new Error("请完整填写供应商名称、API 模式和 API 地址");const d={nextProviderId:t,api:r,baseUrl:o};n&&(d.apiKey=n),await i(`/api/models/providers/${encodeURIComponent(e)}`,{method:"PUT",body:JSON.stringify(d)}),W("model_provider_edit_dialog"),A.providerEditId="",f("model_provider_edit_apikey","");const a=t===e?`供应商 ${t} 已更新`:`供应商已从 ${e} 更新为 ${t}`;await G(a)}()}).catch(e=>{y(e.message||String(e),"error")})}),document.querySelector("#model_item_edit_cancel")?.addEventListener("click",()=>{W("model_item_edit_dialog")}),document.querySelector("#model_item_edit_submit")?.addEventListener("click",()=>{B(async()=>{await async function(){const e=String(A.modelEditProviderId||"").trim(),t=String(A.modelEditId||"").trim();if(!e||!t)throw new Error("未找到待编辑的模型");const r=String(u("model_item_edit_id")||"").trim(),o=String(u("model_item_edit_name")||"").trim();if(!r)throw new Error("模型 ID 不能为空");const n=U(u("model_item_edit_context_window"),"模型最大上下文"),d=U(u("model_item_edit_max_tokens"),"模型最大输出"),a={nextModelId:r,name:o||r};void 0!==n&&(a.contextWindow=n),void 0!==d&&(a.maxTokens=d),await i(`/api/models/providers/${encodeURIComponent(e)}/models/${encodeURIComponent(t)}`,{method:"PUT",body:JSON.stringify(a)}),W("model_item_edit_dialog"),A.modelEditProviderId="",A.modelEditId="";const s=r===t?`模型 ${e}/${r} 已更新`:`模型已从 ${e}/${t} 更新为 ${e}/${r}`;await G(s)}()}).catch(e=>{y(e.message||String(e),"error")})}),N("model_provider_edit_dialog")?.addEventListener("sl-after-hide",()=>{A.providerEditId="",f("model_provider_edit_apikey","")}),N("model_item_edit_dialog")?.addEventListener("sl-after-hide",()=>{A.modelEditProviderId="",A.modelEditId=""})),M.bound||!(document.querySelector("#model_raw_config_editor")instanceof HTMLTextAreaElement)||(M.bound=!0,document.querySelector("#model_raw_config_reload")?.addEventListener("click",()=>{O({silent:!1}).catch(e=>{y(e.message||String(e),"error")})}),document.querySelector("#model_raw_config_save")?.addEventListener("click",()=>{(async function(){const e=document.querySelector("#model_raw_config_editor");if(!(e instanceof HTMLTextAreaElement))return;if(M.pending)return void y("配置文件正在处理，请稍后重试","info");const t=String(e.value||"").trim();if(!t)throw new Error("配置 JSON 不能为空");M.pending=!0,D(!0),H("正在写入真实配置文件...","info");try{const e={rawText:t};Number.isFinite(M.lastSyncMtimeMs)&&M.lastSyncMtimeMs>0&&(e.expectedMtimeMs=M.lastSyncMtimeMs);const r=await i("/api/openclaw-config/raw",{method:"PUT",body:JSON.stringify(e)});R(r),H("保存成功，已同步真实配置文件。","ok"),y(`配置文件写入成功：${r.path}`,"ok");const o=r?.settings?.model;o&&"object"==typeof o&&(K(o),he(o))}finally{M.pending=!1,D(!1)}})().catch(e=>{H(`保存失败：${e.message||String(e)}`,"error"),y(e.message||String(e),"error")})}));const r=document.querySelector("#model_default_ref");document.querySelector("#model_add_toggle")?.addEventListener("click",()=>{const e=document.querySelector("#model_add_workspace"),t=!!e&&e.classList.contains("is-hidden");L(t),t&&(F(p.providerMode||"template"),e?.scrollIntoView({behavior:"smooth",block:"start"}))}),document.querySelectorAll("[data-model-provider-mode]").forEach(e=>{e.addEventListener("click",()=>{F(String(e.getAttribute("data-model-provider-mode")||"").trim())})}),F(p.providerMode||"template");const s=document.querySelector("#existing_model_id"),m=document.querySelector("#existing_model_id_custom"),c=()=>{if(!s||!m)return;const e="custom"===String(s.value||"");m.classList.toggle("is-visible",e)};document.querySelector("#existing_provider_id")?.addEventListener("change",()=>{ye(p.currentModelSettings),c()}),s?.addEventListener("change",()=>{ye(p.currentModelSettings),c()}),c();const l=document.querySelector("#model_template_key");l?.addEventListener("change",()=>{ge(String(l.value||"aicodecat-gpt"),{forceModelName:!0})});const v=document.querySelector("#template_api"),h=document.querySelector("#template_api_custom"),S=document.querySelector("#template_model_id"),b=document.querySelector("#template_model_id_custom"),x=document.querySelector("#template_model_name"),E=()=>{const t=String(u("template_provider_id")||"").trim(),r=ue("template_api","template_api_custom"),o=ue("template_model_id","template_model_id_custom");if(!t||!r||t!==e&&!t.startsWith("aicodecat-"))return;const i=k(e,r);n[i]&&(l&&(l.value=i),ge(i,{apiOverride:r,modelId:o,forceModelName:!0}))},$=()=>{const t=ue("template_model_id","template_model_id_custom");if(!t)return;const r=_(t),i=(o[r]||o.gpt).apiMode,d=k(e,i);n[d]&&(l&&(l.value=d),ge(d,{apiOverride:i,modelId:t,forceModelName:!0}))},T=()=>{if(!v||!h)return;const e="custom"===String(v.value||"");h.classList.toggle("is-visible",e)},C=()=>{if(!S||!b)return;const e="custom"===String(S.value||"");b.classList.toggle("is-visible",e)};v?.addEventListener("change",()=>{T(),E()}),h?.addEventListener("input",()=>{"custom"===String(v?.value||"")&&E()}),S?.addEventListener("change",()=>{C(),$()}),b?.addEventListener("input",()=>{"custom"===String(S?.value||"")&&$()}),x?.addEventListener("input",()=>{ge(String(l?.value||"aicodecat-gpt"),{apiOverride:ue("template_api","template_api_custom"),modelId:ue("template_model_id","template_model_id_custom")})}),T(),C();const q=document.querySelector("#custom_api"),j=document.querySelector("#custom_api_custom"),J=document.querySelector("#custom_model_id"),z=document.querySelector("#custom_model_id_custom"),Y=document.querySelector("#custom_provider_id"),Q=()=>{const t=String(u("custom_provider_id")||"").trim(),r=ue("custom_api","custom_api_custom");if(!t||!r||t!==e&&!t.startsWith("aicodecat-"))return;const o=k(e,r);f("custom_provider_id",o),f("custom_base_url",w(r))},X=()=>{const t=String(u("custom_provider_id")||"").trim(),r=ue("custom_model_id","custom_model_id_custom");if(!t||!r||t!==e&&!t.startsWith("aicodecat-"))return;const n=_(r);le("custom_api","custom_api_custom",(o[n]||o.gpt).apiMode),Q()},Z=()=>{if(!q||!j)return;const e="custom"===String(q.value||"");j.classList.toggle("is-visible",e)},ee=()=>{if(!J||!z)return;const e="custom"===String(J.value||"");z.classList.toggle("is-visible",e)};q?.addEventListener("change",()=>{Z(),Q()}),j?.addEventListener("input",()=>{"custom"===String(q?.value||"")&&Q()}),J?.addEventListener("change",()=>{ee(),X()}),z?.addEventListener("input",()=>{"custom"===String(J?.value||"")&&X()}),Y?.addEventListener("change",()=>{Q()}),Z(),ee(),r instanceof HTMLSelectElement&&r.addEventListener("change",()=>{const e=String(r.value||"");V(p.defaultModelRefs.find(t=>t.ref===e)||{},e)}),document.querySelector("#save_default_model")?.addEventListener("click",()=>{const e=String(u("model_default_ref")||"").trim(),t=p.defaultModelRefs.find(t=>t.ref===e);t?ke(a({primary:t.ref,providerId:t.providerId,providerApi:t.providerApi,providerBaseUrl:t.providerBaseUrl,providerApiKey:"",modelId:t.modelId,modelName:t.modelName||t.modelId,contextWindow:t.contextWindow||2e5,maxTokens:t.maxTokens||8192,providerModels:[]}),"默认模型已更新").catch(e=>y(e.message,"error")):y("默认模型无效，请先选择一个可用模型","error")}),document.querySelector("#save_provider_template")?.addEventListener("click",()=>{const e=String(u("model_template_key")||"").trim(),t=n[e];if(!t)return void y("模板不存在，请重新选择","error");const r=String(u("template_provider_id")||"").trim(),i=ue("template_api","template_api_custom"),d=String(u("template_base_url")||"").trim(),s=String(u("template_api_key")||"").trim(),m=ue("template_model_id","template_model_id_custom"),c=String(u("template_model_name")||"").trim();if(!(r&&i&&d&&m))return void y("模板配置不完整，请检查提供商名称 / API 模式 / URL / 模型 ID","error");const l=t.models.find(e=>String(e?.id||"").trim()===m)||null,p=_(m),v=o[p]||o.gpt,f={id:m,name:l?.name||c||m,reasoning:void 0!==l?.reasoning?!!l.reasoning:!!t.models?.[0]?.reasoning,input:Array.isArray(l?.input)&&l.input.length>0?l.input:Array.isArray(t.models?.[0]?.input)&&t.models[0].input.length>0?t.models[0].input:["text"],contextWindow:l?.contextWindow||v.contextWindow,maxTokens:l?.maxTokens||v.maxTokens},h=g({id:m,name:c||f.name},f);if(!h)return void y("模型信息无效，请检查模型 ID","error");const S=I(`${r}/${h.id}`,"template_set_as_primary");if(!S)return void y("无法确定默认模型指向，请先在路径 1 设置默认模型或勾选“保存后设为当前默认模型”","error");const b=a({primary:S,providerId:r,providerApi:i,providerBaseUrl:d,providerApiKey:s,modelId:h.id,modelName:h.name||h.id,contextWindow:h.contextWindow,maxTokens:h.maxTokens,providerModels:[h]}),w=u("template_set_as_primary")?"模型已写入并切换为默认模型":"模型已写入（默认模型未变）";P("save_provider_template_status","正在保存配置...","working"),ke(b,w).then(()=>{P("save_provider_template_status","配置完成，模型已成功写入。","ok")}).catch(e=>{P("save_provider_template_status",`保存失败：${e.message||String(e)}`,"error"),y(e.message||String(e),"error")})}),document.querySelector("#save_provider_existing")?.addEventListener("click",()=>{const e=String(u("existing_provider_id")||"").trim(),t=fe(e,p.currentModelSettings);if(!t)return void y("请先选择一个已有供应商","error");const r=ue("existing_model_id","existing_model_id_custom"),o=String(u("existing_model_name")||"").trim(),n=Number(u("existing_model_context_window")||0),i=Number(u("existing_model_max_tokens")||0);if(!r)return void y("请填写模型 ID","error");const s=String(t.api||"").trim(),m=String(t.baseUrl||"").trim();if(!s||!m)return void y("该供应商缺少 API 或 Base URL，请先补齐供应商配置后再添加模型","error");const c=Array.isArray(t.models)?t.models:[],l=_e(d(r,o||r)),_=c.find(e=>String(e?.id||"").trim()===r)||l||{},v=g({id:r,name:o||r,contextWindow:Number.isFinite(n)&&n>0?Math.floor(n):void 0,maxTokens:Number.isFinite(i)&&i>0?Math.floor(i):void 0},_);if(!v)return void y("模型信息无效，请检查模型 ID","error");const h=[v];c.forEach(e=>{const t=String(e?.id||"").trim();!t||t===v.id||h.push(e)});const S=I(`${e}/${v.id}`,"existing_set_as_primary");if(!S)return void y("无法确定默认模型指向，请先设置默认模型或勾选“保存后设为当前默认模型”","error");const b=a({primary:S,providerId:e,providerApi:s,providerBaseUrl:m,providerApiKey:"",modelId:v.id,modelName:v.name||v.id,contextWindow:v.contextWindow,maxTokens:v.maxTokens,providerModels:h}),w=u("existing_set_as_primary")?`已在供应商 ${e} 下新增模型并切换默认`:`已在供应商 ${e} 下新增模型（默认模型未变）`;P("save_provider_existing_status","正在保存配置...","working"),ke(b,w).then(()=>{f("existing_model_name",""),f("existing_model_context_window",""),f("existing_model_max_tokens",""),f("existing_set_as_primary",!1),le("existing_model_id","existing_model_id_custom",v.id),P("save_provider_existing_status","配置完成，模型已成功写入。","ok")}).catch(e=>{P("save_provider_existing_status",`保存失败：${e.message||String(e)}`,"error"),y(e.message||String(e),"error")})}),document.querySelector("#save_provider_custom")?.addEventListener("click",()=>{const e=String(u("custom_provider_id")||"").trim(),t=ue("custom_api","custom_api_custom"),r=String(u("custom_base_url")||"").trim(),o=String(u("custom_api_key")||"").trim(),n=ue("custom_model_id","custom_model_id_custom"),i=String(u("custom_model_name")||"").trim();let s,m;try{s=U(u("custom_model_context_window"),"上下文长度"),m=U(u("custom_model_max_tokens"),"最大输出长度")}catch(e){return void y(e.message||String(e),"error")}if(!(e&&t&&r&&n))return void y("自定义配置不完整，请至少填写提供商名称 / API 模式 / URL / 模型 ID","error");const c=_e(d(n,i||n)),l={...c,id:n,name:i||c.name||n},p=g({id:n,name:i||l.name,contextWindow:s,maxTokens:m},l);if(!p)return void y("模型信息无效，请检查模型 ID","error");const _=I(`${e}/${p.id}`,"custom_set_as_primary");if(!_)return void y("无法确定默认模型指向，请先在路径 1 设置默认模型或勾选“保存后设为当前默认模型”","error");const v=a({primary:_,providerId:e,providerApi:t,providerBaseUrl:r,providerApiKey:o,modelId:p.id,modelName:p.name||p.id,contextWindow:p.contextWindow,maxTokens:p.maxTokens,providerModels:[p]}),h=u("custom_set_as_primary")?"供应商与模型已写入，默认模型已切换":"供应商与模型已写入（默认模型未变）";P("save_provider_custom_status","正在保存配置...","working"),ke(v,h).then(()=>{f("custom_model_name",""),f("custom_model_context_window",""),f("custom_model_max_tokens",""),f("custom_set_as_primary",!1),P("save_provider_custom_status","配置完成，模型已成功写入。","ok")}).catch(e=>{P("save_provider_custom_status",`保存失败：${e.message||String(e)}`,"error"),y(e.message||String(e),"error")})}),ge(String(u("model_template_key")||"aicodecat-gpt")),L(!1)}let be=null;function we(e){be="function"==typeof e?e:null}async function ke(...e){if(!be)throw new Error("saveModelSettings handler 未设置");return be(...e)}export{he as fillModelEditor,C as fillDashboardQuickSwitch,ce as loadStatusOverview,K as renderDashboardModelCards,V as renderModelSummary,de as setupDashboard,Se as setupModelEditor,we as setSaveModelSettingsHandler,se as updateDashboardErrorSummary,me as updateDashboardVersionSummary};