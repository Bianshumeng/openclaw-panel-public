import{api as e,channelSettingsSnapshot as t,els as n,getInputValue as o,modelEditorState as a,setInput as r,setMessage as s}from"../core/panel-core.js";import{fillModelEditor as l,renderDashboardModelCards as i,updateDashboardErrorSummary as c,updateDashboardVersionSummary as g}from"./model-dashboard-page.js";let u=null;const _=Object.freeze({bot:{label:"龙虾 Bot",stateId:"bot_update_state",hintId:"bot_update_hint",currentTagId:"bot_update_current_tag",latestTagId:"bot_update_latest_tag",targetTagId:"bot_update_target_tag",checkButtonId:"bot_check_update",upgradeButtonId:"bot_upgrade_update",rollbackButtonId:"bot_rollback_update",progressWrapId:"bot_update_progress_wrap",progressBarId:"bot_update_progress",progressTextId:"bot_update_progress_text"},panel:{label:"龙虾控制台",stateId:"panel_update_state",hintId:"panel_update_hint",currentTagId:"panel_update_current_tag",latestTagId:"panel_update_latest_tag",targetTagId:"panel_update_target_tag",checkButtonId:"panel_check_update",upgradeButtonId:"panel_upgrade_update",rollbackButtonId:"panel_rollback_update",applyButtonId:"panel_apply_update",progressWrapId:"panel_update_progress_wrap",progressBarId:"panel_update_progress",progressTextId:"panel_update_progress_text"}});function d(e="bot"){return"panel"===e?"panel":"bot"}function m(e="bot"){return _[d(e)]}function p(e,t={}){const o=e.runtime?.mode||"systemd";n.metaServiceName&&(n.metaServiceName.textContent=`target: ${"docker"===o&&e.openclaw.container_name||e.openclaw.service_name}`),n.metaLogSource&&(n.metaLogSource.textContent=`log: ${e.log.source} (${o})`),r("dashboard_panel_local_url",t.panelLocalUrl||"-"),r("dashboard_panel_public_url",t.panelPublicUrl||"未配置（请填写公网 IP + 端口）"),r("dashboard_gateway_public_url",t.gatewayPublicUrl||"未配置（请填写公网 IP + 端口）"),r("dashboard_webhook_base_url",t.webhookBaseUrl||"未配置（请填写公网 IP + 端口）"),n.dashboardPublicHint&&(t.hasPublicEndpoint&&t.hasWebhookEndpoint?n.dashboardPublicHint.textContent="公网访问地址与 Webhook 回调基地址已就绪，可直接复制到外部平台。":n.dashboardPublicHint.innerHTML="若为空，请在 <code>data/panel/panel.config.json</code> 的 <code>reverse_proxy</code> 中填写公网 IP 与端口。"),n.serviceHint&&(n.serviceHint.textContent="docker"===o?"当前为 Docker 运行时，按钮将控制容器。":"当前为 systemd 运行时，按钮将控制服务。")}function f(e,t="info",n="bot"){const o=m(n),a=document.querySelector(`#${o.stateId}`);a&&(a.textContent=e,a.classList.toggle("success","success"===t),a.classList.toggle("fail","fail"===t))}function h(e,t="bot"){const n=m(t),o=document.querySelector(`#${n.hintId}`);o&&(o.textContent=e)}const y={bot:!1,panel:!1},b={bot:{value:0,timer:null},panel:{value:0,timer:null}};function k(e=0,{target:t="bot",mode:n="idle",text:o=""}={}){const a=d(t),r=m(a),s=document.querySelector(`#${r.progressWrapId}`),l=document.querySelector(`#${r.progressBarId}`),i=document.querySelector(`#${r.progressTextId}`);if(!(s&&l instanceof HTMLProgressElement&&i))return;const c=Math.max(0,Math.min(100,Number(e)||0));b[a].value=c,l.value=c,i.textContent=o||`等待操作（${Math.round(c)}%）`,s.classList.toggle("is-working","working"===n),s.classList.toggle("is-done","done"===n),s.classList.toggle("is-fail","fail"===n)}function w(e="bot"){const t=d(e),n=b[t].timer;n&&(clearInterval(n),b[t].timer=null)}function S(e="bot",{success:t=!0,text:n=""}={}){const o=d(e);w(o),k(100,{target:o,mode:t?"done":"fail",text:n||(t?"操作完成":"操作失败")+"（100%）"})}function T(e="bot",t=!1){const n=m(d(e));[n.checkButtonId,n.upgradeButtonId,n.rollbackButtonId,n.applyButtonId].filter(Boolean).forEach(e=>{const n=document.querySelector(`#${e}`);n instanceof HTMLButtonElement&&(n.disabled=!!t,n.setAttribute("aria-busy",t?"true":"false"))})}function $(e){return String(e??"").trim().length>0}function M(e,t,n){const o=document.querySelector(`#${e}`);o&&(o.textContent=t,"variant"in o?o.variant=n:o.className=`status-pill ${n}`)}function I(e={}){["telegram","feishu","discord","slack"].forEach(t=>{const n=e?.[t]&&"object"==typeof e[t]?e[t]:{},o=!!n.enabled,a=function(e,t={}){if(!t||"object"!=typeof t)return!1;if("telegram"===e)return $(t.botToken);if("feishu"===e)return $(t.appId)&&$(t.appSecret);if("discord"===e)return $(t.token);if("slack"===e){const e=String(t.mode||"socket").trim().toLowerCase();return!!$(t.botToken)&&$("http"===e?t.signingSecret:t.appToken)}return!1}(t,n),r=document.querySelector(`#channel_status_${t}_summary`),s=document.querySelector(`[data-channel-card="${t}"]`),l="true"===s?.dataset?.channelDisabled;M(`channel_status_${t}_enabled`,o?"已启用":"未启用",o?"success":"neutral"),M(`channel_status_${t}_configured`,a?"已配置":"未配置",a?"success":"warning"),r&&(r.textContent=l?"功能开发中，暂不支持进入配置页。":a&&o?"配置完整，可直接使用。":a?"配置已填，但当前处于未启用状态。":"还没填完关键凭证，点进去补齐即可。"),s&&(s.classList.toggle("is-ready",a&&o),s.classList.toggle("is-partial",a&&!o),s.classList.toggle("is-missing",!a))})}function v(e,t=""){return document.querySelector(`#${e}`)?String(o(e)||""):String(t??"")}function x(e,t=!1){return document.querySelector(`#${e}`)?!!o(e):!!t}function P(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.floor(t)}function C(e){const t=Number(e);return!Number.isFinite(t)||t<0?null:Math.floor(t)}function L(e,t=null){if(!document.querySelector(`#${e}`))return P(t);const n=String(o(e)||"").trim();return n?P(n):null}function B(e,t=null){if(!document.querySelector(`#${e}`))return C(t);const n=String(o(e)||"").trim();return n?C(n):null}function j(e){const t=Number(e);return!Number.isFinite(t)||t<0||t>1?null:Number(t.toFixed(4))}function E(e,t=null){if(!document.querySelector(`#${e}`))return j(t);const n=String(o(e)||"").trim();return n?j(n):null}function q(e,t=null){if(!document.querySelector(`#${e}`))return"boolean"==typeof t?t:null;const n=String(o(e)||"default").trim().toLowerCase();return"true"===n||"false"!==n&&null}const A=Object.freeze([{elementId:"tg_groups_json",label:"群组覆盖（groupsJson）",expectedType:"object"},{elementId:"tg_accounts_json",label:"账号映射（accountsJson）",expectedType:"object"},{elementId:"tg_custom_commands_json",label:"自定义命令（customCommandsJson）",expectedType:"array"},{elementId:"tg_draft_chunk_json",label:"草稿分块（draftChunkJson）",expectedType:"object"}]),F=Object.freeze({tg_enabled:!1,tg_token_file:"",tg_dm_policy:"pairing",tg_allow_from:"",tg_group_policy:"allowlist",tg_group_allow_from:"",tg_require_mention:!0,tg_stream_mode:"partial",tg_chunk_mode:"length",tg_text_chunk_limit:"",tg_reply_to_mode:"off",tg_link_preview:!0,tg_block_streaming:!1,tg_timeout_seconds:"",tg_media_max_mb:"",tg_dm_history_limit:"",tg_history_limit:"",tg_webhook_url:"",tg_webhook_secret:"",tg_webhook_path:"/telegram-webhook",tg_proxy:"",tg_config_writes:!0,tg_reaction_level:"minimal",tg_reaction_notifications:"own",tg_inline_buttons:"allowlist",tg_action_send_message:!0,tg_action_reactions:!0,tg_action_delete_message:!0,tg_action_sticker:!1,tg_network_auto_select_family:"default",tg_retry_attempts:"",tg_retry_min_delay_ms:"",tg_retry_max_delay_ms:"",tg_retry_jitter:"",tg_commands_native:"default",tg_groups_json:"",tg_accounts_json:"",tg_custom_commands_json:"",tg_draft_chunk_json:""});async function O(){window.confirm("将 Telegram 高级配置重置为默认值并立即保存，是否继续？")?(Object.entries(F).forEach(([e,t])=>{r(e,t)}),await z(),s("Telegram 高级配置已重置为默认值并保存","ok")):s("已取消重置 Telegram 高级配置","info")}function J(){const e=function(){const e=t.settings;if(!e||"object"!=typeof e)return{};const n=e.channels;return n&&"object"==typeof n?n:{}}(),n=e.telegram&&"object"==typeof e.telegram?e.telegram:{},o=e.feishu&&"object"==typeof e.feishu?e.feishu:{},a=e.discord&&"object"==typeof e.discord?e.discord:{},r=e.slack&&"object"==typeof e.slack?e.slack:{};return{telegram:{enabled:x("tg_enabled",n.enabled),botToken:v("tg_bot_token",n.botToken),tokenFile:v("tg_token_file",n.tokenFile),dmPolicy:v("tg_dm_policy",n.dmPolicy||"pairing")||"pairing",allowFrom:v("tg_allow_from",n.allowFrom),groupPolicy:v("tg_group_policy",n.groupPolicy||"allowlist")||"allowlist",groupAllowFrom:v("tg_group_allow_from",n.groupAllowFrom),requireMention:x("tg_require_mention",n.requireMention),streamMode:v("tg_stream_mode",n.streamMode||"partial")||"partial",chunkMode:v("tg_chunk_mode",n.chunkMode||"length")||"length",textChunkLimit:L("tg_text_chunk_limit",n.textChunkLimit),replyToMode:v("tg_reply_to_mode",n.replyToMode||"off")||"off",linkPreview:x("tg_link_preview",n.linkPreview),blockStreaming:x("tg_block_streaming",n.blockStreaming),timeoutSeconds:L("tg_timeout_seconds",n.timeoutSeconds),mediaMaxMb:L("tg_media_max_mb",n.mediaMaxMb),dmHistoryLimit:B("tg_dm_history_limit",n.dmHistoryLimit),historyLimit:B("tg_history_limit",n.historyLimit),webhookUrl:v("tg_webhook_url",n.webhookUrl),webhookSecret:v("tg_webhook_secret",n.webhookSecret),webhookPath:v("tg_webhook_path",n.webhookPath||"/telegram-webhook"),proxy:v("tg_proxy",n.proxy),configWrites:x("tg_config_writes",n.configWrites),reactionLevel:v("tg_reaction_level",n.reactionLevel||"minimal")||"minimal",reactionNotifications:v("tg_reaction_notifications",n.reactionNotifications||"own")||"own",inlineButtons:v("tg_inline_buttons",n.inlineButtons||"allowlist")||"allowlist",actionSendMessage:x("tg_action_send_message",n.actionSendMessage),actionReactions:x("tg_action_reactions",n.actionReactions),actionDeleteMessage:x("tg_action_delete_message",n.actionDeleteMessage),actionSticker:x("tg_action_sticker",n.actionSticker),networkAutoSelectFamily:q("tg_network_auto_select_family",n.networkAutoSelectFamily),retryAttempts:L("tg_retry_attempts",n.retryAttempts),retryMinDelayMs:L("tg_retry_min_delay_ms",n.retryMinDelayMs),retryMaxDelayMs:L("tg_retry_max_delay_ms",n.retryMaxDelayMs),retryJitter:E("tg_retry_jitter",n.retryJitter),commandsNative:v("tg_commands_native",n.commandsNative||"default")||"default",groupsJson:v("tg_groups_json",n.groupsJson),accountsJson:v("tg_accounts_json",n.accountsJson),customCommandsJson:v("tg_custom_commands_json",n.customCommandsJson),draftChunkJson:v("tg_draft_chunk_json",n.draftChunkJson)},feishu:{enabled:x("fs_enabled",o.enabled),appId:v("fs_app_id",o.appId),appSecret:v("fs_app_secret",o.appSecret),domain:v("fs_domain",o.domain||"feishu")||"feishu",connectionMode:v("fs_connection_mode",o.connectionMode||"websocket")||"websocket",dmPolicy:v("fs_dm_policy",o.dmPolicy||"pairing")||"pairing",allowFrom:v("fs_allow_from",o.allowFrom),groupPolicy:v("fs_group_policy",o.groupPolicy||"allowlist")||"allowlist",groupAllowFrom:v("fs_group_allow_from",o.groupAllowFrom),requireMention:x("fs_require_mention",o.requireMention)},discord:{enabled:x("dc_enabled",a.enabled),token:v("dc_token",a.token),dmPolicy:v("dc_dm_policy",a.dmPolicy||"pairing")||"pairing",allowFrom:v("dc_allow_from",a.allowFrom),groupPolicy:v("dc_group_policy",a.groupPolicy||"allowlist")||"allowlist",allowBots:x("dc_allow_bots",a.allowBots),requireMention:x("dc_require_mention",a.requireMention)},slack:{enabled:x("sl_enabled",r.enabled),mode:v("sl_mode",r.mode||"socket")||"socket",botToken:v("sl_bot_token",r.botToken),appToken:v("sl_app_token",r.appToken),signingSecret:v("sl_signing_secret",r.signingSecret),dmPolicy:v("sl_dm_policy",r.dmPolicy||"pairing")||"pairing",allowFrom:v("sl_allow_from",r.allowFrom),groupPolicy:v("sl_group_policy",r.groupPolicy||"allowlist")||"allowlist",allowBots:x("sl_allow_bots",r.allowBots),requireMention:x("sl_require_mention",r.requireMention)}}}function N(e){i(e.model),l(e.model),I(e.channels||{}),r("tg_enabled",e.channels.telegram.enabled),r("tg_bot_token",e.channels.telegram.botToken),r("tg_token_file",e.channels.telegram.tokenFile),r("tg_dm_policy",e.channels.telegram.dmPolicy),r("tg_allow_from",e.channels.telegram.allowFrom),r("tg_group_policy",e.channels.telegram.groupPolicy),r("tg_group_allow_from",e.channels.telegram.groupAllowFrom),r("tg_require_mention",e.channels.telegram.requireMention),r("tg_stream_mode",e.channels.telegram.streamMode),r("tg_chunk_mode",e.channels.telegram.chunkMode),r("tg_text_chunk_limit",e.channels.telegram.textChunkLimit??""),r("tg_reply_to_mode",e.channels.telegram.replyToMode),r("tg_link_preview",e.channels.telegram.linkPreview),r("tg_block_streaming",e.channels.telegram.blockStreaming),r("tg_timeout_seconds",e.channels.telegram.timeoutSeconds??""),r("tg_media_max_mb",e.channels.telegram.mediaMaxMb??""),r("tg_dm_history_limit",e.channels.telegram.dmHistoryLimit??""),r("tg_history_limit",e.channels.telegram.historyLimit??""),r("tg_webhook_url",e.channels.telegram.webhookUrl),r("tg_webhook_secret",e.channels.telegram.webhookSecret),r("tg_webhook_path",e.channels.telegram.webhookPath||"/telegram-webhook"),r("tg_proxy",e.channels.telegram.proxy),r("tg_config_writes",e.channels.telegram.configWrites),r("tg_reaction_level",e.channels.telegram.reactionLevel),r("tg_reaction_notifications",e.channels.telegram.reactionNotifications),r("tg_inline_buttons",e.channels.telegram.inlineButtons),r("tg_action_send_message",e.channels.telegram.actionSendMessage),r("tg_action_reactions",e.channels.telegram.actionReactions),r("tg_action_delete_message",e.channels.telegram.actionDeleteMessage),r("tg_action_sticker",e.channels.telegram.actionSticker),r("tg_network_auto_select_family",null===e.channels.telegram.networkAutoSelectFamily?"default":e.channels.telegram.networkAutoSelectFamily?"true":"false"),r("tg_retry_attempts",e.channels.telegram.retryAttempts??""),r("tg_retry_min_delay_ms",e.channels.telegram.retryMinDelayMs??""),r("tg_retry_max_delay_ms",e.channels.telegram.retryMaxDelayMs??""),r("tg_retry_jitter",e.channels.telegram.retryJitter??""),r("tg_commands_native",e.channels.telegram.commandsNative||"default"),r("tg_groups_json",e.channels.telegram.groupsJson||""),r("tg_accounts_json",e.channels.telegram.accountsJson||""),r("tg_custom_commands_json",e.channels.telegram.customCommandsJson||""),r("tg_draft_chunk_json",e.channels.telegram.draftChunkJson||""),r("fs_enabled",e.channels.feishu.enabled),r("fs_app_id",e.channels.feishu.appId),r("fs_app_secret",e.channels.feishu.appSecret),r("fs_domain",e.channels.feishu.domain),r("fs_connection_mode",e.channels.feishu.connectionMode),r("fs_dm_policy",e.channels.feishu.dmPolicy),r("fs_allow_from",e.channels.feishu.allowFrom),r("fs_group_policy",e.channels.feishu.groupPolicy),r("fs_group_allow_from",e.channels.feishu.groupAllowFrom),r("fs_require_mention",e.channels.feishu.requireMention),r("dc_enabled",e.channels.discord.enabled),r("dc_token",e.channels.discord.token),r("dc_dm_policy",e.channels.discord.dmPolicy),r("dc_allow_from",e.channels.discord.allowFrom),r("dc_group_policy",e.channels.discord.groupPolicy),r("dc_allow_bots",e.channels.discord.allowBots),r("dc_require_mention",e.channels.discord.requireMention),r("sl_enabled",e.channels.slack.enabled),r("sl_mode",e.channels.slack.mode),r("sl_bot_token",e.channels.slack.botToken),r("sl_app_token",e.channels.slack.appToken),r("sl_signing_secret",e.channels.slack.signingSecret),r("sl_dm_policy",e.channels.slack.dmPolicy),r("sl_allow_from",e.channels.slack.allowFrom),r("sl_group_policy",e.channels.slack.groupPolicy),r("sl_allow_bots",e.channels.slack.allowBots),r("sl_require_mention",e.channels.slack.requireMention)}async function D(){const[n,o]=await Promise.all([e("/api/panel-config"),e("/api/settings")]);t.settings=o.settings||null,["bot","panel"].forEach(e=>{k(0,{target:e,mode:"idle",text:"等待操作（0%）"})}),p(n.config,n.deployment||{}),N(o.settings)}async function H({silent:t=!1,target:n="bot"}={}){const a=d(n),l=m(a),i=(await e(`/api/update/check?target=${encodeURIComponent(a)}`)).result||{};return r(l.currentTagId,i.currentTag||""),r(l.latestTagId,i.latestTag||""),!String(o(l.targetTagId)||"").trim()&&i.latestTag&&r(l.targetTagId,i.latestTag),i.warning?(f("检查异常","fail",a),h(`已读取当前版本，但远程版本检查失败：${i.warning}`,a),"bot"===a&&g(i),t||s(`${l.label} 更新检查告警：${i.warning}`,"error"),i):(i.updateAvailable?(f("有可用更新","success",a),h(`当前 ${i.currentTag||"-"}，最新 ${i.latestTag||"-"}`,a)):(f("已是最新","success",a),h(`当前 ${i.currentTag||"-"}，无需升级`,a)),"bot"===a&&g(i),t||s(`${l.label} 版本检查完成：current=${i.currentTag||"-"} latest=${i.latestTag||"-"}`,"ok"),i)}async function R({silent:e=!1}={}){const t=(await Promise.allSettled([H({silent:e,target:"bot"}),H({silent:e,target:"panel"})])).find(e=>"rejected"===e.status);if(t&&"rejected"===t.status)throw t.reason}async function U(t,{target:n="bot"}={}){const a=d(n),l=m(a);if(y[a])return void s(`${l.label} 正在执行更新操作，请稍候`,"info");const i={upgrade:"升级",rollback:"回滚",apply:"重启并应用"}[t]||"更新";let c=String(o(l.targetTagId)||"").trim();if(!c&&("upgrade"===t||"apply"===t)&&(c=await async function(t="",n="bot"){const a=d(n),s=m(a),l=String(t||"").trim();if(l)return l;const i=String(o(s.latestTagId)||"").trim();if(i)return r(s.targetTagId,i),i;const c=await e(`/api/update/check?target=${encodeURIComponent(a)}`),g=String(c?.result?.latestTag||"").trim();if(!g)throw new Error("无法自动获取最新版本，请先点击“检查新版本”或手工填写目标版本");return r(s.latestTagId,g),r(s.targetTagId,g),g}(c,a),s(`${l.label} 未填写目标版本，已自动选择最新版本：${c}`,"info")),!c)throw"rollback"===t?new Error("请先输入回滚目标版本"):new Error("请先输入目标版本");y[a]=!0,T(a,!0),f(`${i}进行中`,"info",a),h(`${i}执行中，请稍候...`,a),function(e="bot",t="正在处理..."){const n=d(e);w(n);const o=Math.max(b[n].value||0,10);k(o,{target:n,mode:"working",text:`${t}（${Math.round(o)}%）`}),b[n].timer=setInterval(()=>{const e=b[n].value||0;if(e>=92)return;const o=Math.min(92,e+(e<55?6:2));k(o,{target:n,mode:"working",text:`${t}（${Math.round(o)}%）`})},550)}(a,`${i}执行中`);try{const n="apply"===t?"/api/update/apply":`/api/update/${t}`,o=(await e(n,{method:"POST",body:JSON.stringify({tag:c,target:a}),allowBusinessError:!0})).result||{};if(o.ok){const e=String(o.targetImage||"").trim().split(":").pop(),n=String(o.oldImage||"").trim().split(":").pop();if("panel"===a&&"apply"!==t)return f("upgrade"===t?"更新包已准备":"回滚包已准备","success",a),h(o.message||"版本包已准备完成，请点击“应用更新并重启”生效",a),r(l.currentTagId,n||""),e&&r(l.targetTagId,e),S(a,{success:!0,text:`${i}完成（100%）`}),void s(`${l.label}${i}成功：${o.targetImage}`,"ok");if(f("apply"===t?"已重启并应用":"upgrade"===t?"升级成功":"回滚成功","success",a),h(o.message||`当前版本：${o.targetImage||"-"}`,a),r(l.currentTagId,e||c),S(a,{success:!0,text:`${i}完成（100%）`}),s(`${l.label}${i}成功：${o.targetImage}`,"ok"),await H({silent:!0,target:a}).catch(()=>{}),"bot"===a&&(await K("status").catch(()=>{}),await V().catch(()=>{})),"panel"===a&&"apply"===t&&o.requiresReconnect){const e=Math.max(2e3,Number(o.reconnectAfterMs)||6e3);s(`控制台正在重启，页面将在约 ${Math.ceil(e/1e3)} 秒后自动刷新`,"info"),window.setTimeout(()=>{window.location.reload()},e)}return}const g=`${o.message||"操作失败"}${o.rollbackMessage?`；${o.rollbackMessage}`:o.rolledBack?"；已自动回滚":""}`;f("apply"===t?"应用失败":"upgrade"===t?"升级失败":"回滚失败","fail",a),h(g,a),S(a,{success:!1,text:`${i}失败（100%）`}),s(`${l.label}${i}失败：${g}`,"error")}catch(e){const n=e?.message||String(e);f("apply"===t?"应用失败":"upgrade"===t?"升级失败":"回滚失败","fail",a),h(n,a),S(a,{success:!1,text:`${i}失败（100%）`}),s(`${l.label}${i}异常：${n}`,"error")}finally{y[a]=!1,T(a,!1)}}async function W(t,n){const o=await e("/api/settings",{method:"PUT",body:JSON.stringify({model:t})});a.currentModelPayload=t,s(`${n}：${o.path}`,"ok"),await D()}async function z(){if(!a.currentModelPayload)throw new Error("模型配置尚未初始化，请刷新页面后重试");A.forEach(e=>{!function(e,t,n){if(!document.querySelector(`#${e}`))return;const a=String(o(e)||"").trim();if(!a)return;let r;try{r=JSON.parse(a)}catch{throw new Error(`${t} JSON 格式不正确，请检查括号与引号。`)}const s=Array.isArray(r);if("array"===n&&!s)throw new Error(`${t} 必须是 JSON 数组。`);if("object"===n&&(!r||"object"!=typeof r||s))throw new Error(`${t} 必须是 JSON 对象。`)}(e.elementId,`Telegram ${e.label}`,e.expectedType)});const t={model:a.currentModelPayload,channels:J()},n=await e("/api/settings",{method:"PUT",body:JSON.stringify(t)});s(`平台接入配置写入成功（模型保持当前值）：${n.path}`,"ok"),await D()}async function K(t,{silentMessage:o=!1,autoRefresh:a=!0}={}){const r=await e(`/api/service/${t}`,{method:"POST",allowBusinessError:!0}),l=r.result||{};if(n.serviceOutput&&(n.serviceOutput.textContent=l.output||l.message||"(empty)"),r.ok){if("status"===t&&n.serviceState&&n.serviceHint){const e=!!l.active;n.serviceState.textContent=e?"运行中":"未运行",n.serviceState.classList.toggle("success",e),n.serviceState.classList.toggle("fail",!e),n.serviceHint.textContent=e?"服务状态正常。你可以继续联调渠道或查看日志。":"服务未运行。请先启动或检查 systemd 权限。"}if(o||s(`service ${t}: 成功`,"ok"),a&&"status"!==t&&n.serviceState&&n.serviceHint)try{await K("status",{silentMessage:!0,autoRefresh:!1}),o||s("服务状态已自动刷新","info")}catch(e){o||s(`服务状态自动刷新失败：${e.message||String(e)}`,"error")}}else{if("status"===t&&n.serviceState&&n.serviceHint&&(n.serviceState.textContent="状态异常",n.serviceState.classList.toggle("success",!1),n.serviceState.classList.toggle("fail",!0),n.serviceHint.textContent=l.message||"服务状态读取失败，请检查容器或 systemd 权限。"),a&&"status"!==t&&n.serviceState&&n.serviceHint)try{await K("status",{silentMessage:!0,autoRefresh:!1})}catch{}o||s(`service ${t}: 失败 - ${l.message||l.output||"未知错误"}`,"error")}}async function V(){if(!n.logOutput)return;const t=encodeURIComponent(String(o("log_filter")||"")),a=await e(`/api/logs/tail?lines=200&filter=${t}`);n.logOutput.textContent=a.lines.join("\n"),s(`日志加载完成，共 ${a.lines.length} 行`,"ok")}async function G({silent:t=!1}={}){const o=await e("/api/logs/errors?count=20");n.errorSummary&&(n.errorSummary.innerHTML="",o.lines.forEach(e=>{const t=document.createElement("li");t.textContent=e,n.errorSummary.appendChild(t)})),c(o.lines),t||s(`错误摘要加载完成，共 ${o.lines.length} 条`,"ok")}function Q(){u&&(u.close(),u=null,s("实时日志流已停止","info"))}function X(){if(Q(),!n.logOutput)throw new Error("当前页面未加载日志面板");const e=encodeURIComponent(String(o("log_filter")||""));u=new EventSource(`/api/logs/stream?filter=${e}`),u.addEventListener("line",e=>{const t=`${JSON.parse(e.data).line}\n${n.logOutput.textContent}`;n.logOutput.textContent=t.slice(0,3e4)}),u.addEventListener("error",()=>{s("日志流出现错误，请检查日志来源配置","error")}),s("实时日志流已启动","ok")}function Y(e,t,n){const o=document.querySelector(`#${e}`);if(!o)return;const a=(new Date).toLocaleTimeString();o.textContent=`最近测试（${a}）：${n?"成功":"失败"} - ${t}`,o.classList.toggle("success",!!n),o.classList.toggle("fail",!n)}function Z(e,t,n){const o=document.querySelector(`#${e}`);if(!o)return;const a=(new Date).toLocaleTimeString();o.textContent=`最近执行（${a}）：${t}`,null!==n?(o.classList.toggle("success",!!n),o.classList.toggle("fail",!n)):o.classList.remove("success","fail")}function ee(e,t=[]){const n=document.querySelector(`#${e}`);if(!n)return;if(!Array.isArray(t)||0===t.length)return void(n.textContent="暂无执行记录");const o=[];t.forEach((e,t)=>{const n=String(e?.label||`步骤 ${t+1}`).trim(),a=e?.ok?"成功":"失败",r=String(e?.command||"").trim(),s=String(e?.output||"").trim()||"(无输出)";o.push(`[${t+1}] ${n} - ${a}`),r&&o.push(`命令: ${r}`),o.push(`输出: ${s}`),o.push("")}),n.textContent=o.join("\n").trim()}const te={setup:!1,pairing:!1};function ne(e,t,n){const o=document.querySelector(`#${e}`);o instanceof HTMLButtonElement&&(o.dataset.originalLabel||(o.dataset.originalLabel=String(o.textContent||"").trim()),o.disabled=!!t,o.setAttribute("aria-busy",t?"true":"false"),o.textContent=t?n:o.dataset.originalLabel)}async function oe({lockKey:e,buttonId:t,busyLabel:n,pendingResultId:o,pendingDetail:a,duplicateClickMessage:r,pendingMessage:l,run:i}){if(te[e])r&&s(r,"info");else{te[e]=!0,ne(t,!0,n),o&&a&&Z(o,a,null),l&&s(l,"info");try{await i()}finally{te[e]=!1,ne(t,!1,n)}}}async function ae(){const t=String(o("tg_bot_token")||"").trim();if(!t)throw Z("tg_setup_result","失败：请先填写 Bot Token",!1),new Error("Telegram 基础配置失败：Bot Token 不能为空");await oe({lockKey:"setup",buttonId:"tg_setup_basic",busyLabel:"保存中...",pendingResultId:"tg_setup_result",pendingDetail:"处理中：正在启用 Telegram 插件并写入 Bot Token",duplicateClickMessage:"Telegram 基础配置正在处理中，请勿重复点击",pendingMessage:"Telegram 基础配置处理中，请稍候…",run:async()=>{const n=await e("/api/channels/telegram/setup",{method:"POST",body:JSON.stringify({botToken:t}),allowBusinessError:!0}),o=n.result&&"object"==typeof n.result?n.result:{};if(ee("tg_setup_trace",Array.isArray(o.steps)?o.steps:[]),!n.ok||!1===o.ok){const e=String(o.message||n.message||"Telegram 基础配置失败");return Z("tg_setup_result",`失败：${e}`,!1),void s(`Telegram 基础配置失败：${e}`,"error")}const a=String(o.message||"Telegram 基础配置完成");Z("tg_setup_result",`成功：${a}`,!0),s(a,"ok"),await D()}})}async function re(){const t=String(o("tg_pairing_code")||"").trim();if(!t)throw Z("tg_pairing_result","失败：请先填写验证码",!1),new Error("Telegram 配对失败：验证码不能为空");await oe({lockKey:"pairing",buttonId:"tg_pairing_approve",busyLabel:"验证中...",pendingResultId:"tg_pairing_result",pendingDetail:"处理中：正在提交验证码并等待验证结果",duplicateClickMessage:"Telegram 验证正在处理中，请勿重复点击",pendingMessage:"Telegram 验证处理中，请稍候…",run:async()=>{const n=await e("/api/channels/telegram/pairing/approve",{method:"POST",body:JSON.stringify({code:t}),allowBusinessError:!0}),o=n.result&&"object"==typeof n.result?n.result:{},a=o.step&&"object"==typeof o.step?o.step:null;if(a&&ee("tg_pairing_trace",[a]),!n.ok||!1===o.ok){const e=String(o.message||n.message||"验证码验证失败");return Z("tg_pairing_result",`失败：${e}`,!1),void s(`Telegram 配对失败：${e}`,"error")}const r=String(o.message||"验证码验证成功");Z("tg_pairing_result",`成功：${r}`,!0),s(r,"ok")}})}async function se(){const e=String(o("tg_bot_token")||"").trim();await z(),e&&r("tg_bot_token",e),await ie()}async function le(){const e=String(o("fs_app_id")||"").trim(),t=String(o("fs_app_secret")||"").trim();await z(),e&&r("fs_app_id",e),t&&r("fs_app_secret",t),await ce()}async function ie(){const t={botToken:String(o("tg_bot_token")||"")};if(!t.botToken)throw Y("tg_test_result","失败：请先填写 Bot Token",!1),new Error("Telegram 测试失败：Bot Token 不能为空");const n=await e("/api/test/telegram",{method:"POST",body:JSON.stringify(t),allowBusinessError:!0});Y("tg_test_result",n.message||"-",n.ok),s(`Telegram 测试：${n.message}`,n.ok?"ok":"error")}async function ce(){const t={appId:String(o("fs_app_id")||""),appSecret:String(o("fs_app_secret")||"")};if(!t.appId||!t.appSecret)throw Y("fs_test_result","失败：请先填写 App ID 与 App Secret",!1),new Error("Feishu 测试失败：App ID / App Secret 不能为空");const n=await e("/api/test/feishu",{method:"POST",body:JSON.stringify(t),allowBusinessError:!0});Y("fs_test_result",n.message||"-",n.ok),s(`Feishu 测试：${n.message}`,n.ok?"ok":"error")}async function ge(){const t={token:String(o("dc_token")||"")};if(!t.token)throw Y("dc_test_result","失败：请先填写 Discord Bot Token",!1),new Error("Discord 测试失败：Bot Token 不能为空");const n=await e("/api/test/discord",{method:"POST",body:JSON.stringify(t),allowBusinessError:!0});Y("dc_test_result",n.message||"-",n.ok),s(`Discord 测试：${n.message}`,n.ok?"ok":"error")}async function ue(){const t=String(o("sl_mode")||"socket"),n={mode:t,botToken:String(o("sl_bot_token")||""),appToken:String(o("sl_app_token")||""),signingSecret:String(o("sl_signing_secret")||"")};if(!n.botToken)throw Y("sl_test_result","失败：请先填写 Slack Bot Token",!1),new Error("Slack 测试失败：Bot Token 不能为空");if("socket"===t&&!n.appToken)throw Y("sl_test_result","失败：socket 模式需要 App Token",!1),new Error("Slack 测试失败：socket 模式需要 App Token");if("http"===t&&!n.signingSecret)throw Y("sl_test_result","失败：http 模式需要 Signing Secret",!1),new Error("Slack 测试失败：http 模式需要 Signing Secret");const a=await e("/api/test/slack",{method:"POST",body:JSON.stringify(n),allowBusinessError:!0});Y("sl_test_result",a.message||"-",a.ok),s(`Slack 测试：${a.message}`,a.ok?"ok":"error")}export{re as approveTelegramPairingFlow,R as checkAllUpdates,H as checkUpdate,p as fillPanelMeta,N as fillSettings,G as loadErrorSummary,D as loadInitialData,V as loadTail,U as mutateVersion,O as resetTelegramAdvancedSettings,I as renderChannelAccessOverview,K as runService,le as saveAndTestFeishu,se as saveAndTestTelegram,W as saveModelSettings,z as saveSettings,Z as setChannelActionResult,Y as setChannelTestResult,f as setUpdateState,ae as setupTelegramBasicFlow,X as startStream,Q as stopStream,ge as testDiscord,ce as testFeishu,ue as testSlack,ie as testTelegram};