import{api as e,chatConsoleState as t,getInputValue as n,setInput as s,setMessage as r}from"../core/panel-core.js";function a(e){s("chat_stream_status",e||"")}function i(e){t.sending=!!e;const n=document.querySelector("#chat_send_message"),s=document.querySelector("#chat_abort_run");n&&(n.disabled=t.sending,n.textContent=t.sending?"发送中...":"发送消息"),s&&(s.disabled=!t.sending)}function o(e){const t=document.querySelector("#chat_attachment_hint");t&&(t.textContent=String(e||"").trim()||"支持点击上传、粘贴或拖拽文件（图片会显示预览）")}function c(e,t=""){const n=document.querySelector("#chat_inline_hint");n&&(n.textContent=String(e||"").trim(),n.classList.remove("error","ok"),"error"===t?n.classList.add("error"):"ok"===t&&n.classList.add("ok"))}function l(e,t="操作失败"){const n=String(e?.message||e||"").trim()||t;c(n,"error"),r(n,"error")}function m(e){const t=Number(e||0);return!Number.isFinite(t)||t<=0?"-":t<1024?`${t} B`:t<1048576?`${(t/1024).toFixed(1)} KB`:`${(t/1048576).toFixed(2)} MB`}function d(){const e=document.querySelector("#chat_attachment_list");if(!e)return;e.innerHTML="";const n=Array.isArray(t.attachments)?t.attachments:[];if(0===n.length){const t=document.createElement("div");return t.className="chat-empty",t.textContent="当前没有附件",void e.appendChild(t)}n.forEach((t,n)=>{const s=document.createElement("div");s.className="chat-attachment-item";const r=document.createElement("div");r.className="chat-attachment-row";const a=document.createElement("div"),i=document.createElement("div");i.className="chat-attachment-name",i.textContent=String(t.fileName||"file");const o=document.createElement("div");o.className="chat-attachment-meta",o.textContent=`${String(t.mimeType||"application/octet-stream")} | ${m(t.fileSize)}`,a.appendChild(i),a.appendChild(o);const c=document.createElement("button");if(c.type="button",c.className="btn-soft",c.dataset.attachmentIndex=String(n),c.textContent="移除",r.appendChild(a),r.appendChild(c),s.appendChild(r),t.preview&&String(t.mimeType||"").startsWith("image/")){const e=document.createElement("img");e.className="chat-attachment-preview",e.src=t.preview,e.alt=String(t.fileName||"image"),s.appendChild(e)}e.appendChild(s)})}async function u(t){const n=String(t?.name||"").trim()||"file",s=String(t?.type||"").trim()||"application/octet-stream",r=await function(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const e=String(s.result||""),n=e.match(/^data:[^;]+;base64,(.+)$/i);t(n?n[1]:e)},s.onerror=()=>{n(new Error(`读取文件失败：${e?.name||"unknown"}`))},s.readAsDataURL(e)})}(t),a=await e("/api/chat/attachments/stage",{method:"POST",body:JSON.stringify({fileName:n,mimeType:s,base64:r})});return a?.result&&"object"==typeof a.result?a.result:null}async function h(e){const n=Array.from(e||[]).filter(Boolean);if(0!==n.length){if(t.staging)return void o("附件还在处理中，请稍候再操作");t.staging=!0,o(`正在处理附件（${n.length} 个）...`);try{for(const e of n){const n=await u(e);if(!n)continue;const s=String(n.stagedPath||"").trim();if(!s)continue;const r=t.attachments.findIndex(e=>e.stagedPath===s);r>=0?t.attachments[r]=n:t.attachments.push(n)}d(),o(`附件已就绪：${t.attachments.length} 个`)}finally{t.staging=!1}}}function g(){const e=document.querySelector("#chat_stream_output");e&&(e.textContent=t.streamLines.length>0?t.streamLines.join("\n"):"等待流式事件...")}function y(e){const n=`[${(new Date).toLocaleTimeString()}] ${e}`;t.streamLines.push(n),t.streamLines.length>300&&(t.streamLines=t.streamLines.slice(-300)),g()}function p(){t.streamSource&&(t.streamSource.close(),t.streamSource=null),t.streamSessionKey=""}function f(e){return"string"==typeof e?e:Array.isArray(e)?e.map(e=>"string"==typeof e?e:e&&"object"==typeof e?"toolCall"===e.type||"tool_call"===e.type?`[工具调用] ${String(e.name||e.tool||"unknown")}\n参数:\n${"string"==typeof e.arguments?e.arguments:JSON.stringify(e.arguments??e.partialJson??{},null,2)}`:"toolResult"===e.type||"tool_result"===e.type?`[工具结果]\n${"string"==typeof e.text?e.text:JSON.stringify(e.details??e.result??e,null,2)}`:"string"==typeof e.text?e.text:"string"==typeof e.content?e.content:JSON.stringify(e):"").filter(Boolean).join("\n"):e&&"object"==typeof e?"string"==typeof e.text?e.text:JSON.stringify(e):String(e??"")}function S(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _(e,{streaming:t=!1,showThinking:n=!0}={}){const s=document.createElement("div"),r=String(e?.role||"assistant").toLowerCase();s.className=`chat-message ${"user"===r?"user":"assistant"}${t?" streaming":""}`;const a=document.createElement("div");a.className="chat-message-header";const i=document.createElement("span");i.className="chat-role",i.textContent=function(e){const t=String(e||"").trim().toLowerCase();return"user"===t?"你":"assistant"===t?"助手":"system"===t?"系统":"tool"===t||"tool_use"===t||"tool_result"===t||"toolresult"===t||"toolcall"===t?"工具":t||"未知"}(r),a.appendChild(i);const o=document.createElement("span");if(o.textContent=t?"实时生成中...":String(e?.status||"").trim()||"",a.appendChild(o),s.appendChild(a),n&&String(e?.thinking||"").trim()){const t=document.createElement("span");t.className="chat-thinking",t.textContent=`思考：${e.thinking}`,s.appendChild(t)}const c=document.createElement("div");c.className="chat-message-body";const l=String(e?.body||"").trim()||"(空消息)";"assistant"===r||"system"===r||"tool"===r||"toolresult"===r||"toolcall"===r?c.innerHTML=function(e){const t=String(e||"");return t?t.split("```").map((e,t)=>{if(t%2==0)return function(e){let t=S(e);return t=t.replace(/\*\*([^\n*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/`([^`\n]+)`/g,"<code>$1</code>"),t=t.replace(/\n/g,"<br>"),`<span>${t}</span>`}(e);const n=e.indexOf("\n");let s="",r=e;return n>=0&&(s=e.slice(0,n).trim(),r=e.slice(n+1)),`<pre class="chat-code"><code${s?` data-lang="${S(s)}"`:""}>${S(r)}</code></pre>`}).join(""):"<span>(空消息)</span>"}(l):c.textContent=l,s.appendChild(c);const d=Array.isArray(e?.attachments)?e.attachments:[];if(d.length>0){const e=document.createElement("div");e.className="chip-line",d.forEach(t=>{const n=document.createElement("span");n.className="mini-chip",n.textContent=`${String(t?.fileName||"file")} (${m(t?.fileSize)})`,e.appendChild(n)}),s.appendChild(e)}return s}function v(){const e=document.querySelector("#chat_messages");if(!e)return;const s=!!n("chat_show_thinking");if(e.innerHTML="",(Array.isArray(t.historyMessages)?t.historyMessages:[]).forEach(t=>{e.appendChild(_(t,{showThinking:s}))}),Object.entries(t.streamDeltasByRunId).forEach(([n,r])=>{const a=String(t.streamThinkingByRunId[n]||"").trim();e.appendChild(_({role:"assistant",status:n?`runId: ${n}`:"",thinking:a,body:String(r||"").trim()||"正在生成..."},{streaming:!0,showThinking:s}))}),0===e.childElementCount){const t=document.createElement("div");t.className="chat-empty",t.textContent="请选择会话后开始对话",e.appendChild(t)}e.scrollTop=e.scrollHeight}function $(e,{silent:n=!1,force:o=!1}={}){const c=String(e||t.selectedSessionKey||"").trim();if(!c)return void a("未连接（未选择会话）");if(!o&&t.streamSource&&t.streamSessionKey===c)return;p(),t.streamSessionKey=c,t.streamLines=[],t.streamDeltasByRunId={},t.streamThinkingByRunId={},g(),v(),a(`连接中 (${c})`),n||r(`实时通道连接中：${c}`,"info");const l=new URLSearchParams({sessionKey:c,includeAgent:"true"}),m=new EventSource(`/api/chat/stream?${l.toString()}`);t.streamSource=m,m.addEventListener("ready",e=>{try{const t=JSON.parse(e.data||"{}");a(`已建立 (${t.sessionKey||c})`),y(`[stream:ready] session=${t.sessionKey||c}`)}catch{a("已建立")}}),m.addEventListener("status",e=>{try{const t=JSON.parse(e.data||"{}"),n=String(t.state||"").trim();a("connected"===n?`已连接 (${t.sessionKey||c})`:"reconnecting"===n?`重连中（第${t.attempt||1}次）`:"connect-failed"===n?"连接失败，自动重试中":"gateway-closed"===n?"网关断开，自动重连中":n||"状态更新"),y(`[stream:${n||"status"}] ${t.reason||t.message||""}`.trim())}catch{a("状态更新")}}),m.addEventListener("chat",e=>{try{!function(e){const n=e&&"object"==typeof e?e:{},r=String(n.state||"").trim(),a=String(n.runId||"").trim(),o=String(n.sessionKey||"").trim();a&&(t.lastRunId=a,s("chat_last_run_id",a));const c=function(e){return e&&"object"==typeof e?(Array.isArray(e?.content)?e.content:[]).map(e=>e&&"object"==typeof e&&"string"==typeof e.text?e.text:"").join(""):""}(n.message);if("delta"===r){if(a){const e=String(t.streamDeltasByRunId[a]||"");t.streamDeltasByRunId[a]=e+c}return y(`[chat:${r}] ${a||"-"} ${c||"(empty-delta)"}`),void v()}if("final"===r){const e=a?String(t.streamDeltasByRunId[a]||""):"";return y(`[chat:final] ${a||"-"} ${c||e||"(empty)"}`),a&&(delete t.streamDeltasByRunId[a],delete t.streamThinkingByRunId[a]),i(!1),v(),void(o&&w({sessionKey:o,silent:!0}).catch(()=>{}))}if("aborted"===r||"error"===r)return y(`[chat:${r}] ${a||"-"} ${String(n.stopReason||n.errorMessage||"").trim()||"-"}`),a&&(delete t.streamDeltasByRunId[a],delete t.streamThinkingByRunId[a]),i(!1),v(),void(o&&w({sessionKey:o,silent:!0}).catch(()=>{}));y(`[chat:${r||"unknown"}] ${a||"-"} seq=${n.seq??"-"}`)}(JSON.parse(e.data||"{}"))}catch(e){y(`[stream:parse-error] ${e.message||String(e)}`)}}),m.addEventListener("agent",e=>{try{!function(e){const n=e&&"object"==typeof e?e:{},s=String(n.stream||"").trim()||"-",r=String(n.phase||"").trim()||"-",a=String(n.runId||"").trim()||"-";y(`[agent:${s}] ${a} phase=${r}`),"-"!==a&&(t.streamThinkingByRunId[a]=r,v())}(JSON.parse(e.data||"{}"))}catch(e){y(`[stream:parse-error] ${e.message||String(e)}`)}}),m.addEventListener("stream-error",e=>{try{y(`[stream:error] ${JSON.parse(e.data||"{}").message||"unknown error"}`),i(!1)}catch{y("[stream:error] unknown error"),i(!1)}}),m.addEventListener("error",()=>{a("连接波动，浏览器重连中")})}async function k({silent:n=!1,preserveSelection:s=!0,selectedSessionKey:l=""}={}){const m=await e("/api/chat/sessions"),u=m?.result&&"object"==typeof m.result?m.result:{},h=Array.isArray(u.sessions)?u.sessions:[],g=String(t.selectedSessionKey||"").trim(),y=String(l||"").trim();if(t.sessions=h,t.selectedSessionKey=y&&h.some(e=>e?.key===y)?y:s&&g&&h.some(e=>e?.key===g)?g:String(h[0]?.key||"").trim(),t.attachments=[],d(),o("支持点击上传、粘贴或拖拽文件（图片会显示预览）"),function(){const e=document.querySelector("#chat_session_select");if(!e)return;const n=Array.isArray(t.sessions)?t.sessions:[];if(e.innerHTML="",0===n.length){const t=document.createElement("option");return t.value="",t.textContent="暂无会话",e.appendChild(t),void(e.value="")}n.forEach(t=>{const n=document.createElement("option");n.value=t?.key||"";const s=Number(t?.contextTokens||0),r=String(t?.model||"-"),a=String(t?.displayName||t?.key||"未命名会话");n.textContent=`${a} | ${r} | ctx ${s>0?s.toLocaleString():"-"}`,e.appendChild(n)}),t.selectedSessionKey&&n.some(e=>e?.key===t.selectedSessionKey)?e.value=t.selectedSessionKey:(e.selectedIndex=0,t.selectedSessionKey=String(e.value||"").trim())}(),t.selectedSessionKey)$(t.selectedSessionKey,{silent:!0}),await w({sessionKey:t.selectedSessionKey,silent:!0});else{p(),a("未连接（暂无会话）"),t.historyMessages=[],v(),i(!1);const e=document.querySelector("#chat_history_output");e&&(e.textContent="暂无会话可展示")}n||r(`会话列表刷新完成，共 ${h.length} 条`,"ok"),n&&c("")}async function w({sessionKey:n="",silent:s=!1}={}){const a=String(n||t.selectedSessionKey||"").trim();if(!a)throw new Error("请先选择会话");t.selectedSessionKey=a;const i=new URLSearchParams({sessionKey:a,limit:"200"}),o=await e(`/api/chat/history?${i.toString()}`);(function(e={}){const n=document.querySelector("#chat_history_output");if(!n)return;const s=String(e.sessionKey||t.selectedSessionKey||"").trim(),r=String(e.sessionId||"").trim(),a=String(e.thinkingLevel||"").trim(),i=String(e.verboseLevel||"").trim(),o=Array.isArray(e.messages)?e.messages:[],c=[];c.push(`sessionKey: ${s||"-"}`),c.push(`sessionId: ${r||"-"}`),c.push(`thinkingLevel: ${a||"-"}`),c.push(`verboseLevel: ${i||"-"}`),c.push(`messages: ${o.length}`),t.historyMessages=o.map((e,t)=>function(e={},t=0){const n=String(e?.role||e?.author||e?.type||"assistant").trim().toLowerCase()||"assistant",s=String(e?.status||"").trim(),r=String(e?.thinkingState||e?.thinking||e?.reasoning||e?.reasoningEffort||"").trim(),a=f(e?.content??e?.parts??e?.message??e?.delta??e?.text??""),i=Array.isArray(e?._attachedFiles)?e._attachedFiles.map(e=>({fileName:String(e?.fileName||"").trim(),mimeType:String(e?.mimeType||"").trim()||"application/octet-stream",fileSize:Number(e?.fileSize||0)||0,preview:String(e?.preview||"").trim()||""})).filter(e=>e.fileName):[];return{id:`history-${t+1}`,role:n,status:s,thinking:r,body:a||"(空消息)",timestamp:e?.timestamp||e?.createdAt||e?.at||"",attachments:i}}(e,t)),v(),o.forEach((e,t)=>{const n=String(e?.role||e?.author||e?.type||"unknown").trim()||"unknown",s=String(e?.status||"").trim(),r=String(e?.thinkingState||e?.thinking||e?.reasoning||e?.reasoningEffort||"").trim(),a=f(e?.content??e?.parts??e?.message??e?.delta??e?.text??"");c.push(""),c.push(`#${t+1} ${n}${s?` [${s}]`:""}`),r&&c.push(`思考状态: ${r}`),c.push(a||"(empty)")}),n.textContent=c.join("\n")})({...o?.result&&"object"==typeof o.result?o.result:{},sessionKey:a}),s||r(`会话历史刷新完成：${a}`,"ok")}async function E(){const a=String(n("chat_session_select")||t.selectedSessionKey||"").trim(),l=String(n("chat_message_input")||"").trim(),m=Array.isArray(t.attachments)?[...t.attachments]:[];if(!a)throw new Error("请先选择会话");if(!l&&0===m.length)throw new Error("请输入消息或添加至少一个附件");if(t.sending)throw new Error("当前正在生成回复，请稍候或先点击“停止回复”");if(t.staging)throw new Error("附件仍在处理中，请稍候再发送");const u={sessionKey:a,message:l,thinking:String(n("chat_thinking_level")||"").trim(),idempotencyKey:String(n("chat_idempotency_key")||"").trim(),attachments:m.map(e=>({fileName:String(e?.fileName||"").trim()||"file",mimeType:String(e?.mimeType||"").trim()||"application/octet-stream",fileSize:Number(e?.fileSize||0)||0,stagedPath:String(e?.stagedPath||"").trim(),preview:String(e?.preview||"").trim()||""}))};if(u.attachments.some(e=>!e.stagedPath))throw new Error("存在未完成的附件，请重新添加后再发送");const h={id:`local-user-${Date.now()}`,role:"user",status:u.attachments.length>0?`附件 ${u.attachments.length} 个`:"",thinking:"",body:l||"(仅附件)",attachments:u.attachments.map(e=>({fileName:e.fileName,mimeType:e.mimeType,fileSize:e.fileSize,preview:e.preview})).filter(e=>e.fileName)};t.historyMessages.push(h),t.attachments=[],d(),o("支持点击上传、粘贴或拖拽文件（图片会显示预览）"),s("chat_message_input",""),s("chat_file_input",""),t.streamDeltasByRunId={},t.streamThinkingByRunId={},v(),i(!0),$(a,{silent:!0});try{const n=await e("/api/chat/send",{method:"POST",body:JSON.stringify(u)}),a=n?.result&&"object"==typeof n.result?n.result:{};t.lastRunId=String(a.runId||"").trim(),s("chat_last_run_id",t.lastRunId),t.lastRunId||i(!1),r(u.attachments.length>0?`消息和附件已发送（status=${a.status||"unknown"}，附件=${u.attachments.length}）`:`消息已发送（status=${a.status||"unknown"}）`,"ok"),c("消息已发送，正在等待回复...","ok")}catch(e){throw i(!1),t.historyMessages=t.historyMessages.filter(e=>e.id!==h.id),t.attachments=m,d(),v(),e}}function L(){if(t.bound)return;t.bound=!0,a("未连接"),i(!1),d(),o("支持点击上传、粘贴或拖拽文件（图片会显示预览）"),c(""),function(){const e=document.querySelector("#chat_file_input"),n=document.querySelector("#chat_pick_files"),s=document.querySelector("#chat_attachment_list"),r=document.querySelector("#chat_message_input");n?.addEventListener("click",()=>{e?.click()}),e?.addEventListener("change",()=>{const t=Array.from(e.files||[]);0!==t.length&&(h(t).catch(e=>l(e,"附件处理失败")),e.value="")}),s?.addEventListener("click",e=>{const n=e.target;if(!(n instanceof HTMLElement))return;const s=Number.parseInt(String(n.dataset.attachmentIndex||""),10);Number.isInteger(s)&&function(e){Array.isArray(t.attachments)&&(!Number.isInteger(e)||e<0||e>=t.attachments.length||(t.attachments.splice(e,1),d(),o(`已移除附件，当前 ${t.attachments.length} 个`)))}(s)}),[r,s].filter(Boolean).forEach(e=>{e.addEventListener("dragover",e=>{e.preventDefault(),s?.classList.add("is-dragover")}),e.addEventListener("dragleave",()=>{s?.classList.remove("is-dragover")}),e.addEventListener("drop",e=>{e.preventDefault(),s?.classList.remove("is-dragover");const t=Array.from(e.dataTransfer?.files||[]);t.length>0&&h(t).catch(e=>l(e,"附件处理失败"))})}),r?.addEventListener("paste",e=>{const t=Array.from(e.clipboardData?.files||[]);0!==t.length&&(e.preventDefault(),h(t).catch(e=>l(e,"附件处理失败")))})}();const m=document.querySelector("#chat_session_select");m?.addEventListener("change",()=>{const e=String(m.value||"").trim();t.selectedSessionKey=e,i(!1),t.attachments=[],d(),o("支持点击上传、粘贴或拖拽文件（图片会显示预览）"),$(e,{silent:!0,force:!0}),w({sessionKey:e}).catch(e=>r(e.message||String(e),"error"))}),document.querySelector("#chat_new_session")?.addEventListener("click",()=>{(async function(){const t=await e("/api/chat/session/new",{method:"POST",body:JSON.stringify({})}),n=String((t?.result&&"object"==typeof t.result?t.result:{}).key||"").trim();if(!n)throw new Error("新建会话失败：未返回会话 key");await k({silent:!0,preserveSelection:!1,selectedSessionKey:n}),c("新会话创建成功","ok"),r(`已创建新会话：${n}`,"ok")})().catch(e=>l(e,"新建会话失败"))}),document.querySelector("#chat_refresh_sessions")?.addEventListener("click",()=>{k().then(()=>c("会话列表已刷新","ok")).catch(e=>l(e,"刷新会话失败"))}),document.querySelector("#chat_load_history")?.addEventListener("click",()=>{w().then(()=>c("会话历史已刷新","ok")).catch(e=>l(e,"刷新历史失败"))}),document.querySelector("#chat_reconnect_stream")?.addEventListener("click",()=>{$(t.selectedSessionKey,{force:!0}),c("已触发实时通道重连","ok")}),document.querySelector("#chat_send_message")?.addEventListener("click",()=>{E().catch(e=>l(e,"发送失败"))}),document.querySelector("#chat_message_input")?.addEventListener("keydown",e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),E().catch(e=>l(e,"发送失败")))}),document.querySelector("#chat_show_thinking")?.addEventListener("change",()=>{v()}),document.querySelector("#chat_abort_run")?.addEventListener("click",()=>{(async function(){const s=String(n("chat_session_select")||t.selectedSessionKey||"").trim();if(!s)throw new Error("请先选择会话");const a=String(n("chat_last_run_id")||"").trim(),o=await e("/api/chat/abort",{method:"POST",body:JSON.stringify({sessionKey:s,runId:a})}),l=o?.result&&"object"==typeof o.result?o.result:{},m=Array.isArray(l.runIds)?l.runIds:[];i(!1),r(l.aborted?`已发送中止请求，runIds=${m.join(",")||"-"}`:"当前没有可中止的运行任务",l.aborted?"ok":"info"),c(l.aborted?"已发送停止请求":"当前没有可停止的任务",l.aborted?"ok":""),await w({sessionKey:s,silent:!0}).catch(()=>{})})().catch(e=>l(e,"停止失败"))}),document.querySelector("#chat_reset_session")?.addEventListener("click",()=>{(async function(){const a=String(n("chat_session_select")||t.selectedSessionKey||"").trim();if(!a)throw new Error("请先选择会话");await e("/api/chat/session/reset",{method:"POST",body:JSON.stringify({sessionKey:a,reason:"reset"})}),t.lastRunId="",s("chat_last_run_id",""),i(!1),t.streamDeltasByRunId={},t.streamThinkingByRunId={},t.attachments=[],d(),o("支持点击上传、粘贴或拖拽文件（图片会显示预览）"),v(),r(`会话已重置：${a}`,"ok"),c("会话已清空","ok"),await w({sessionKey:a,silent:!0}).catch(()=>{})})().catch(e=>l(e,"重置会话失败"))}),window.addEventListener("beforeunload",()=>{p()})}export{k as loadChatSessions,L as setupChatConsole};