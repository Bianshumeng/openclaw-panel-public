<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenClaw 龙虾控制台</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body data-theme="light">
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">
          <p class="eyebrow">OpenClaw Panel</p>
          <h1>龙虾 Bot 控制台</h1>
          <p class="sub">只暴露业务配置，不暴露服务器端点。</p>
        </div>

        <nav class="tabs sidebar-tabs">
          <a class="tab" data-tab-target="panel-dashboard" href="/dashboard">仪表盘</a>
          <a class="tab is-active" data-tab-target="panel-model" href="/model">模型与提供商配置</a>
          <a class="tab" data-tab-target="panel-config-generator" href="/config-generator">配置生成器</a>
          <a class="tab" data-tab-target="panel-channel" href="/channels">渠道接入</a>
          <a class="tab" data-tab-target="panel-update" href="/update">版本更新</a>
          <a class="tab" data-tab-target="panel-service" href="/service">服务控制</a>
          <a class="tab" data-tab-target="panel-logs" href="/logs">日志排障</a>
        </nav>
      </aside>

      <main class="content">
        <header class="page-header">
          <div>
            <h2 class="page-title">OpenClaw 可视化管理</h2>
            <p class="page-subtitle">面向用户的业务配置界面，默认隐藏服务器基础设施细节。</p>
          </div>
          <button id="theme_toggle" class="btn-soft" type="button">切换到深夜模式</button>
        </header>

        <section class="panel" data-panel="panel-dashboard">
          <article class="card">
            <h2>系统状态</h2>
            <div class="status-chip">
              <span class="dot"></span>
              <span id="runtime_state">面板已连接</span>
            </div>
            <div class="meta">
              <span id="meta_service_name">service: -</span>
              <span id="meta_log_source">log: -</span>
            </div>
          </article>

          <article class="card">
            <h2>模型仪表盘</h2>
            <p class="muted-line">展示当前生效的模型与基础状态信息。</p>
            <div class="grid">
              <label>
                当前使用模型
                <input id="dashboard_current_model" type="text" readonly />
              </label>
              <label>
                当前提供商
                <input id="dashboard_current_provider" type="text" readonly />
              </label>
              <label>
                当前模型上下文上限
                <input id="dashboard_current_context_window" type="text" readonly />
              </label>
              <label>
                当前模型思考强度
                <input id="dashboard_current_thinking_strength" type="text" readonly />
              </label>
            </div>
          </article>
        </section>

        <section class="panel is-visible" data-panel="panel-model">
          <article class="card">
            <h2>设置当前默认模型</h2>
            <p class="muted-line">先选“当前默认使用的模型”，再保存。这个操作只改默认模型指向，不会删除其它模型。</p>
            <div class="grid">
              <label>
                当前默认模型
                <select id="model_default_ref"></select>
              </label>
              <label>
                主模型引用
                <input id="model_current_primary" type="text" readonly />
              </label>
              <label>
                提供商标识
                <input id="model_current_provider" type="text" readonly />
              </label>
              <label>
                API 模式
                <input id="model_current_api" type="text" readonly />
              </label>
              <label>
                API 地址
                <input id="model_current_baseurl" type="text" readonly />
              </label>
              <label>
                模型 ID
                <input id="model_current_id" type="text" readonly />
              </label>
              <label>
                模型名称
                <input id="model_current_name" type="text" readonly />
              </label>
              <label>
                上下文长度
                <input id="model_current_context_window" type="text" readonly />
              </label>
              <label>
                最大输出长度
                <input id="model_current_max_tokens" type="text" readonly />
              </label>
            </div>
            <div class="actions">
              <button id="save_default_model">保存默认模型</button>
            </div>
          </article>

          <article class="card">
            <h2>可用模型（按提供商）</h2>
            <p class="muted-line">在这里直接按提供商查看并切换模型。切换前建议填写当前会话上下文，系统会在可能超限时提醒你。</p>
            <div class="grid">
              <label>
                当前会话上下文（Token）
                <input
                  id="dashboard_context_tokens"
                  type="number"
                  min="0"
                  step="1"
                  placeholder="用于切换时上下文超限提示"
                />
              </label>
            </div>
            <p id="dashboard_context_hint" class="muted-line">当目标模型上下文更短，且当前会话上下文超过目标上限时，将弹出风险提示。</p>
            <div id="model_provider_cards" class="provider-grid"></div>
          </article>

          <article class="card">
            <h2>添加新提供商（基础配置）</h2>
            <p class="muted-line">选模板后只改“提供商名称 / URL / Key”就能直接用，适合小白快速上手。</p>
            <div class="grid">
              <label>
                模板类型
                <select id="model_template_key">
                  <option value="aicodecat-gpt">GPT 系列模板</option>
                  <option value="aicodecat-claude">Claude 系列模板</option>
                  <option value="aicodecat-gemini">Gemini 系列模板</option>
                </select>
              </label>
              <label>
                提供商名称（provider key）
                <input id="template_provider_id" type="text" />
              </label>
              <label>
                API 模式
                <div class="field-stack">
                  <select id="template_api">
                    <option value="openai-responses">openai-responses（GPT Responses）</option>
                    <option value="openai-completions">openai-completions（GPT 兼容）</option>
                    <option value="anthropic-messages">anthropic-messages（Claude）</option>
                    <option value="google-generative-ai">google-generative-ai（Gemini）</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input id="template_api_custom" class="custom-field" type="text" placeholder="输入自定义 API 模式" />
                </div>
              </label>
              <label>
                API 地址（Base URL）
                <input id="template_base_url" type="url" />
              </label>
              <label>
                API Key
                <input id="template_api_key" type="password" autocomplete="off" />
              </label>
              <label>
                设为默认模型
                <select id="template_default_model_id"></select>
              </label>
            </div>
            <label>
              模板内置模型（可直接用）
              <pre id="template_model_preview" class="output"></pre>
            </label>
            <div class="actions">
              <button id="save_provider_template">保存模板提供商</button>
            </div>
          </article>

          <article class="card">
            <h2>自定义模式（高级）</h2>
            <p class="muted-line">需要完全自定义时，直接编辑模型 JSON 数组。每个模型至少要有 id 和 name。</p>
            <div class="grid">
              <label>
                提供商名称（provider key）
                <input id="custom_provider_id" type="text" placeholder="例如 my-provider" />
              </label>
              <label>
                API 模式
                <input id="custom_api" type="text" placeholder="例如 openai-responses" />
              </label>
              <label>
                API 地址（Base URL）
                <input id="custom_base_url" type="url" placeholder="例如 https://api.example.com/v1" />
              </label>
              <label>
                API Key
                <input id="custom_api_key" type="password" autocomplete="off" />
              </label>
              <label>
                默认模型 ID
                <input id="custom_default_model_id" type="text" placeholder="填 models 数组中的某个 id" />
              </label>
            </div>
            <label>
              models 数组 JSON
              <textarea id="custom_models_json" rows="10" placeholder='[{"id":"model-id","name":"模型名","reasoning":true,"input":["text","image"],"contextWindow":200000,"maxTokens":64000}]'></textarea>
            </label>
            <div class="actions">
              <button id="save_provider_custom">保存自定义提供商</button>
            </div>
          </article>
        </section>

        <section class="panel" data-panel="panel-config-generator">
          <article class="card">
            <h2>OpenClaw 配置生成器</h2>
            <p class="muted-line">
              根据你输入的原始 OpenClaw JSON 自动生成 `models.providers.*` 与
              `agents.defaults.model.primary`。
            </p>

            <div class="grid">
              <label>
                提供商
                <div class="field-stack">
                  <select id="cfg_provider">
                    <option value="aicodecat">aicodecat</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input id="cfg_provider_custom" class="custom-field" type="text" placeholder="输入自定义提供商 ID" />
                </div>
              </label>

              <label>
                API 模式
                <div class="field-stack">
                  <select id="cfg_apimode">
                    <option value="anthropic-messages">anthropic-messages（Claude）</option>
                    <option value="openai-responses" selected>openai-responses（GPT）</option>
                    <option value="openai-completions">openai-completions（GPT 兼容）</option>
                    <option value="google-generative-ai">google-generative-ai（Gemini）</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input id="cfg_apimode_custom" class="custom-field" type="text" placeholder="输入自定义 API 模式" />
                </div>
              </label>
            </div>

            <div class="grid">
              <label>
                Base URL
                <div class="field-stack">
                  <select id="cfg_baseurl">
                    <option value="https://aicode.cat/v1" selected>https://aicode.cat/v1 (GPT)</option>
                    <option value="https://aicode.cat">https://aicode.cat (Claude)</option>
                    <option value="https://aicode.cat/v1beta">https://aicode.cat/v1beta (Gemini)</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input id="cfg_baseurl_custom" class="custom-field" type="url" placeholder="输入自定义 Base URL" />
                </div>
              </label>

              <label>
                模型 ID
                <div class="field-stack">
                  <select id="cfg_model_id">
                    <option value="gpt-5.2" selected>gpt-5.2</option>
                    <option value="gpt-5.2-codex">gpt-5.2-codex</option>
                    <option value="gpt-5.3-codex">gpt-5.3-codex</option>
                    <option value="claude-opus-4-6">claude-opus-4-6</option>
                    <option value="claude-sonnet-4-5-20250929">claude-sonnet-4-5-20250929</option>
                    <option value="claude-haiku-4-5">claude-haiku-4-5</option>
                    <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
                    <option value="gemini-3-flash-preview">gemini-3-flash-preview</option>
                    <option value="custom">自定义</option>
                  </select>
                  <input id="cfg_model_id_custom" class="custom-field" type="text" placeholder="输入自定义模型 ID" />
                </div>
              </label>
            </div>

            <div class="grid">
              <label>
                API Key
                <input id="cfg_apikey" type="password" autocomplete="off" placeholder="输入 API Key" />
              </label>
              <label>
                是否继承当前环境下的其他配置内容
                <select id="cfg_inherit_existing">
                  <option value="false" selected>否（只生成当前页面配置）</option>
                  <option value="true">是（保留当前配置中的其他字段）</option>
                </select>
              </label>
              <label>
                状态
                <input id="cfg_status" type="text" value="就绪" readonly />
              </label>
            </div>

            <label>
              Config（原始 JSON）
              <textarea id="cfg_input" rows="8" placeholder="粘贴你的 ~/.openclaw/openclaw.json"></textarea>
            </label>

            <div class="actions">
              <button id="cfg_generate" type="button">生成配置</button>
              <button id="cfg_copy" class="btn-soft" type="button">复制结果</button>
            </div>

            <label>
              转换结果
              <pre id="cfg_output" class="output">响应将显示在这里</pre>
            </label>
          </article>
        </section>

        <section class="panel" data-panel="panel-channel">
          <article class="card">
            <h2>渠道配置保存</h2>
            <p class="muted-line">修改完 Telegram / Feishu / Discord / Slack 配置后，统一点一次保存。</p>
            <div class="actions">
              <button id="save_settings">保存渠道与全局配置</button>
            </div>
          </article>

          <article class="card">
            <h2>Telegram（官方字段）</h2>
            <p class="muted-line">对应 `channels.telegram.*`，默认建议 DM 策略用 `pairing`。</p>
            <div class="grid">
              <label class="inline-check">
                启用 Telegram
                <input id="tg_enabled" type="checkbox" />
              </label>
              <label>
                Bot Token
                <input id="tg_bot_token" type="password" autocomplete="off" />
              </label>
              <label>
                DM Policy
                <select id="tg_dm_policy">
                  <option value="pairing">pairing</option>
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label>
                Group Policy
                <select id="tg_group_policy">
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label>
                Stream Mode
                <select id="tg_stream_mode">
                  <option value="partial">partial</option>
                  <option value="block">block</option>
                  <option value="off">off</option>
                </select>
              </label>
              <label class="inline-check">
                群消息需 @ 机器人（groups["*"].requireMention）
                <input id="tg_require_mention" type="checkbox" />
              </label>
            </div>
            <div class="grid">
              <label>
                allowFrom（每行一个，`open` 模式必须包含 `*`）
                <textarea id="tg_allow_from" rows="4"></textarea>
              </label>
              <label>
                groupAllowFrom（每行一个）
                <textarea id="tg_group_allow_from" rows="4"></textarea>
              </label>
            </div>
            <div class="actions">
              <button id="test_telegram" class="btn-soft">测试 Telegram</button>
            </div>
          </article>

          <article class="card">
            <h2>Feishu（插件字段）</h2>
            <p class="muted-line">对应 `channels.feishu.*`，兼容 `accounts.main`。</p>
            <div class="grid">
              <label class="inline-check">
                启用 Feishu
                <input id="fs_enabled" type="checkbox" />
              </label>
              <label>
                App ID
                <input id="fs_app_id" type="text" />
              </label>
              <label>
                App Secret
                <input id="fs_app_secret" type="password" autocomplete="off" />
              </label>
              <label>
                Domain
                <select id="fs_domain">
                  <option value="feishu">feishu</option>
                  <option value="lark">lark</option>
                </select>
              </label>
              <label>
                Connection Mode
                <select id="fs_connection_mode">
                  <option value="websocket">websocket</option>
                  <option value="webhook">webhook</option>
                </select>
              </label>
              <label>
                DM Policy
                <select id="fs_dm_policy">
                  <option value="pairing">pairing</option>
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                </select>
              </label>
              <label>
                Group Policy
                <select id="fs_group_policy">
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label class="inline-check">
                群消息需 @ 机器人（requireMention）
                <input id="fs_require_mention" type="checkbox" />
              </label>
            </div>
            <div class="grid">
              <label>
                allowFrom（每行一个，`open` 模式必须包含 `*`）
                <textarea id="fs_allow_from" rows="4"></textarea>
              </label>
              <label>
                groupAllowFrom（每行一个）
                <textarea id="fs_group_allow_from" rows="4"></textarea>
              </label>
            </div>
            <div class="actions">
              <button id="test_feishu" class="btn-soft">测试 Feishu</button>
            </div>
          </article>

          <article class="card">
            <h2>Discord（官方字段）</h2>
            <p class="muted-line">
              对应 `channels.discord.*`，`requireMention` 映射到 `channels.discord.guilds["*"].requireMention`。
            </p>
            <div class="grid">
              <label class="inline-check">
                启用 Discord
                <input id="dc_enabled" type="checkbox" />
              </label>
              <label>
                Bot Token
                <input id="dc_token" type="password" autocomplete="off" />
              </label>
              <label>
                DM Policy
                <select id="dc_dm_policy">
                  <option value="pairing">pairing</option>
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label>
                Group Policy
                <select id="dc_group_policy">
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label class="inline-check">
                允许 Bot 消息触发（allowBots）
                <input id="dc_allow_bots" type="checkbox" />
              </label>
              <label class="inline-check">
                群消息需 @ 机器人（guilds["*"].requireMention）
                <input id="dc_require_mention" type="checkbox" />
              </label>
            </div>
            <div class="grid">
              <label>
                allowFrom（每行一个，`open` 模式必须包含 `*`）
                <textarea id="dc_allow_from" rows="4"></textarea>
              </label>
            </div>
            <div class="actions">
              <button id="test_discord" class="btn-soft">测试 Discord</button>
            </div>
          </article>

          <article class="card">
            <h2>Slack（官方字段）</h2>
            <p class="muted-line">对应 `channels.slack.*`，支持 socket/http 两种模式。</p>
            <div class="grid">
              <label class="inline-check">
                启用 Slack
                <input id="sl_enabled" type="checkbox" />
              </label>
              <label>
                连接模式
                <select id="sl_mode">
                  <option value="socket">socket</option>
                  <option value="http">http</option>
                </select>
              </label>
              <label>
                Bot Token（xoxb-...）
                <input id="sl_bot_token" type="password" autocomplete="off" />
              </label>
              <label>
                App Token（xapp-...，socket 模式常用）
                <input id="sl_app_token" type="password" autocomplete="off" />
              </label>
              <label>
                Signing Secret（http 模式必填）
                <input id="sl_signing_secret" type="password" autocomplete="off" />
              </label>
              <label>
                DM Policy
                <select id="sl_dm_policy">
                  <option value="pairing">pairing</option>
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label>
                Group Policy
                <select id="sl_group_policy">
                  <option value="allowlist">allowlist</option>
                  <option value="open">open</option>
                  <option value="disabled">disabled</option>
                </select>
              </label>
              <label class="inline-check">
                允许 Bot 消息触发（allowBots）
                <input id="sl_allow_bots" type="checkbox" />
              </label>
              <label class="inline-check">
                群消息需 @ 机器人（requireMention）
                <input id="sl_require_mention" type="checkbox" />
              </label>
            </div>
            <div class="grid">
              <label>
                allowFrom（每行一个，`open` 模式必须包含 `*`）
                <textarea id="sl_allow_from" rows="4"></textarea>
              </label>
            </div>
            <div class="actions">
              <button id="test_slack" class="btn-soft">测试 Slack</button>
            </div>
          </article>
        </section>

        <section class="panel" data-panel="panel-update">
          <article class="card">
            <h2>OpenClaw 版本更新</h2>
            <p class="muted-line">支持检查上游最新版本，并在失败时自动回滚。</p>

            <div class="status-row">
              <span class="pill" id="update_state">未检查</span>
              <span class="muted-line" id="update_hint">建议先点“检查更新”，再执行升级。</span>
            </div>

            <div class="grid">
              <label>
                当前版本
                <input id="update_current_tag" type="text" readonly />
              </label>
              <label>
                最新版本
                <input id="update_latest_tag" type="text" readonly />
              </label>
              <label>
                目标版本（支持 v 前缀）
                <input id="update_target_tag" type="text" placeholder="例如 v2026.2.14" />
              </label>
            </div>

            <div class="actions">
              <button id="check_update">检查更新</button>
              <button id="upgrade_update">升级到目标版本</button>
              <button id="rollback_update" class="btn-soft">回滚到目标版本</button>
            </div>
          </article>
        </section>

        <section class="panel" data-panel="panel-service">
          <article class="card">
            <h2>服务控制（当前运行时）</h2>
            <div class="status-row">
              <span class="pill" id="service_state">未知</span>
              <span class="muted-line" id="service_hint">建议先点“状态”确认服务可达。</span>
            </div>
            <div class="actions">
              <button data-action="status">状态</button>
              <button data-action="start">启动</button>
              <button data-action="stop">停止</button>
              <button data-action="restart">重启</button>
            </div>
            <pre id="service_output" class="output"></pre>
          </article>
        </section>

        <section class="panel" data-panel="panel-logs">
          <article class="card">
            <h2>日志排障</h2>
            <div class="actions">
              <label class="filter">
                关键字过滤
                <input id="log_filter" type="text" placeholder="error / timeout / token ..." />
              </label>
              <button id="load_tail">加载最近日志</button>
              <button id="start_stream">启动实时流</button>
              <button id="stop_stream" class="btn-soft">停止实时流</button>
              <button id="load_errors" class="btn-soft">最近错误摘要</button>
            </div>
            <pre id="log_output" class="output"></pre>
            <ul id="error_summary" class="error-list"></ul>
          </article>
        </section>

        <section class="card">
          <h2>操作时间线</h2>
          <p class="muted-line">每次点击后的结果都会记录在这里，方便你定位问题。</p>
          <pre id="messages" class="output"></pre>
        </section>
      </main>
    </div>

    <script type="module" src="/app.js"></script>
  </body>
</html>
